
<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nagori Adda - Community App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        .tab-active {
            border-bottom: 3px solid #2563eb;
            color: #2563eb;
        }
        .chat-list-item:hover {
            background-color: #f3f4f6;
        }
        
        /* User Management Table Styles */
        .user-table-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .user-table thead {
            background: linear-gradient(to right, #7c3aed, #a855f7);
            color: white;
        }
        
        .user-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .user-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }
        
        .user-table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .user-table tbody tr.admin-row {
            background-color: #faf5ff;
        }
        
        .user-table td {
            padding: 12px 16px;
            font-size: 14px;
        }
        
        .badge-admin {
            background: linear-gradient(to right, #7c3aed, #a855f7);
            color: white;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-member {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-verified {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-unverified {
            background: #f59e0b;
            color: white;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-blocked {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Avatar Circle for User Management */
        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-right: 4px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-btn-verify {
            background: #10b981;
            color: white;
        }
        
        .action-btn-block {
            background: #ef4444;
            color: white;
        }
        
        .action-btn-unblock {
            background: #3b82f6;
            color: white;
        }
        
        .action-btn-unverify {
            background: #f59e0b;
            color: white;
        }
        
        /* CSS Avatar Circle Styles */
        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        
        /* Family Tree Styles */
        .family-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            min-height: 70vh;
        }
        
        .tree-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 80px;
        }
        
        .tree-generation {
            position: relative;
            display: flex;
            justify-content: center;
        }
        
        .generation-row {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            position: relative;
        }
        
        .tree-node {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* SVG lines will handle all connections now */
        
        .member-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 140px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .member-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .member-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            position: relative;
        }
        
        .member-avatar.male {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .member-avatar.female {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .member-avatar.default {
            background: linear-gradient(135deg, #93c5fd 0%, #a8edea 100%);
        }
        
        .member-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .add-icon {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f59e0b;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid white;
        }
        
        .member-name {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .member-year {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .relation-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
        }
        
        .relation-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .relation-card:hover {
            background: #f3f4f6;
            transform: scale(1.05);
        }
        
        .relation-card.selected {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        .relation-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 40px;
        }
        
        .relation-icon.male {
            background: #93c5fd;
        }
        
        .relation-icon.female {
            background: #fbcfe8;
        }
        
        /* Toolbar Styles */
        .tree-toolbar {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }
        
        .toolbar-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
        }
        
        .toolbar-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background: #f97316;
            color: white;
            border-color: #f97316;
        }
        
        @media print {
            .tree-toolbar, .back-button, .search-bar, .no-print {
                display: none !important;
            }
            body {
                background: white !important;
            }
        }
        
        @media (max-width: 768px) {
            .relation-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .tree-toolbar {
                right: 10px;
                gap: 8px;
            }
            .toolbar-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
        }
        
        /* Marriage Badge Styles */
        .marriage-badge {
            margin-top: 8px;
            padding: 8px;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
            border: 2px dashed #ff6b9d;
            border-radius: 8px;
            font-size: 11px;
        }
        
        .marriage-badge-expanded {
            padding: 8px;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
            border: 2px dashed #ff6b9d;
            border-radius: 8px;
            font-size: 11px;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .marriage-icon {
            font-size: 20px;
            text-align: center;
            margin-bottom: 4px;
        }
        
        .marriage-info {
            text-align: center;
        }
        
        .married-to {
            font-weight: 600;
            color: #d63384;
            margin-bottom: 2px;
        }
        
        .spouse-cast {
            color: #0d6efd;
            font-weight: 500;
            margin: 2px 0;
        }
        
        .spouse-name {
            color: #198754;
            margin: 4px 0;
        }
        
        .view-family-btn {
            margin-top: 6px;
            padding: 4px 12px;
            background: #0d6efd;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }
        
        .view-family-btn:hover {
            background: #0a58ca;
        }
        
        /* Highlight animation */
        @keyframes flash-highlight {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 193, 7, 0.8); }
        }
        
        .highlight-flash {
            animation: flash-highlight 1s ease-in-out 2;
        }
        
        /* Navigation breadcrumb */
        .breadcrumb {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .breadcrumb button {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .breadcrumb button:hover {
            background: #ffca2c;
        }
        
        .current-view {
            font-weight: 600;
            color: #856404;
        }
        
        /* WhatsApp Chat Styles */
        .whatsapp-bg {
            background-color: #111b21;
        }
        
        .whatsapp-green {
            background-color: #00a884;
        }
        
        .whatsapp-dark {
            background-color: #202c33;
        }
        
        .whatsapp-light {
            background-color: #2a3942;
        }
        
        .chat-bubble-sent {
            background-color: #005c4b;
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        
        .chat-bubble-received {
            background-color: #202c33;
            color: black;
            border-radius: 18px 18px 18px 4px;
        }
        
        .message-text {
            color: inherit;
            font-weight: 500;
        }
        
        .chat-bubble-sent .message-text {
            color: white;
        }
        
        .chat-bubble-received .message-text {
            color: black;
        }
        
        .status-ring {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00a884, #25d366);
            padding: 3px;
        }
        
        .status-ring-gray {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #54656f, #8696a0);
            padding: 3px;
        }
        
        .status-ring img,
        .status-ring-gray img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .status-ring::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: #00a884;
            border-radius: 50%;
            border: 3px solid #111b21;
        }
        
        .chat-item:hover {
            background-color: #2a3942;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
        }
        
        .unread-badge {
            background-color: #00a884;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #8696a0;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        .message-actions {
            position: absolute;
            top: -40px;
            right: 0;
            background: #2a3942;
            border-radius: 8px;
            padding: 8px;
            display: none;
            z-index: 10;
        }
        
        .message-bubble:hover .message-actions {
            display: flex;
            gap: 8px;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #00a884;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        
        .media-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .reply-preview {
            background: #2a3942;
            border-left: 4px solid #00a884;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .status-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 2000;
            display: none;
        }
        
        .status-progress {
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .status-progress-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: statusProgress 5s linear;
        }
        
        @keyframes statusProgress {
            from { width: 0%; }
            to { width: 100%; }
        }
    </style>
    
    <script>
        // Firebase Configuration - Real Production Config (Secured)
        const firebaseConfig = {
            apiKey: "AIzaSyC6lpwqCbnt9rqJ9RiGTMIspEuDdK74PgQ",
            authDomain: "nagoriadda.firebaseapp.com",
            projectId: "nagoriadda",
            storageBucket: "nagoriadda.firebasestorage.app",
            messagingSenderId: "78072362888",
            appId: "1:78072362888:web:d916c9c75e864373136c3d",
            measurementId: "G-EW0VY1E3JC"
        };
        
        // Initialize Firebase
        let firebaseApp, db, auth, storage;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
            console.log('✅ Firebase initialized successfully');
        } catch (error) {
            console.warn('⚠️ Firebase initialization error (using localStorage fallback):', error.message);
            db = null; // Will use localStorage fallback
        }
        
        // Constants
        const ADMIN_MOBILE = '9352525595';
        // Strong password: Nagori@Adda#2025!Ali (SHA-256 hash)
        const ADMIN_PASSWORD_HASH = '19a581762ad60b5e7c7b5b7d2f9d02aabc589e89d1a4989b6c60728fa0ad7025';
        
        // OTP Service Configuration
        const OTP_CONFIG = {
            // Firebase Phone Authentication (Primary - FREE!)
            USE_FIREBASE_PHONE_AUTH: true, // Set to true to use Firebase (Recommended)
            
            // OTP Settings
            OTP_LENGTH: 6,
            OTP_EXPIRY_MINUTES: 5,
            MAX_OTP_ATTEMPTS: 3,
            
            // Fallback to demo mode if needed
            DEMO_MODE: false // Set to true for testing without real SMS
        };
        
        // Firebase Phone Auth Variables
        let recaptchaVerifier = null;
        let confirmationResult = null;
        
        // Cloudflare R2 Configuration for Media Storage
        const R2_CONFIG = {
            WORKER_URL: 'https://r2-presig.theskynetcafe.workers.dev',
            PUBLIC_BASE_URL: 'https://pub-723c7220303d4232abe7c10c57884f88.r2.dev',
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            ALLOWED_TYPES: {
                image: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
                video: ['video/mp4', 'video/webm']
            }
        };
        
        const STORAGE_KEYS = {
            USERS: 'nagori_adda_users',
            MESSAGES: 'nagori_adda_messages',
            CASTS: 'nagori_adda_casts',
            FAMILY_MEMBERS: 'nagori_adda_family_members',
            CURRENT_USER: 'nagori_adda_current_user',
            COMMUNITIES: 'nagori_adda_communities'
        };

        let currentUser = null;
        let isAdminMode = false;
        let selectedRelationType = null;
        let selectedMemberForRelative = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Clean duplicate users on startup (keep only admin)
            const cleanedCount = await cleanDuplicateUsers();
            if (cleanedCount >= 0) {
                console.log(`🧹 Cleanup complete. Active users: ${cleanedCount}`);
            }
            
            initializeSampleData();
            
            const savedUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.status === 'blocked') {
                    alert('आपका account block है।');
                    handleLogout();
                    return;
                }
                showDashboard();
            } else {
                showLoginScreen();
            }
            
            setupEventListeners();
        }

        function initializeSampleData() {
            let casts = getAllCasts();
            if (casts.length === 0) {
                casts.push({
                    castId: 'cast_' + Date.now(),
                    castName: 'Lamba',
                    subCasts: [{ subCastId: 'subcast_' + Date.now(), subCastName: 'Angas wala' }]
                });
                localStorage.setItem(STORAGE_KEYS.CASTS, JSON.stringify(casts));
            }
            
            let communities = getAllCommunities();
            if (communities.length === 0) {
                communities.push({
                    communityId: 'comm_' + Date.now(),
                    name: 'Nagori Adda Community',
                    description: 'Main community group',
                    members: 0
                });
                localStorage.setItem(STORAGE_KEYS.COMMUNITIES, JSON.stringify(communities));
            }
        }

        function setupEventListeners() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            
            const profileForm = document.getElementById('profile-form');
            if (profileForm) profileForm.addEventListener('submit', handleProfileSetup);
            
            const chatBtn = document.getElementById('dashboard-chat-btn');
            if (chatBtn) chatBtn.addEventListener('click', () => showChatScreen());
            
            const familyTreeBtn = document.getElementById('dashboard-familytree-btn');
            if (familyTreeBtn) familyTreeBtn.addEventListener('click', () => showFamilyTreeScreen());
            
            const adminModeBtn = document.getElementById('admin-mode-btn');
            if (adminModeBtn) adminModeBtn.addEventListener('click', enterAdminMode);
            
            const logoutBtn = document.getElementById('logout-button');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            
            const mobileInput = document.getElementById('login-mobile');
            if (mobileInput) {
                mobileInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '').substring(0, 10);
                });
            }
            
            const otpInput = document.getElementById('login-otp');
            if (otpInput) {
                otpInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '').substring(0, 6);
                });
            }
            
            const castSelect = document.getElementById('profile-cast');
            if (castSelect) castSelect.addEventListener('change', updateSubCastOptions);
        }

        // Screen Navigation
        function showScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('[id$="-screen"]').forEach(s => s.classList.add('hidden'));
            
            // Hide WhatsApp chat container
            const whatsappContainer = document.getElementById('whatsapp-chat-container');
            if (whatsappContainer) {
                whatsappContainer.classList.add('hidden');
                whatsappContainer.classList.remove('flex');
            }
            
            // Show requested screen
            const screen = document.getElementById(screenName + '-screen');
            if (screen) screen.classList.remove('hidden');
        }

        function showLoginScreen() {
            showScreen('login');
        }

        function showProfileScreen() {
            showScreen('profile');
            loadCastOptions();
        }

        function showDashboard() {
            // Hide all screens
            document.querySelectorAll('[id$="-screen"]').forEach(s => s.classList.add('hidden'));
            
            // Hide WhatsApp chat
            const whatsappContainer = document.getElementById('whatsapp-chat-container');
            if (whatsappContainer) {
                whatsappContainer.classList.add('hidden');
                whatsappContainer.classList.remove('flex');
            }
            
            // Show dashboard
            const dashboard = document.getElementById('dashboard-screen');
            if (dashboard) dashboard.classList.remove('hidden');
            
            if (currentUser) {
                document.getElementById('dashboard-user-name').textContent = currentUser.displayName || 'User';
                document.getElementById('dashboard-user-email').textContent = currentUser.email || '';
                document.getElementById('dashboard-status-badge').textContent = getStatusText(currentUser.status);
                document.getElementById('dashboard-status-badge').className = 'px-3 py-1 rounded-full text-sm ' + getStatusColor(currentUser.status);
                
                const adminModeBtn = document.getElementById('admin-mode-btn');
                if (currentUser.isAdmin) {
                    adminModeBtn.classList.remove('hidden');
                } else {
                    adminModeBtn.classList.add('hidden');
                }
            }
            isAdminMode = false;
        }

        function showChatScreen() {
            // Hide all screens
            document.querySelectorAll('[id$="-screen"]').forEach(s => s.classList.add('hidden'));
            
            // Show WhatsApp chat container
            const whatsappContainer = document.getElementById('whatsapp-chat-container');
            whatsappContainer.classList.remove('hidden');
            whatsappContainer.classList.add('flex');
            
            // Load WhatsApp chat content
            loadWhatsAppChat();
        }

        function showFamilyTreeScreen() {
            showScreen('familytree');
            
            // One-time cleanup: Remove member codes from female members
            const cleanupDone = localStorage.getItem('femaleCodeCleanupDone');
            if (!cleanupDone) {
                const count = cleanupFemaleMemberCodes();
                if (count > 0) {
                    console.log(`🧹 Cleaned ${count} female member codes`);
                }
                localStorage.setItem('femaleCodeCleanupDone', 'true');
            }
            
            // One-time: Assign codes to male members who don't have them
            const migrationFlag = localStorage.getItem('memberCodesMigrated');
            if (!migrationFlag) {
                const count = assignMissingMemberCodes();
                if (count > 0) {
                    alert(`✅ ${count} male members को codes assign किए गए!`);
                }
                localStorage.setItem('memberCodesMigrated', 'true');
            }
            
            // Clean invalid/orphaned members first
            const cleaned = validateAndCleanMembers();
            if (cleaned) {
                console.log('⚠️ Some members were removed during validation');
            }
            
            loadTreeCastFilters();
            animateMemberCounter();
            renderFamilyTree();
        }
        
        function animateMemberCounter() {
            const counter = document.getElementById('member-counter');
            if (!counter) return;
            
            const allMembers = getAllFamilyMembers();
            const totalMembers = allMembers.length;
            
            console.log('=== Member Counter Debug ===');
            console.log('Total members in LocalStorage:', totalMembers);
            console.log('All members:', allMembers);
            
            // Group by sub-cast
            const byCast = {};
            allMembers.forEach(m => {
                const key = `${m.cast || 'Unknown'} - ${m.subCast || 'Unknown'}`;
                byCast[key] = (byCast[key] || 0) + 1;
            });
            console.log('Members by Cast/Sub-cast:', byCast);
            console.log('===========================');
            
            const duration = 2000; // 2 seconds
            const steps = 50;
            const increment = totalMembers / steps;
            let current = 0;
            
            const interval = setInterval(() => {
                current += increment;
                if (current >= totalMembers) {
                    current = totalMembers;
                    clearInterval(interval);
                }
                counter.textContent = String(Math.floor(current)).padStart(7, '0');
            }, duration / steps);
        }
        
        function loadTreeCastFilters() {
            const castSelect = document.getElementById('tree-cast-filter');
            const subCastSelect = document.getElementById('tree-subcast-filter');
            
            if (!castSelect || !subCastSelect) return;
            
            const casts = getAllCasts();
            
            // Populate cast dropdown
            castSelect.innerHTML = '<option value="">All Casts</option>';
            casts.forEach(cast => {
                const option = document.createElement('option');
                option.value = cast.castName;
                option.textContent = cast.castName;
                if (currentUser.cast === cast.castName) {
                    option.selected = true;
                }
                castSelect.appendChild(option);
            });
            
            // Set sub-cast based on current user's cast
            updateTreeSubCastFilter();
        }
        
        function updateTreeSubCastFilter() {
            const castSelect = document.getElementById('tree-cast-filter');
            const subCastSelect = document.getElementById('tree-subcast-filter');
            
            if (!castSelect || !subCastSelect) return;
            
            const selectedCast = castSelect.value;
            subCastSelect.innerHTML = '<option value="">All Sub-casts</option>';
            
            if (!selectedCast) {
                renderFamilyTree();
                return;
            }
            
            const casts = getAllCasts();
            const cast = casts.find(c => c.castName === selectedCast);
            
            if (cast && cast.subCasts) {
                cast.subCasts.forEach(sc => {
                    const option = document.createElement('option');
                    option.value = sc.subCastName;
                    option.textContent = sc.subCastName;
                    if (currentUser.subCast === sc.subCastName) {
                        option.selected = true;
                    }
                    subCastSelect.appendChild(option);
                });
            }
            
            renderFamilyTree();
        }

        function enterAdminMode() {
            if (!currentUser || !currentUser.isAdmin) {
                alert('Admin access नहीं है');
                return;
            }
            isAdminMode = true;
            showScreen('admin');
            showAdminTab('casts');
        }

        function exitAdminMode() {
            isAdminMode = false;
            showDashboard();
        }

        // Authentication
        async function handleLogin(e) {
            console.log('🔐 Login attempt started');
            e.preventDefault();
            const mobile = document.getElementById('login-mobile').value.trim();
            const password = document.getElementById('login-password').value;

            console.log('📱 Mobile:', mobile);

            if (mobile.length !== 10) {
                alert('❌ 10 अंकों का mobile number चाहिए');
                return;
            }

            if (!password) {
                alert('❌ Password enter करें');
                return;
            }

            // Show loading state
            const loginBtn = e.target.querySelector('button[type="submit"]');
            if (!loginBtn) {
                console.error('❌ Login button not found!');
                return;
            }
            
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '🔄 Verifying...';
            loginBtn.disabled = true;
            
            console.log('🔄 Button state updated, processing login...');

            // Check if admin
            if (mobile === ADMIN_MOBILE) {
                // Admin login - check admin password
                hashPassword(password).then(hash => {
                    if (hash !== ADMIN_PASSWORD_HASH) {
                        loginBtn.innerHTML = originalText;
                        loginBtn.disabled = false;
                        alert('❌ गलत Admin Password!');
                        return;
                    }
                    
                    // Admin password correct
                    proceedWithLogin(mobile);
                }).catch(error => {
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    console.error('Password hashing error:', error);
                    alert('❌ Login error. Please try again.');
                });
            } else {
                // Regular user login - check in database
                const users = await getAllUsers();
                const user = users.find(u => u.mobileNumber === mobile);
                
                if (!user) {
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    alert('❌ यह mobile number registered नहीं है!\nपहले Register करें।');
                    return;
                }
                
                // Check user status
                if (user.status === 'blocked') {
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    alert('❌ आपका account blocked है।\nAdmin से संपर्क करें।');
                    return;
                }
                
                if (user.status === 'pending') {
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    showWaitingScreen();
                    return;
                }
                
                // Verify password
                hashPassword(password).then(hash => {
                    if (hash !== user.passwordHash) {
                        loginBtn.innerHTML = originalText;
                        loginBtn.disabled = false;
                        alert('❌ गलत Password!');
                        return;
                    }
                    
                    // Password correct - login successful
                    console.log('✅ User login successful:', user.firstName);
                    proceedWithLogin(mobile);
                }).catch(error => {
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    console.error('Password hashing error:', error);
                    alert('❌ Login error. Please try again.');
                });
            }
        }
        
        async function proceedWithLogin(mobile) {

            const users = await getAllUsers();
            const existingUser = users.find(u => u.mobileNumber === mobile);

            if (existingUser) {
                if (existingUser.status === 'blocked') {
                    alert('Account blocked है');
                    return;
                }
                currentUser = existingUser;
                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                showDashboard();
            } else {
                currentUser = {
                    userId: 'user_' + Date.now(),
                    mobileNumber: mobile,
                    isAdmin: mobile === ADMIN_MOBILE,
                    status: 'unverified',
                    createdAt: new Date().toISOString()
                };
                showProfileScreen();
            }
        }

        function handleProfileSetup(e) {
            e.preventDefault();
            
            const displayName = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const profilePhoto = document.getElementById('profile-photo').value.trim();
            const age = document.getElementById('profile-age').value.trim();
            const bloodGroup = document.getElementById('profile-blood-group').value;
            const cast = document.getElementById('profile-cast').value;
            const subCast = document.getElementById('profile-sub-cast').value;
            const professional = document.getElementById('profile-professional').value.trim();
            const gender = document.getElementById('profile-gender').value;

            if (!displayName || !email) {
                alert('नाम और email जरूरी है');
                return;
            }

            currentUser.displayName = displayName;
            currentUser.email = email;
            currentUser.profilePhoto = profilePhoto || null;
            currentUser.age = age ? parseInt(age) : null;
            currentUser.bloodGroup = bloodGroup || null;
            currentUser.cast = cast || null;
            currentUser.subCast = subCast || null;
            currentUser.professional = professional || null;
            currentUser.gender = gender || 'male';
            currentUser.updatedAt = new Date().toISOString();
            
            if (currentUser.isAdmin) currentUser.status = 'verified';

            saveUser(currentUser);
            localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));

            alert('Profile saved!');
            showDashboard();
        }

        // R2 Media Upload Functions
        async function uploadToR2(file) {
            try {
                if (!file) throw new Error('No file provided');
                if (file.size > R2_CONFIG.MAX_FILE_SIZE) {
                    throw new Error(`File size exceeds ${R2_CONFIG.MAX_FILE_SIZE / (1024 * 1024)}MB limit`);
                }
                
                const fileType = file.type.startsWith('image/') ? 'image' : 'video';
                if (!R2_CONFIG.ALLOWED_TYPES[fileType].includes(file.type)) {
                    throw new Error('File type not supported');
                }
                
                const response = await fetch(`${R2_CONFIG.WORKER_URL}/upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        contentType: file.type
                    })
                });
                
                if (!response.ok) throw new Error('Failed to get upload URL');
                
                const { uploadUrl, publicUrl, objectKey } = await response.json();
                
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': file.type },
                    body: file
                });
                
                if (!uploadResponse.ok) throw new Error('Failed to upload file');
                
                return { success: true, url: publicUrl, key: objectKey };
            } catch (error) {
                console.error('R2 upload error:', error);
                return { success: false, error: error.message };
            }
        }

        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        // Firestore Backup & Restore Functions
        async function backupToFirestore() {
            if (!db) {
                alert('❌ Firestore not initialized. Cannot backup.');
                return { success: false, error: 'Firestore not available' };
            }
            
            try {
                const timestamp = new Date().toISOString();
                const backupData = {
                    users: await getAllUsers(),
                    casts: getAllCasts(),
                    familyMembers: getAllFamilyMembers(),
                    communities: getAllCommunities(),
                    timestamp: timestamp,
                    backupBy: currentUser.userId
                };
                
                await db.collection('backups').doc(timestamp).set(backupData);
                
                return { success: true, timestamp };
            } catch (error) {
                console.error('Backup error:', error);
                return { success: false, error: error.message };
            }
        }

        async function restoreFromFirestore(backupId) {
            if (!db) {
                alert('❌ Firestore not initialized. Cannot restore.');
                return { success: false, error: 'Firestore not available' };
            }
            
            try {
                const backupDoc = await db.collection('backups').doc(backupId).get();
                
                if (!backupDoc.exists) {
                    throw new Error('Backup not found');
                }
                
                const backupData = backupDoc.data();
                
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(backupData.users || []));
                localStorage.setItem(STORAGE_KEYS.CASTS, JSON.stringify(backupData.casts || []));
                localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(backupData.familyMembers || []));
                localStorage.setItem(STORAGE_KEYS.COMMUNITIES, JSON.stringify(backupData.communities || []));
                
                return { success: true, timestamp: backupData.timestamp };
            } catch (error) {
                console.error('Restore error:', error);
                return { success: false, error: error.message };
            }
        }

        async function autoBackupFirestore() {
            const lastBackup = localStorage.getItem('lastAutoBackup');
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            
            if (!lastBackup || (now - parseInt(lastBackup)) > oneDay) {
                const result = await backupToFirestore();
                if (result.success) {
                    localStorage.setItem('lastAutoBackup', now.toString());
                    console.log('✅ Auto backup completed:', result.timestamp);
                }
            }
        }

        function handleLogout() {
            if (confirm('Logout करना चाहते हैं?')) {
                currentUser = null;
                isAdminMode = false;
                localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                showLoginScreen();
            }
        }

        // Family Tree Functions
        function renderFamilyTree() {
            const contentDiv = document.getElementById('tree-content');
            const container = document.getElementById('familytree-container');
            
            if (!contentDiv) {
                console.error('tree-content div not found');
                return;
            }
            
            // Get selected filters
            const subCastSelect = document.getElementById('tree-subcast-filter');
            const selectedSubCast = subCastSelect ? subCastSelect.value : currentUser.subCast;
            
            if (!currentUser.cast || !currentUser.subCast) {
                contentDiv.innerHTML = '<p class="text-center text-gray-500 py-8">Profile में cast/sub-cast update करें</p>';
                return;
            }
            
            const filterSubCast = selectedSubCast || currentUser.subCast;
            
            // Get all members from localStorage
            let members = getAllFamilyMembers().filter(m => m.subCast === filterSubCast);
            
            console.log('All family members:', getAllFamilyMembers());
            console.log('Filtered members for', filterSubCast, ':', members);
            
            // Add current user to the tree if viewing their own sub-cast and not already present
            if (filterSubCast === currentUser.subCast) {
                const currentUserInTree = members.find(m => m.memberId === currentUser.userId);
                if (!currentUserInTree) {
                    // Check if user already exists in database (any cast/sub-cast)
                    let existingUserMember = getAllFamilyMembers().find(m => m.memberId === currentUser.userId);
                    
                    if (existingUserMember) {
                        // ✅ User already exists in database, use existing data (including code)
                        console.log('✅ Found existing user member with code:', existingUserMember.memberCode);
                        members.push(existingUserMember);
                    } else {
                        // ✅ New user, create with new code
                        const userName = currentUser.displayName || currentUser.name || 'User';
                        const nameParts = userName.split(' ');
                        const firstName = nameParts[0] || 'User';
                        const lastName = nameParts[nameParts.length - 1] || '';
                        
                        // Generate member code only for male users
                        const userGender = currentUser.gender || 'male';
                        const userMemberCode = userGender === 'male' ? generateMemberCode(firstName, lastName) : null;
                        
                        const currentUserMember = {
                            memberId: currentUser.userId,
                            memberCode: userMemberCode,  // null for females
                            firstName: firstName,
                            lastName: lastName,
                            fullName: userName,
                            displayName: userName,
                            name: userName,
                            birthYear: null,
                            gender: userGender,
                            profilePhoto: currentUser.profilePhoto || null,
                            relationType: 'self',
                            relationTo: null,
                            addedBy: currentUser.userId,
                            cast: currentUser.cast,
                            subCast: currentUser.subCast,
                            isAlive: true,
                            status: 'living',
                            createdAt: new Date().toISOString()
                        };
                        console.log('✅ Created new user member with code:', userMemberCode);
                        members.push(currentUserMember);
                        
                        // Save to database immediately so code persists
                        saveFamilyMember(currentUserMember);
                    }
                }
            }
            
            if (members.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-16">
                        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 mb-4">इस sub-cast में कोई family member नहीं है</p>
                        ${filterSubCast === currentUser.subCast ? `
                            <button onclick="showAddRelativeModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                                <i class="fas fa-plus mr-2"></i>पहला Member जोड़ें
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            // Build tree structure
            const tree = buildTreeStructure(members);
            
            let html = '<div class="family-tree">';
            html += renderTreeLevel(tree, true);
            html += '</div>';
            
            contentDiv.innerHTML = html;
            
            // Draw SVG lines after DOM is updated
            setTimeout(() => drawTreeLines(), 100);
        }

        function buildTreeStructure(members) {
            // Start with current user as the central point
            const currentUserMember = members.find(m => m.memberId === currentUser.userId);
            if (!currentUserMember) return members;
            
            return [currentUserMember];
        }
        
        function getRelativesByType(personId, relationType) {
            const allMembers = getAllFamilyMembers();
            const relatives = allMembers.filter(m => 
                m.relationTo === personId && m.relationType === relationType
            );
            console.log(`Getting ${relationType} for ${personId}:`, relatives);
            return relatives;
        }
        
        function getSpouse(personId) {
            const allMembers = getAllFamilyMembers();
            const spouse = allMembers.find(m => 
                m.relationTo === personId && (m.relationType === 'wife' || m.relationType === 'husband')
            );
            console.log(`Getting spouse for ${personId}:`, spouse);
            return spouse;
        }

        function renderTreeLevel(members, isRoot = false) {
            if (!members || members.length === 0) return '';
            
            const person = members[0]; // Central person
            let html = '<div class="tree-container">';
            
            // Render parents (Father & Mother) - TOP
            const father = getRelativesByType(person.memberId, 'father')[0];
            const mother = getRelativesByType(person.memberId, 'mother')[0];
            
            // Also check if father has a spouse (mother might be added as wife)
            let fatherSpouse = null;
            if (father && !mother) {
                fatherSpouse = getSpouse(father.memberId);
            }
            
            // Also check if mother has a spouse (father might be added as husband)
            let motherSpouse = null;
            if (mother && !father) {
                motherSpouse = getSpouse(mother.memberId);
            }
            
            if (father || mother || fatherSpouse || motherSpouse) {
                html += '<div class="tree-generation parents-generation">';
                html += '<div class="generation-row">';
                
                // Show father or mother's husband
                if (father) {
                    html += '<div class="tree-node">' + renderMemberCard(father) + '</div>';
                } else if (motherSpouse) {
                    html += '<div class="tree-node">' + renderMemberCard(motherSpouse) + '</div>';
                }
                
                // Show mother or father's wife
                if (mother) {
                    html += '<div class="tree-node">' + renderMemberCard(mother) + '</div>';
                } else if (fatherSpouse) {
                    html += '<div class="tree-node">' + renderMemberCard(fatherSpouse) + '</div>';
                }
                
                html += '</div>';
                html += '</div>';
            }
            
            // Render siblings + self + spouse - MIDDLE (same level)
            const siblings = [
                ...getRelativesByType(person.memberId, 'brother'),
                ...getRelativesByType(person.memberId, 'sister')
            ];
            
            const spouse = getSpouse(person.memberId);
            
            html += '<div class="tree-generation self-generation">';
            html += '<div class="generation-row">';
            
            // Siblings on left
            siblings.forEach(sibling => {
                html += '<div class="tree-node">' + renderMemberCard(sibling) + '</div>';
                // Show sibling's spouse if exists
                const siblingSpouse = getSpouse(sibling.memberId);
                if (siblingSpouse) {
                    html += '<div class="tree-node">' + renderMemberCard(siblingSpouse) + '</div>';
                }
            });
            
            // Self
            html += '<div class="tree-node self-node">' + renderMemberCard(person) + '</div>';
            
            // Spouse on right (same level)
            if (spouse) {
                html += '<div class="tree-node spouse-node">' + renderMemberCard(spouse) + '</div>';
            }
            
            html += '</div>';
            html += '</div>';
            
            // Children (sons/daughters) - BOTTOM
            const children = [
                ...getRelativesByType(person.memberId, 'son'),
                ...getRelativesByType(person.memberId, 'daughter')
            ];
            
            if (spouse) {
                // Also get children of spouse
                const spouseChildren = [
                    ...getRelativesByType(spouse.memberId, 'son'),
                    ...getRelativesByType(spouse.memberId, 'daughter')
                ];
                spouseChildren.forEach(child => {
                    if (!children.find(c => c.memberId === child.memberId)) {
                        children.push(child);
                    }
                });
            }
            
            if (children.length > 0) {
                html += '<div class="tree-generation children-generation">';
                html += '<div class="generation-row">';
                children.forEach(child => {
                    html += '<div class="tree-node">' + renderMemberCard(child) + '</div>';
                    // Also show child's spouse if exists
                    const childSpouse = getSpouse(child.memberId);
                    if (childSpouse) {
                        html += '<div class="tree-node">' + renderMemberCard(childSpouse) + '</div>';
                    }
                });
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>'; // Close tree-container
            
            return html;
        }

        function renderMemberCard(member) {
            // Use displayName if available, otherwise fallback to name or fullName
            const displayName = member.displayName || member.name || member.fullName || 'Unknown';
            const initials = getInitials(displayName);
            
            // Determine gender class based on relation type or gender field
            let genderClass = 'default';
            if (member.gender) {
                genderClass = member.gender === 'female' ? 'female' : 'male';
            } else if (member.relationType) {
                const femaleRelations = ['mother', 'wife', 'sister', 'daughter'];
                genderClass = femaleRelations.includes(member.relationType) ? 'female' : 'male';
            }
            
            // Admin has full power, normal users can only edit their own added members
            const canEdit = (currentUser && currentUser.isAdmin) || member.addedBy === currentUser.userId;
            const isCurrentUser = member.memberId === currentUser.userId;
            const isAdmin = member.memberId === currentUser.userId && currentUser.isAdmin;
            const isDeceased = member.status === 'deceased' || !member.isAlive;
            
            return `
                <div class="member-card ${isCurrentUser ? 'ring-2 ring-blue-500' : ''} ${isDeceased ? 'opacity-70' : ''}" onclick="showMemberOptions('${member.memberId}')">
                    <div class="member-avatar ${genderClass}">
                        ${member.profilePhoto ? 
                            `<img src="${member.profilePhoto}" alt="${displayName}">` : 
                            initials
                        }
                        ${canEdit ? '<div class="add-icon"><i class="fas fa-plus"></i></div>' : ''}
                        ${isAdmin ? '<div class="absolute -top-2 -right-2 bg-purple-600 text-white text-xs px-2 py-1 rounded-full">ADMIN</div>' : ''}
                        ${isDeceased ? '<div class="absolute -top-2 -left-2 bg-red-600 text-white text-xs px-2 py-1 rounded-full">☪</div>' : ''}
                    </div>
                    <div class="member-name">${escapeHtml(displayName)}</div>
                    <div class="member-year">${member.birthYear ? member.birthYear + ' -' : ''}</div>
                    ${isCurrentUser ? '<div class="text-xs text-blue-600 font-semibold mt-1">(You)</div>' : ''}
                    ${isDeceased ? '<div class="text-xs text-red-600 font-semibold mt-1">Deceased</div>' : ''}
                    ${member.memberCode ? `
                        <div class="text-xs text-gray-600 mt-1 flex items-center justify-center gap-1">
                            <i class="fas fa-qrcode"></i>
                            <span class="font-mono">${member.memberCode}</span>
                            <button onclick="event.stopPropagation(); copyCode('${member.memberCode}')" class="text-blue-600 hover:text-blue-800" title="Copy Code">
                                <i class="fas fa-copy text-xs"></i>
                            </button>
                        </div>
                    ` : ''}
                    ${member.isMarried && member.spouseInfo ? renderMarriageBadge(member) : ''}
                </div>
            `;
        }
        
        function renderMarriageBadge(member) {
            if (!member.spouseInfo) return '';
            
            const isInterCast = member.spouseInfo.spouseCast !== member.cast;
            if (!isInterCast) return ''; // Only show badge for inter-cast marriages
            
            const isDaughter = ['daughter', 'sister', 'wife', 'mother'].includes(member.relationType) || member.gender === 'female';
            const marriageIcon = isDaughter ? '👰' : '🤵';
            const spouseIcon = isDaughter ? '🤵' : '👰';
            const marriedText = isDaughter ? 'to' : 'from';
            const familyText = isDaughter ? "Husband's Family" : "Wife's Family";
            
            const badgeId = `marriage-${member.memberId}`;
            
            return `
                <div class="mt-2 w-full">
                    <button 
                        onclick="event.stopPropagation(); toggleMarriageBadge('${badgeId}')" 
                        class="w-full bg-pink-50 border border-pink-200 rounded-lg px-3 py-2 text-sm font-medium text-pink-700 hover:bg-pink-100 transition-colors flex items-center justify-between">
                        <span>${marriageIcon} Marriage Info</span>
                        <i id="${badgeId}-icon" class="fas fa-chevron-down text-xs transition-transform"></i>
                    </button>
                    <div id="${badgeId}" class="hidden mt-2 marriage-badge-expanded" onclick="event.stopPropagation();">
                        <div class="marriage-info">
                            <div class="married-to">💍 Married ${marriedText}:</div>
                            <div class="spouse-cast">🏡 ${member.spouseInfo.spouseCast} - ${member.spouseInfo.spouseSubCast}</div>
                            <div class="spouse-name">${spouseIcon} ${member.spouseInfo.spouseName || 'Spouse'}</div>
                            <button onclick="navigateToSpouseFamily('${member.spouseInfo.spouseId}', '${member.memberId}')" class="view-family-btn">
                                View ${familyText} 🔗
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function toggleMarriageBadge(badgeId) {
            const badge = document.getElementById(badgeId);
            const icon = document.getElementById(`${badgeId}-icon`);
            
            if (badge.classList.contains('hidden')) {
                badge.classList.remove('hidden');
                icon.classList.add('fa-chevron-up');
                icon.classList.remove('fa-chevron-down');
            } else {
                badge.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function showMemberOptions(memberId) {
            selectedMemberForRelative = memberId;
            const member = getAllFamilyMembers().find(m => m.memberId === memberId);
            
            if (!member) return;
            
            // Admin has full power over all members
            const canEdit = (currentUser && currentUser.isAdmin) || member.addedBy === currentUser.userId;
            
            const modal = document.getElementById('member-options-modal');
            const displayName = member.displayName || member.name || member.fullName || 'Unknown';
            
            document.getElementById('member-options-name').textContent = displayName;
            document.getElementById('member-options-photo').src = member.profilePhoto || '';
            document.getElementById('member-options-photo').style.display = member.profilePhoto ? 'block' : 'none';
            document.getElementById('member-options-initials').textContent = member.profilePhoto ? '' : getInitials(displayName);
            document.getElementById('member-options-initials').style.display = member.profilePhoto ? 'none' : 'flex';
            
            // Admin can edit/delete anyone, normal users only their own
            if (canEdit) {
                document.getElementById('edit-member-btn').classList.remove('hidden');
                document.getElementById('delete-member-btn').classList.remove('hidden');
            } else {
                document.getElementById('edit-member-btn').classList.add('hidden');
                document.getElementById('delete-member-btn').classList.add('hidden');
            }
            
            // Show admin badge if viewing admin member
            const memberIsAdmin = member.memberId === currentUser.userId && currentUser.isAdmin;
            console.log('Opening options for:', displayName, 'Can edit:', canEdit, 'Is Admin:', currentUser.isAdmin);
            
            modal.classList.remove('hidden');
        }

        function closeMemberOptions() {
            document.getElementById('member-options-modal').classList.add('hidden');
            // Don't reset selectedMemberForRelative here - it's needed for add relative flow
        }

        function showAddRelativeModal() {
            // selectedMemberForRelative should already be set from showMemberOptions
            console.log('Opening add relative modal for member:', selectedMemberForRelative);
            
            if (!selectedMemberForRelative) {
                selectedMemberForRelative = currentUser.userId;
                console.log('No member selected, using current user:', selectedMemberForRelative);
            }
            
            // Close member options modal but keep selectedMemberForRelative
            document.getElementById('member-options-modal').classList.add('hidden');
            document.getElementById('select-relation-modal').classList.remove('hidden');
        }

        function closeSelectRelation() {
            document.getElementById('select-relation-modal').classList.add('hidden');
            // Don't reset selectedRelationType here - it's needed for form submission
        }

        function selectRelation(relationType) {
            selectedRelationType = relationType;
            console.log('Relation selected:', selectedRelationType);
            
            // Highlight selected
            document.querySelectorAll('.relation-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function proceedWithRelation() {
            console.log('Proceeding with relation:', selectedRelationType);
            
            if (!selectedRelationType) {
                alert('कृपया relation select करें');
                return;
            }
            
            // Close modal but keep selectedRelationType
            document.getElementById('select-relation-modal').classList.add('hidden');
            showAddMemberForm();
            
            // Show/hide spouse link code based on gender
            const spouseSection = document.getElementById('marriage-section');
            const isFemale = (selectedRelationType === 'mother' || 
                             selectedRelationType === 'sister' || 
                             selectedRelationType === 'daughter' || 
                             selectedRelationType === 'wife');
            
            if (isFemale) {
                spouseSection.classList.remove('hidden');
                console.log('✅ Female member - Spouse Link Code section shown');
            } else {
                spouseSection.classList.add('hidden');
                console.log('❌ Male member - Spouse Link Code section hidden');
            }
        }

        function showAddMemberForm() {
            console.log('Showing add member form with relation:', selectedRelationType, 'for member:', selectedMemberForRelative);
            document.getElementById('add-member-modal').classList.remove('hidden');
            document.getElementById('add-member-form').reset();
        }

        function closeAddMemberForm() {
            document.getElementById('add-member-modal').classList.add('hidden');
            document.getElementById('add-member-form').reset();
            selectedRelationType = null;
            selectedMemberForRelative = null;
            console.log('Add member form closed, reset variables');
        }

        function handleAddMemberSubmit(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('new-member-firstname').value.trim();
            const lastName = document.getElementById('new-member-lastname').value.trim();
            const nickName = document.getElementById('new-member-nickname').value.trim();
            const displayNickName = document.getElementById('display-nickname').checked;
            const birthYear = document.getElementById('new-member-year').value.trim();
            const status = document.getElementById('new-member-status').value;
            const month = document.getElementById('new-member-month').value;
            const dateYear = document.getElementById('new-member-date-year').value.trim();
            const date = (month && dateYear) ? `${month}/${dateYear}` : null;
            const photo = document.getElementById('new-member-photo').value.trim();
            
            console.log('Form submit - First:', firstName, 'Last:', lastName, 'Nick:', nickName, 'Relation:', selectedRelationType, 'RelationTo:', selectedMemberForRelative);
            
            if (!firstName || !lastName) {
                alert('First Name और Last Name जरूरी है');
                return;
            }
            
            if (!selectedRelationType) {
                alert('Relation type select करें');
                return;
            }
            
            const fullName = `${firstName} ${lastName}`.trim();
            const displayName = displayNickName && nickName ? nickName : fullName;
            
            // Get selected cast/sub-cast from dropdowns (for admin adding to different cast)
            const castSelect = document.getElementById('tree-cast-filter');
            const subCastSelect = document.getElementById('tree-subcast-filter');
            const selectedCast = castSelect ? castSelect.value : currentUser.cast;
            const selectedSubCast = subCastSelect ? subCastSelect.value : currentUser.subCast;
            
            console.log('Current user cast/subcast:', currentUser.cast, currentUser.subCast);
            console.log('Selected cast/subcast:', selectedCast, selectedSubCast);
            
            // Determine gender from relationType
            let gender = 'male';
            if (selectedRelationType === 'mother' || selectedRelationType === 'sister' || selectedRelationType === 'daughter' || selectedRelationType === 'wife') {
                gender = 'female';
            } else {
                gender = 'male';
            }
            
            // Generate unique member code ONLY for males
            let memberCode = null;
            if (gender === 'male') {
                memberCode = generateMemberCode(firstName, lastName);
                console.log('✅ Male member - Code generated:', memberCode);
            } else {
                console.log('❌ Female member - No code assigned');
            }
            
            // Check marriage information (Code-based)
            const isMarried = document.getElementById('is-married-checkbox').checked;
            let spouseInfo = null;
            let spouseLinkCode = null;
            
            if (isMarried) {
                const codeInput = document.getElementById('spouse-link-code');
                spouseLinkCode = codeInput.value.trim().toUpperCase();
                
                if (!spouseLinkCode) {
                    alert('Please enter spouse link code');
                    return;
                }
                
                // Verify code format
                if (!spouseLinkCode.match(/^[A-Z]{3}-[0-9]{7}$/)) {
                    alert('Invalid spouse code format! Should be: ABC-1234567');
                    return;
                }
                
                // Find spouse by code
                const spouse = findMemberByCode(spouseLinkCode);
                
                if (!spouse) {
                    alert('Spouse not found! Please verify the code first.');
                    return;
                }
                
                // Create spouse info
                spouseInfo = {
                    spouseId: spouse.memberId,
                    spouseName: spouse.displayName || spouse.fullName || spouse.name,
                    spouseCast: spouse.cast,
                    spouseSubCast: spouse.subCast,
                    spouseCode: spouseLinkCode
                };
                
                console.log('Spouse found:', spouseInfo);
            }
            
            const member = {
                memberId: 'member_' + Date.now(),
                memberCode: memberCode,  // Unique code (null for females)
                gender: gender,  // 'male' or 'female'
                firstName: firstName,
                lastName: lastName,
                nickName: nickName || null,
                displayName: displayName,
                fullName: fullName,
                birthYear: birthYear ? parseInt(birthYear) : null,
                status: status,
                date: date || null,
                profilePhoto: photo || null,
                relationType: selectedRelationType,
                relationTo: selectedMemberForRelative || currentUser.userId,
                addedBy: currentUser.userId,
                cast: selectedCast,
                subCast: selectedSubCast,
                isAlive: status === 'living',
                isMarried: isMarried,
                spouseLinkCode: spouseLinkCode,  // Spouse's code
                spouseInfo: spouseInfo,
                createdAt: new Date().toISOString()
            };
            
            console.log('Creating member with code:', memberCode, member);
            
            saveFamilyMember(member);
            
            // Update spouse's record (bidirectional link)
            if (isMarried && spouseInfo) {
                let allMembers = getAllFamilyMembers();
                const spouseIndex = allMembers.findIndex(m => m.memberId === spouseInfo.spouseId);
                
                if (spouseIndex >= 0) {
                    allMembers[spouseIndex].isMarried = true;
                    allMembers[spouseIndex].spouseLinkCode = memberCode;
                    allMembers[spouseIndex].spouseInfo = {
                        spouseId: member.memberId,
                        spouseName: displayName,
                        spouseCast: selectedCast,
                        spouseSubCast: selectedSubCast,
                        spouseCode: memberCode
                    };
                    localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(allMembers));
                    console.log('Updated spouse with bidirectional link');
                }
            }
            
            console.log('Member saved. All members:', getAllFamilyMembers());
            
            closeAddMemberForm();
            renderFamilyTree();
            animateMemberCounter();
            alert('Member added successfully!\nMember Code: ' + memberCode + (isMarried && spouseInfo ? '\n\nMarriage link created! ✅' : ''));
        }

        function deleteMemberFromTree() {
            if (!selectedMemberForRelative) return;
            
            if (!confirm('इस member को delete करना चाहते हैं?')) return;
            
            let members = getAllFamilyMembers();
            const beforeCount = members.length;
            members = members.filter(m => m.memberId !== selectedMemberForRelative);
            const afterCount = members.length;
            
            console.log('Delete - Before:', beforeCount, 'After:', afterCount, 'Deleted:', beforeCount - afterCount);
            
            localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(members));
            
            closeMemberOptions();
            selectedMemberForRelative = null;
            renderFamilyTree();
            animateMemberCounter(); // Update counter after delete
        }

        function searchFamilyMembers() {
            const searchTerm = document.getElementById('family-search').value.toLowerCase();
            const members = getAllFamilyMembers().filter(m => 
                m.subCast === currentUser.subCast &&
                m.name.toLowerCase().includes(searchTerm)
            );
            
            // Re-render with filtered members
            const container = document.getElementById('familytree-container');
            let html = '<div class="family-tree"><div class="tree-row">';
            members.forEach(member => {
                html += renderMemberCard(member);
            });
            html += '</div></div>';
            container.innerHTML = html;
        }

        function printFamilyTree() {
            window.print();
        }
        
        // Marriage Navigation Functions
        function navigateToSpouseFamily(spouseId, fromMemberId) {
            console.log('Navigating to spouse family:', spouseId, 'from:', fromMemberId);
            
            const spouse = getAllFamilyMembers().find(m => m.memberId === spouseId);
            const fromMember = getAllFamilyMembers().find(m => m.memberId === fromMemberId);
            
            if (!spouse) {
                alert('Spouse family not found');
                return;
            }
            
            // Store navigation history
            const castSelect = document.getElementById('tree-cast-filter');
            const subCastSelect = document.getElementById('tree-subcast-filter');
            
            sessionStorage.setItem('navigationFrom', JSON.stringify({
                fromCast: castSelect.value,
                fromSubCast: subCastSelect.value,
                fromMemberId: fromMemberId,
                fromMemberName: fromMember ? (fromMember.displayName || fromMember.fullName || fromMember.name) : 'Member',
                toCast: spouse.cast,
                toSubCast: spouse.subCast,
                toMemberId: spouseId,
                toMemberName: spouse.displayName || spouse.fullName || spouse.name || 'Spouse'
            }));
            
            // Switch to spouse's cast/sub-cast
            castSelect.value = spouse.cast;
            updateTreeSubCastFilter();
            
            setTimeout(() => {
                subCastSelect.value = spouse.subCast;
                renderFamilyTree();
                
                // Show breadcrumb
                showNavigationBreadcrumb();
                
                // Highlight spouse member after tree renders
                setTimeout(() => {
                    highlightMember(spouseId);
                }, 300);
            }, 100);
        }
        
        function showNavigationBreadcrumb() {
            const history = JSON.parse(sessionStorage.getItem('navigationFrom'));
            if (!history) return;
            
            const nav = document.getElementById('marriage-navigation');
            const backText = document.getElementById('back-text');
            const currentViewText = document.getElementById('current-view-text');
            
            backText.textContent = `Back to ${history.fromMemberName}'s Family (${history.fromSubCast})`;
            currentViewText.textContent = `Viewing: ${history.toMemberName}'s Family (${history.toSubCast})`;
            
            nav.classList.remove('hidden');
        }
        
        function goBackToOriginalFamily() {
            const history = JSON.parse(sessionStorage.getItem('navigationFrom'));
            if (!history) return;
            
            const castSelect = document.getElementById('tree-cast-filter');
            const subCastSelect = document.getElementById('tree-subcast-filter');
            
            castSelect.value = history.fromCast;
            updateTreeSubCastFilter();
            
            setTimeout(() => {
                subCastSelect.value = history.fromSubCast;
                renderFamilyTree();
                
                // Hide breadcrumb
                document.getElementById('marriage-navigation').classList.add('hidden');
                
                // Highlight original member
                setTimeout(() => {
                    highlightMember(history.fromMemberId);
                }, 300);
                
                // Clear history
                sessionStorage.removeItem('navigationFrom');
            }, 100);
        }
        
        function highlightMember(memberId) {
            // Find all member cards and highlight the one with matching memberId
            const allCards = document.querySelectorAll('.member-card');
            allCards.forEach(card => {
                // Check if this card's onclick contains the memberId
                const onclickAttr = card.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(memberId)) {
                    card.classList.add('highlight-flash');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    setTimeout(() => {
                        card.classList.remove('highlight-flash');
                    }, 2000);
                }
            });
        }
        
        // Member Code Generation
        function generateMemberCode(firstName, lastName) {
            // First 3 letters of first name + 7 digit number
            const namePrefix = (firstName || 'MEM').substring(0, 3).toUpperCase();
            const randomNum = Math.floor(1000000 + Math.random() * 9000000);
            return `${namePrefix}-${randomNum}`;
        }
        
        function findMemberByCode(code) {
            const allMembers = getAllFamilyMembers();
            return allMembers.find(m => m.memberCode === code);
        }
        
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied: ' + code);
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Code copied: ' + code);
            });
        }
        
        // Assign codes to existing male members who don't have them
        function assignMissingMemberCodes() {
            console.log('🔧 === Assigning Missing Member Codes ===');
            
            const allMembers = getAllFamilyMembers();
            let updatedCount = 0;
            
            allMembers.forEach(member => {
                // Check if male member without code
                const isMale = member.gender === 'male' || 
                               member.relationType === 'father' || 
                               member.relationType === 'brother' || 
                               member.relationType === 'son' || 
                               member.relationType === 'husband';
                
                if (isMale && !member.memberCode) {
                    // Generate and assign code
                    const firstName = member.firstName || member.name || 'Member';
                    const lastName = member.lastName || '';
                    member.memberCode = generateMemberCode(firstName, lastName);
                    updatedCount++;
                    
                    console.log(`✅ Assigned code ${member.memberCode} to ${member.fullName || member.name}`);
                }
            });
            
            if (updatedCount > 0) {
                // Save all updated members
                localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(allMembers));
                console.log(`✅ Total codes assigned: ${updatedCount}`);
            } else {
                console.log('ℹ️ No codes needed to be assigned');
            }
            
            return updatedCount;
        }
        
        // Form Helper Functions for Marriage
        function toggleMarriageFields() {
            const checkbox = document.getElementById('is-married-checkbox');
            const fields = document.getElementById('marriage-fields');
            
            if (checkbox.checked) {
                fields.classList.remove('hidden');
            } else {
                fields.classList.add('hidden');
                // Reset fields
                document.getElementById('spouse-link-code').value = '';
                document.getElementById('spouse-preview').classList.add('hidden');
            }
        }
        
        function verifySpouseCode() {
            const codeInput = document.getElementById('spouse-link-code');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                alert('Please enter a spouse code');
                return;
            }
            
            if (!code.match(/^[A-Z]{3}-[0-9]{7}$/)) {
                alert('Invalid code format! Should be: ABC-1234567');
                return;
            }
            
            const spouse = findMemberByCode(code);
            
            if (spouse) {
                // Show preview
                document.getElementById('spouse-preview').classList.remove('hidden');
                document.getElementById('spouse-name').textContent = 
                    spouse.displayName || spouse.fullName || spouse.name;
                document.getElementById('spouse-cast-info').textContent = 
                    `${spouse.cast} - ${spouse.subCast}`;
                
                // Store verified spouse ID temporarily
                codeInput.setAttribute('data-spouse-id', spouse.memberId);
            } else {
                alert('Spouse not found! Please check the code.');
                document.getElementById('spouse-preview').classList.add('hidden');
                codeInput.removeAttribute('data-spouse-id');
            }
        }
        
        // Verify Spouse Code in Edit Modal (for females)
        function verifyEditSpouseCode() {
            const codeInput = document.getElementById('edit-spouse-link-code');
            const code = codeInput.value.trim().toUpperCase();
            
            console.log('🔍 Verifying spouse code:', code);
            
            if (!code) {
                alert('कृपया spouse code enter करें');
                return;
            }
            
            if (!code.match(/^[A-Z]{3}-[0-9]{7}$/)) {
                alert('Invalid code format! Format: ABC-1234567');
                return;
            }
            
            // Get all male members with codes
            const allMembers = getAllFamilyMembers();
            const maleMembersWithCodes = allMembers.filter(m => m.memberCode && m.gender === 'male');
            
            console.log('📊 Total members:', allMembers.length);
            console.log('📊 Male members with codes:', maleMembersWithCodes.length);
            console.log('📋 Available codes:', maleMembersWithCodes.map(m => ({
                code: m.memberCode,
                name: m.fullName || m.name,
                cast: m.cast,
                subCast: m.subCast
            })));
            
            const spouse = findMemberByCode(code);
            
            if (spouse) {
                // Show preview
                document.getElementById('edit-spouse-preview').classList.remove('hidden');
                document.getElementById('edit-spouse-name-preview').textContent = 
                    spouse.displayName || spouse.fullName || spouse.name;
                
                // Store verified spouse ID temporarily
                codeInput.setAttribute('data-spouse-id', spouse.memberId);
                console.log('✅ Spouse found:', spouse.fullName, 'Code:', spouse.memberCode);
            } else {
                const availableCodes = maleMembersWithCodes
                    .map(m => `${m.memberCode} - ${m.fullName || m.name}`)
                    .join('\n');
                
                alert(`❌ Spouse not found with code: ${code}\n\n` +
                      `Available codes:\n${availableCodes || 'No male members with codes found!'}`);
                
                document.getElementById('edit-spouse-preview').classList.add('hidden');
                codeInput.removeAttribute('data-spouse-id');
                console.log('❌ Spouse not found. Searched for:', code);
            }
        }
        
        // Edit Member Functions
        function editMember() {
            if (!selectedMemberForRelative) return;
            
            const member = getAllFamilyMembers().find(m => m.memberId === selectedMemberForRelative);
            if (!member) {
                alert('Member not found');
                return;
            }
            
            // Check permissions (Admin can edit anyone, normal users only their own, also allow editing self)
            const isSelf = member.memberId === currentUser.userId;
            const canEdit = (currentUser && currentUser.isAdmin) || member.addedBy === currentUser.userId || isSelf;
            if (!canEdit) {
                alert('You do not have permission to edit this member');
                return;
            }
            
            // Populate form
            document.getElementById('edit-member-id').value = member.memberId;
            
            // Show member code section only for males (who have codes)
            const codeSection = document.getElementById('edit-member-code').closest('.bg-blue-50');
            if (member.memberCode) {
                codeSection.classList.remove('hidden');
                document.getElementById('edit-member-code').textContent = member.memberCode;
                console.log('✅ Showing member code:', member.memberCode);
            } else {
                codeSection.classList.add('hidden');
                console.log('❌ No member code (female member)');
            }
            
            document.getElementById('edit-firstname').value = member.firstName || '';
            document.getElementById('edit-lastname').value = member.lastName || '';
            document.getElementById('edit-nickname').value = member.nickName || '';
            document.getElementById('edit-display-nickname').checked = member.displayName === member.nickName;
            document.getElementById('edit-birth-year').value = member.birthYear || '';
            document.getElementById('edit-status').value = member.status || 'living';
            document.getElementById('edit-photo').value = member.profilePhoto || '';
            
            // Parse date if exists
            if (member.date) {
                const parts = member.date.split('/');
                if (parts.length === 2) {
                    document.getElementById('edit-month').value = parts[0];
                    document.getElementById('edit-date-year').value = parts[1];
                }
            } else {
                document.getElementById('edit-month').value = '';
                document.getElementById('edit-date-year').value = '';
            }
            
            // Load cast options and set values
            loadEditCastOptions();
            setTimeout(() => {
                document.getElementById('edit-cast').value = member.cast || '';
                updateEditSubCastOptions();
                setTimeout(() => {
                    document.getElementById('edit-subcast').value = member.subCast || '';
                }, 100);
            }, 100);
            
            // Show marriage info if married
            if (member.isMarried && member.spouseInfo) {
                document.getElementById('edit-marriage-info').classList.remove('hidden');
                document.getElementById('edit-spouse-name').textContent = member.spouseInfo.spouseName || 'N/A';
                document.getElementById('edit-spouse-cast').textContent = 
                    `${member.spouseInfo.spouseCast} - ${member.spouseInfo.spouseSubCast}`;
                document.getElementById('edit-spouse-code').textContent = member.spouseLinkCode || 'N/A';
            } else {
                document.getElementById('edit-marriage-info').classList.add('hidden');
            }
            
            // Show spouse link section only for females
            const isFemale = member.gender === 'female' || 
                             member.relationType === 'mother' || 
                             member.relationType === 'sister' || 
                             member.relationType === 'daughter' || 
                             member.relationType === 'wife';
            
            const spouseLinkSection = document.getElementById('edit-spouse-link-section');
            if (isFemale) {
                spouseLinkSection.classList.remove('hidden');
                // Pre-fill if already has spouse code
                const spouseLinkInput = document.getElementById('edit-spouse-link-code');
                if (member.spouseLinkCode) {
                    spouseLinkInput.value = member.spouseLinkCode;
                } else {
                    spouseLinkInput.value = '';
                }
                // Reset preview
                document.getElementById('edit-spouse-preview').classList.add('hidden');
                console.log('✅ Female member - Showing spouse link section');
            } else {
                spouseLinkSection.classList.add('hidden');
                console.log('❌ Male member - Hiding spouse link section');
            }
            
            // Close member options and open edit modal
            closeMemberOptions();
            document.getElementById('edit-member-modal').classList.remove('hidden');
        }
        
        function handleEditMemberSubmit(e) {
            e.preventDefault();
            
            const memberId = document.getElementById('edit-member-id').value;
            if (!memberId) {
                alert('Member ID missing');
                return;
            }
            
            // Get all members
            let allMembers = getAllFamilyMembers();
            const memberIndex = allMembers.findIndex(m => m.memberId === memberId);
            
            if (memberIndex < 0) {
                alert('Member not found');
                return;
            }
            
            const member = allMembers[memberIndex];
            
            // Update fields
            const firstName = document.getElementById('edit-firstname').value.trim();
            const lastName = document.getElementById('edit-lastname').value.trim();
            const nickName = document.getElementById('edit-nickname').value.trim();
            const displayNickName = document.getElementById('edit-display-nickname').checked;
            
            member.firstName = firstName;
            member.lastName = lastName;
            member.nickName = nickName || null;
            member.fullName = `${firstName} ${lastName}`.trim();
            member.displayName = displayNickName && nickName ? nickName : member.fullName;
            member.birthYear = document.getElementById('edit-birth-year').value ? 
                parseInt(document.getElementById('edit-birth-year').value) : null;
            member.status = document.getElementById('edit-status').value;
            member.isAlive = member.status === 'living';
            member.profilePhoto = document.getElementById('edit-photo').value.trim() || null;
            
            // Update date
            const month = document.getElementById('edit-month').value;
            const dateYear = document.getElementById('edit-date-year').value.trim();
            member.date = (month && dateYear) ? `${month}/${dateYear}` : null;
            
            // Update cast/subcast (admin only)
            if (currentUser && currentUser.isAdmin) {
                member.cast = document.getElementById('edit-cast').value;
                member.subCast = document.getElementById('edit-subcast').value;
            }
            
            // Handle spouse link for female members
            const isFemale = member.gender === 'female' || 
                             member.relationType === 'mother' || 
                             member.relationType === 'sister' || 
                             member.relationType === 'daughter' || 
                             member.relationType === 'wife';
            
            if (isFemale) {
                const spouseLinkCode = document.getElementById('edit-spouse-link-code').value.trim().toUpperCase();
                
                if (spouseLinkCode) {
                    // Validate and find spouse
                    const spouse = findMemberByCode(spouseLinkCode);
                    
                    if (spouse) {
                        // Update current member with spouse info
                        member.spouseLinkCode = spouseLinkCode;
                        member.isMarried = true;
                        member.spouseInfo = {
                            spouseId: spouse.memberId,
                            spouseName: spouse.displayName || spouse.fullName,
                            spouseCast: spouse.cast,
                            spouseSubCast: spouse.subCast,
                            spouseCode: spouseLinkCode
                        };
                        
                        // Bidirectional linking: Update spouse's record
                        const spouseIndex = allMembers.findIndex(m => m.memberId === spouse.memberId);
                        if (spouseIndex >= 0) {
                            allMembers[spouseIndex].isMarried = true;
                            allMembers[spouseIndex].spouseLinkCode = member.memberCode; // Female has no code, so this will be null
                            allMembers[spouseIndex].spouseInfo = {
                                spouseId: member.memberId,
                                spouseName: member.displayName || member.fullName,
                                spouseCast: member.cast,
                                spouseSubCast: member.subCast,
                                spouseCode: member.memberCode || null
                            };
                            console.log('✅ Bidirectional link created with spouse:', spouse.fullName);
                        }
                    } else {
                        alert('Spouse code invalid! कृपया पहले verify करें।');
                        return;
                    }
                } else {
                    // If no code entered, clear marriage info
                    member.isMarried = false;
                    member.spouseLinkCode = null;
                    member.spouseInfo = null;
                }
            }
            
            // Save updated member
            allMembers[memberIndex] = member;
            localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(allMembers));
            
            console.log('✅ Member updated:', member);
            
            // Update spouse's spouseInfo.spouseName if married (for name changes)
            if (member.isMarried && member.spouseInfo) {
                const spouseIndex = allMembers.findIndex(m => m.memberId === member.spouseInfo.spouseId);
                if (spouseIndex >= 0 && allMembers[spouseIndex].spouseInfo) {
                    allMembers[spouseIndex].spouseInfo.spouseName = member.displayName;
                    localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(allMembers));
                }
            }
            
            closeEditMemberModal();
            renderFamilyTree();
            alert('Member updated successfully!');
        }
        
        function closeEditMemberModal() {
            document.getElementById('edit-member-modal').classList.add('hidden');
            document.getElementById('edit-member-form').reset();
        }
        
        function copyEditMemberCode() {
            const code = document.getElementById('edit-member-code').textContent;
            if (code && code !== 'N/A') {
                copyCode(code);
            }
        }
        
        function loadEditCastOptions() {
            const castSelect = document.getElementById('edit-cast');
            const casts = getAllCasts();
            
            castSelect.innerHTML = '<option value="">Select Cast</option>';
            casts.forEach(cast => {
                castSelect.innerHTML += `<option value="${cast.castName}">${cast.castName}</option>`;
            });
        }
        
        function updateEditSubCastOptions() {
            const castSelect = document.getElementById('edit-cast');
            const subCastSelect = document.getElementById('edit-subcast');
            const selectedCast = castSelect.value;
            
            subCastSelect.innerHTML = '<option value="">Select Sub-cast</option>';
            
            if (!selectedCast) return;
            
            const casts = getAllCasts();
            const cast = casts.find(c => c.castName === selectedCast);
            
            if (cast && cast.subCasts) {
                cast.subCasts.forEach(subCast => {
                    subCastSelect.innerHTML += `<option value="${subCast.subCastName}">${subCast.subCastName}</option>`;
                });
            }
        }
        
        
        function cleanDuplicateMembers() {
            let members = getAllFamilyMembers();
            const seen = new Set();
            const cleaned = [];
            
            members.forEach(member => {
                // Create unique key based on name and relation
                const key = `${member.name || member.fullName}-${member.relationType}-${member.relationTo}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    cleaned.push(member);
                } else {
                    console.log('Duplicate found:', member);
                }
            });
            
            if (members.length !== cleaned.length) {
                console.log('Cleaning duplicates:', members.length, '→', cleaned.length);
                localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(cleaned));
                return true;
            }
            return false;
        }
        
        function cleanupFemaleMemberCodes() {
            console.log('🧹 === Cleaning Female Member Codes ===');
            let allMembers = getAllFamilyMembers();
            let cleanedCount = 0;
            
            allMembers = allMembers.map(member => {
                // Determine if member is female based on gender or relationType
                const isFemale = member.gender === 'female' || 
                                 member.relationType === 'mother' || 
                                 member.relationType === 'sister' || 
                                 member.relationType === 'daughter' || 
                                 member.relationType === 'wife';
                
                // If female and has a memberCode, remove it
                if (isFemale && member.memberCode) {
                    console.log(`❌ Removing code from female member: ${member.fullName || member.name} (${member.memberCode})`);
                    member.memberCode = null;
                    cleanedCount++;
                }
                
                return member;
            });
            
            if (cleanedCount > 0) {
                localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(allMembers));
                console.log(`✅ Cleanup complete: Removed ${cleanedCount} codes from female members`);
            } else {
                console.log('✅ No female codes to clean');
            }
            
            return cleanedCount;
        }
        
        function validateAndCleanMembers() {
            console.log('=== Validating Family Members ===');
            let members = getAllFamilyMembers();
            const beforeCount = members.length;
            
            console.log('Before validation:', beforeCount, 'members');
            
            // Build tree of valid members starting from current user
            const validMemberIds = new Set();
            
            // Add current user if they have cast/subcast
            if (currentUser && currentUser.cast && currentUser.subCast) {
                validMemberIds.add(currentUser.userId);
            }
            
            // Function to recursively validate members
            function validateMember(memberId, depth = 0) {
                if (depth > 10) return; // Prevent infinite loops
                
                const relatedMembers = members.filter(m => 
                    m.relationTo === memberId || m.memberId === memberId
                );
                
                relatedMembers.forEach(m => {
                    if (!validMemberIds.has(m.memberId)) {
                        validMemberIds.add(m.memberId);
                        // Check for members related to this member
                        validateMember(m.memberId, depth + 1);
                    }
                });
            }
            
            // Start validation from all members who have relationTo pointing to valid members
            members.forEach(m => {
                if (validMemberIds.has(m.relationTo) || validMemberIds.has(m.memberId)) {
                    validMemberIds.add(m.memberId);
                }
            });
            
            // Second pass: validate all members connected to the tree
            members.forEach(m => {
                if (validMemberIds.has(m.relationTo)) {
                    validMemberIds.add(m.memberId);
                }
            });
            
            // Keep only valid members
            const validMembers = members.filter(m => validMemberIds.has(m.memberId));
            const afterCount = validMembers.length;
            
            console.log('After validation:', afterCount, 'members');
            console.log('Removed:', beforeCount - afterCount, 'invalid/orphaned members');
            
            if (beforeCount !== afterCount) {
                localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(validMembers));
                console.log('✅ LocalStorage cleaned!');
                return true;
            }
            
            console.log('✅ No cleanup needed');
            return false;
        }
        
        // Call this on init
        window.cleanDuplicateMembers = cleanDuplicateMembers;
        window.validateAndCleanMembers = validateAndCleanMembers;
        
        function drawTreeLines() {
            const svg = document.getElementById('tree-lines-svg');
            if (!svg) return;
            
            // Clear existing lines
            svg.innerHTML = '';
            
            const container = document.getElementById('familytree-container');
            const containerRect = container.getBoundingClientRect();
            
            // Set SVG dimensions
            svg.setAttribute('width', container.scrollWidth);
            svg.setAttribute('height', container.scrollHeight);
            
            // Get all generations
            const parentsGen = document.querySelector('.parents-generation');
            const selfGen = document.querySelector('.self-generation');
            const childrenGen = document.querySelector('.children-generation');
            
            // 1. PARENTS GENERATION LINES
            if (parentsGen && selfGen) {
                const parentNodes = parentsGen.querySelectorAll('.tree-node');
                if (parentNodes.length >= 2) {
                    // Get parent card positions
                    const parent1Rect = parentNodes[0].getBoundingClientRect();
                    const parent2Rect = parentNodes[1].getBoundingClientRect();
                    
                    // Calculate center points
                    const p1X = parent1Rect.left + parent1Rect.width / 2 - containerRect.left;
                    const p1BottomY = parent1Rect.bottom - containerRect.top;
                    const p2X = parent2Rect.left + parent2Rect.width / 2 - containerRect.left;
                    const p2BottomY = parent2Rect.bottom - containerRect.top;
                    
                    // Horizontal line between parents (at same Y level - bottom of cards + spacing)
                    const parentLineY = Math.max(p1BottomY, p2BottomY) + 20;
                    drawLine(svg, p1X, parentLineY, p2X, parentLineY);
                    
                    // Vertical lines from each parent down to horizontal line
                    drawLine(svg, p1X, p1BottomY, p1X, parentLineY);
                    drawLine(svg, p2X, p2BottomY, p2X, parentLineY);
                    
                    // Vertical line down from center to self generation
                    const parentsCenterX = (p1X + p2X) / 2;
                    const selfGenRect = selfGen.getBoundingClientRect();
                    const selfGenTopY = selfGenRect.top - containerRect.top;
                    
                    drawLine(svg, parentsCenterX, parentLineY, parentsCenterX, selfGenTopY - 20);
                }
            }
            
            // 2. SELF GENERATION LINES (Siblings + Self + Spouse)
            if (selfGen) {
                const selfNodes = selfGen.querySelectorAll('.tree-node');
                const selfGenRect = selfGen.getBoundingClientRect();
                const selfGenTopY = selfGenRect.top - containerRect.top;
                
                // Find self and spouse nodes
                let selfNode = null;
                let spouseNode = null;
                const siblingNodes = [];
                
                selfNodes.forEach(node => {
                    if (node.classList.contains('self-node')) {
                        selfNode = node;
                    } else if (node.classList.contains('spouse-node')) {
                        spouseNode = node;
                    } else {
                        siblingNodes.push(node);
                    }
                });
                
                // Draw horizontal line across all siblings (if multiple siblings)
                if (siblingNodes.length > 0) {
                    const allNodesInRow = [...siblingNodes];
                    if (selfNode) allNodesInRow.push(selfNode);
                    
                    if (allNodesInRow.length > 1) {
                        const firstRect = allNodesInRow[0].getBoundingClientRect();
                        const lastRect = allNodesInRow[allNodesInRow.length - 1].getBoundingClientRect();
                        
                        const firstX = firstRect.left + firstRect.width / 2 - containerRect.left;
                        const lastX = lastRect.left + lastRect.width / 2 - containerRect.left;
                        const siblingsLineY = selfGenTopY - 20;
                        
                        // Horizontal line across siblings including self
                        drawLine(svg, firstX, siblingsLineY, lastX, siblingsLineY);
                        
                        // Vertical lines down to each sibling/self card
                        allNodesInRow.forEach(node => {
                            const rect = node.getBoundingClientRect();
                            const x = rect.left + rect.width / 2 - containerRect.left;
                            const topY = rect.top - containerRect.top;
                            drawLine(svg, x, siblingsLineY, x, topY);
                        });
                    }
                }
                
                // Draw horizontal line from self to spouse (at card center height)
                if (selfNode && spouseNode) {
                    const selfRect = selfNode.getBoundingClientRect();
                    const spouseRect = spouseNode.getBoundingClientRect();
                    
                    const selfCenterX = selfRect.left + selfRect.width / 2 - containerRect.left;
                    const selfCenterY = selfRect.top + selfRect.height / 2 - containerRect.top;
                    const spouseCenterX = spouseRect.left + spouseRect.width / 2 - containerRect.left;
                    const spouseCenterY = spouseRect.top + spouseRect.height / 2 - containerRect.top;
                    
                    // Use same Y level (average if different)
                    const coupleLineY = (selfCenterY + spouseCenterY) / 2;
                    
                    drawLine(svg, selfCenterX, coupleLineY, spouseCenterX, coupleLineY);
                }
            }
            
            // 3. CHILDREN GENERATION LINES
            if (selfGen && childrenGen) {
                const selfNodes = selfGen.querySelectorAll('.tree-node');
                const childNodes = childrenGen.querySelectorAll('.tree-node');
                
                if (childNodes.length > 0) {
                    // Find self and spouse
                    let selfNode = null;
                    let spouseNode = null;
                    
                    selfNodes.forEach(node => {
                        if (node.classList.contains('self-node')) {
                            selfNode = node;
                        } else if (node.classList.contains('spouse-node')) {
                            spouseNode = node;
                        }
                    });
                    
                    if (selfNode) {
                        const selfRect = selfNode.getBoundingClientRect();
                        let coupleX = selfRect.left + selfRect.width / 2 - containerRect.left;
                        
                        // If spouse exists, use midpoint between self and spouse
                        if (spouseNode) {
                            const spouseRect = spouseNode.getBoundingClientRect();
                            const spouseX = spouseRect.left + spouseRect.width / 2 - containerRect.left;
                            coupleX = (coupleX + spouseX) / 2;
                        }
                        
                        const selfBottomY = selfRect.bottom - containerRect.top;
                        const childrenGenRect = childrenGen.getBoundingClientRect();
                        const childrenTopY = childrenGenRect.top - containerRect.top;
                        
                        // Vertical line from couple midpoint down to children horizontal line
                        const childrenLineY = childrenTopY - 20;
                        drawLine(svg, coupleX, selfBottomY + 20, coupleX, childrenLineY);
                        
                        // Horizontal line across all children
                        if (childNodes.length > 1) {
                            const firstChildRect = childNodes[0].getBoundingClientRect();
                            const lastChildRect = childNodes[childNodes.length - 1].getBoundingClientRect();
                            
                            const firstChildX = firstChildRect.left + firstChildRect.width / 2 - containerRect.left;
                            const lastChildX = lastChildRect.left + lastChildRect.width / 2 - containerRect.left;
                            
                            drawLine(svg, firstChildX, childrenLineY, lastChildX, childrenLineY);
                        }
                        
                        // Vertical lines down to each child card
                        childNodes.forEach(childNode => {
                            const childRect = childNode.getBoundingClientRect();
                            const childX = childRect.left + childRect.width / 2 - containerRect.left;
                            const childTopY = childRect.top - containerRect.top;
                            drawLine(svg, childX, childrenLineY, childX, childTopY);
                        });
                    }
                }
            }
        }
        
        function drawLine(svg, x1, y1, x2, y2) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke', '#4a5568');
            line.setAttribute('stroke-width', '2');
            svg.appendChild(line);
        }

        // Chat Functions
        function loadCommunityChat() {
            const messages = getAllMessages().filter(m => m.receiverId === 'all');
            const container = document.getElementById('community-messages');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">कोई message नहीं</p>';
                return;
            }
            
            messages.forEach(msg => {
                const isOwn = msg.senderId === currentUser.userId;
                const div = document.createElement('div');
                div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} mb-3`;
                div.innerHTML = `
                    <div class="max-w-xs px-4 py-2 rounded-lg ${isOwn ? 'bg-blue-500 text-white' : 'bg-gray-200'}">
                        <p class="text-xs font-semibold mb-1">${escapeHtml(msg.senderName)}</p>
                        <p class="text-sm">${escapeHtml(msg.message)}</p>
                        <p class="text-xs opacity-70 mt-1">${formatTime(new Date(msg.timestamp))}</p>
                    </div>
                `;
                container.appendChild(div);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;
            
            const message = {
                messageId: 'msg_' + Date.now(),
                senderId: currentUser.userId,
                senderName: currentUser.displayName,
                receiverId: 'all',
                message: text,
                timestamp: new Date().toISOString(),
                status: 1
            };
            
            saveMessage(message);
            input.value = '';
            loadCommunityChat();
        }

        // Admin Panel
        function showAdminTab(tabName) {
            console.log('🔧 Admin tab switched to:', tabName);
            document.querySelectorAll('[id^="admin-tab-"]').forEach(t => t.classList.add('hidden'));
            document.getElementById('admin-tab-' + tabName).classList.remove('hidden');
            
            if (tabName === 'casts') loadCastManagement();
            if (tabName === 'users') {
                console.log('👥 Loading User Management tab...');
                loadUserManagement('all'); // Show all users including admin by default
            }
            if (tabName === 'profile') loadAdminProfile();
            if (tabName === 'backup') loadBackupTab();
        }
        
        function loadBackupTab() {
            // Tab already has static content, nothing to load
            console.log('💾 Backup tab loaded');
        }
        
        async function handleBackupClick() {
            const statusDiv = document.getElementById('backup-status');
            const button = event.target.closest('button');
            
            // Disable button
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Backing up...';
            
            // Show status
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Backup शुरू हो रहा है...';
            
            try {
                const result = await backupToFirestore();
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="text-green-600 font-semibold">
                            <i class="fas fa-check-circle mr-2"></i>
                            ✅ Backup successful!
                            <div class="mt-2 text-sm">
                                Users: ${result.stats.users} | Messages: ${result.stats.messages} | Casts: ${result.stats.casts}
                            </div>
                        </div>
                    `;
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 5000);
                } else {
                    statusDiv.innerHTML = `
                        <div class="text-red-600 font-semibold">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            ❌ Backup failed: ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="text-red-600 font-semibold">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        ❌ Error: ${error.message}
                    </div>
                `;
            } finally {
                // Re-enable button
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i>Backup to Firestore';
            }
        }
        
        async function handleRestoreClick() {
            const statusDiv = document.getElementById('backup-status');
            const button = event.target.closest('button');
            
            // Disable button
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Restoring...';
            
            // Show status
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Restore शुरू हो रहा है...';
            
            try {
                const result = await restoreFromFirestore();
                
                if (result.success) {
                    // Page will reload, so this might not show
                    statusDiv.innerHTML = `
                        <div class="text-green-600 font-semibold">
                            <i class="fas fa-check-circle mr-2"></i>
                            ✅ Restore successful! Reloading...
                        </div>
                    `;
                } else if (result.cancelled) {
                    statusDiv.innerHTML = `
                        <div class="text-gray-600">
                            <i class="fas fa-info-circle mr-2"></i>
                            Restore cancelled
                        </div>
                    `;
                    setTimeout(() => statusDiv.classList.add('hidden'), 3000);
                } else {
                    statusDiv.innerHTML = `
                        <div class="text-red-600 font-semibold">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            ❌ Restore failed: ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="text-red-600 font-semibold">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        ❌ Error: ${error.message}
                    </div>
                `;
            } finally {
                // Re-enable button
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-cloud-download-alt mr-2"></i>Restore from Firestore';
            }
        }

        function loadCastManagement() {
            const container = document.getElementById('casts-list');
            const casts = getAllCasts();
            
            let html = '<button onclick="addCast()" class="bg-purple-600 text-white px-4 py-2 rounded-md mb-4 hover:bg-purple-700"><i class="fas fa-plus mr-2"></i>Add Cast</button>';
            
            casts.forEach(cast => {
                html += `
                    <div class="bg-white p-4 rounded-lg shadow mb-4">
                        <div class="flex justify-between mb-2">
                            <h3 class="font-bold">${escapeHtml(cast.castName)}</h3>
                            <div class="flex gap-2">
                                <button onclick="addSubCast('${cast.castId}')" class="bg-blue-600 text-white px-3 py-1 text-sm rounded hover:bg-blue-700">Add Sub-cast</button>
                                <button onclick="deleteCast('${cast.castId}')" class="bg-red-600 text-white px-3 py-1 text-sm rounded hover:bg-red-700">Delete</button>
                            </div>
                        </div>
                        <div class="ml-4">
                            ${cast.subCasts.map(sc => `
                                <div class="flex justify-between py-2 border-b">
                                    <span>${escapeHtml(sc.subCastName)}</span>
                                    <button onclick="deleteSubCast('${cast.castId}', '${sc.subCastId}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function addCast() {
            const name = prompt('Cast का नाम:');
            if (!name) return;
            
            const casts = getAllCasts();
            casts.push({
                castId: 'cast_' + Date.now(),
                castName: name.trim(),
                subCasts: []
            });
            saveCasts(casts);
            loadCastManagement();
        }

        function addSubCast(castId) {
            const name = prompt('Sub-cast का नाम:');
            if (!name) return;
            
            const casts = getAllCasts();
            const cast = casts.find(c => c.castId === castId);
            if (cast) {
                cast.subCasts.push({
                    subCastId: 'subcast_' + Date.now(),
                    subCastName: name.trim()
                });
                saveCasts(casts);
                loadCastManagement();
            }
        }

        function deleteCast(castId) {
            if (!confirm('Delete करना चाहते हैं?')) return;
            let casts = getAllCasts();
            casts = casts.filter(c => c.castId !== castId);
            saveCasts(casts);
            loadCastManagement();
        }

        function deleteSubCast(castId, subCastId) {
            if (!confirm('Delete करना चाहते हैं?')) return;
            const casts = getAllCasts();
            const cast = casts.find(c => c.castId === castId);
            if (cast) {
                cast.subCasts = cast.subCasts.filter(sc => sc.subCastId !== subCastId);
                saveCasts(casts);
                loadCastManagement();
            }
        }

        let userManagementListener = null; // Store the real-time listener

        async function loadUserManagement(statusFilter) {
            console.log('🔍 Loading User Management with filter:', statusFilter);
            const container = document.getElementById('users-list');
            
            // Set up real-time listener if Firestore is available
            if (db && !userManagementListener) {
                console.log('🔄 Setting up real-time listener for users...');
                userManagementListener = db.collection('users').onSnapshot((snapshot) => {
                    console.log('📡 Real-time update received!');
                    // Re-render the current filter when data changes
                    loadUserManagement(statusFilter);
                }, (error) => {
                    console.warn('⚠️ Real-time listener error:', error);
                });
            }
            
            let allUsers = await getAllUsers();
            
            console.log('📊 Total users in localStorage:', allUsers.length);
            console.log('👥 All users data:', allUsers);
            
            // Add current admin to the list if not already present
            const adminExists = allUsers.some(u => u.userId === currentUser.userId);
            if (!adminExists && currentUser) {
                allUsers.push({
                    userId: currentUser.userId,
                    displayName: currentUser.name,
                    email: currentUser.email,
                    mobileNumber: currentUser.mobileNumber,
                    profilePhoto: null, // Will be generated by CSS avatar
                    cast: currentUser.cast || 'N/A',
                    subCast: currentUser.subCast || 'N/A',
                    role: 'admin',
                    status: 'verified'
                });
            } else {
                // Ensure current user has admin role
                const currentUserData = allUsers.find(u => u.userId === currentUser.userId);
                if (currentUserData) {
                    currentUserData.role = 'admin';
                }
            }
            
            // Filter users by status
            let filteredUsers;
            if (statusFilter === 'all') {
                filteredUsers = allUsers;
            } else if (statusFilter === 'unverified') {
                // Show both 'pending' and 'unverified' users in Unverified tab
                filteredUsers = allUsers.filter(u => u.status === 'pending' || u.status === 'unverified');
            } else {
                filteredUsers = allUsers.filter(u => u.status === statusFilter);
            }
            
            console.log(`🔍 Filtered users for '${statusFilter}':`, filteredUsers.length);
            console.log('📋 Filtered users data:', filteredUsers);
            
            let html = `
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button onclick="loadUserManagement('all')" class="${statusFilter === 'all' ? 'bg-purple-600 text-white' : 'bg-gray-200'} px-4 py-2 rounded hover:bg-purple-700">
                        <i class="fas fa-users mr-2"></i>All Users
                    </button>
                    <button onclick="loadUserManagement('unverified')" class="${statusFilter === 'unverified' ? 'bg-yellow-600 text-white' : 'bg-gray-200'} px-4 py-2 rounded hover:bg-yellow-700">
                        <i class="fas fa-clock mr-2"></i>Unverified
                    </button>
                    <button onclick="loadUserManagement('verified')" class="${statusFilter === 'verified' ? 'bg-green-600 text-white' : 'bg-gray-200'} px-4 py-2 rounded hover:bg-green-700">
                        <i class="fas fa-check-circle mr-2"></i>Verified
                    </button>
                    <button onclick="loadUserManagement('blocked')" class="${statusFilter === 'blocked' ? 'bg-red-600 text-white' : 'bg-gray-200'} px-4 py-2 rounded hover:bg-red-700">
                        <i class="fas fa-ban mr-2"></i>Blocked
                    </button>
                </div>
                
                <div class="user-table-wrapper">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Mobile</th>
                                <th>Cast/Sub-Cast</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (filteredUsers.length === 0) {
                html += `
                    <tr>
                        <td colspan="9" class="text-center py-8 text-gray-500">
                            <i class="fas fa-users text-4xl mb-2"></i>
                            <p>No users found in this category</p>
                        </td>
                    </tr>
                `;
            } else {
                filteredUsers.forEach((user, index) => {
                    const isAdmin = user.role === 'admin' || user.userId === currentUser.userId;
                    const isSelf = user.userId === currentUser.userId;
                    
                    // Create display name with fallback logic
                    let displayName = user.displayName;
                    if (!displayName) {
                        if (user.firstName && user.lastName) {
                            displayName = `${user.firstName} ${user.lastName}`.trim();
                        } else if (user.firstName) {
                            displayName = user.firstName;
                        } else if (user.mobileNumber) {
                            displayName = `User ${user.mobileNumber}`;
                        } else {
                            displayName = 'Unknown User';
                        }
                    }
                    
                    // Generate avatar (CSS-based, no HTTP requests)
                    const initials = getUserInitials(displayName);
                    const avatarColor = getAvatarColor(displayName);
                    const avatarHTML = user.profilePhoto && !user.profilePhoto.includes('placeholder')
                        ? `<img src="${user.profilePhoto}" alt="${escapeHtml(displayName)}" class="user-avatar">`
                        : `<div class="avatar-circle" style="background: ${avatarColor}">${initials}</div>`;
                    
                    const castInfo = `${user.cast || 'N/A'} / ${user.subCast || 'N/A'}`;
                    
                    // Status badge
                    let statusBadge = '';
                    if (user.status === 'verified') {
                        statusBadge = '<span class="badge-verified">Verified</span>';
                    } else if (user.status === 'unverified') {
                        statusBadge = '<span class="badge-unverified">Unverified</span>';
                    } else if (user.status === 'blocked') {
                        statusBadge = '<span class="badge-blocked">Blocked</span>';
                    }
                    
                    // Role badge
                    const roleBadge = isAdmin 
                        ? '<span class="badge-admin"><i class="fas fa-crown mr-1"></i>Admin</span>' 
                        : '<span class="badge-member">Member</span>';
                    
                    // Actions
                    let actions = '';
                    if (isSelf) {
                        actions = '<span class="text-gray-400 text-sm">You</span>';
                    } else {
                        // For pending/unverified users: show Verify and Block buttons
                        if (user.status === 'pending' || user.status === 'unverified') {
                            actions += `<button onclick="changeUserStatus('${user.userId}', 'verified')" class="action-btn action-btn-verify"><i class="fas fa-check mr-1"></i>Verify</button>`;
                            actions += `<button onclick="changeUserStatus('${user.userId}', 'blocked')" class="action-btn action-btn-block"><i class="fas fa-ban mr-1"></i>Block</button>`;
                        }
                        // For verified users: show Unverify and Block buttons
                        else if (user.status === 'verified') {
                            actions += `<button onclick="changeUserStatus('${user.userId}', 'pending')" class="action-btn action-btn-unverify"><i class="fas fa-clock mr-1"></i>Unverify</button>`;
                            actions += `<button onclick="changeUserStatus('${user.userId}', 'blocked')" class="action-btn action-btn-block"><i class="fas fa-ban mr-1"></i>Block</button>`;
                        }
                        // For blocked users: show Unblock button only
                        else if (user.status === 'blocked') {
                            actions += `<button onclick="changeUserStatus('${user.userId}', 'verified')" class="action-btn action-btn-unblock"><i class="fas fa-unlock mr-1"></i>Unblock</button>`;
                        }
                    }
                    
                    html += `
                        <tr class="${isAdmin ? 'admin-row' : ''}">
                            <td>${index + 1}</td>
                            <td>${avatarHTML}</td>
                            <td><strong>${escapeHtml(displayName)}</strong></td>
                            <td>${escapeHtml(user.email || 'N/A')}</td>
                            <td>📱 ${user.mobileNumber || 'N/A'}</td>
                            <td>${castInfo}</td>
                            <td>${roleBadge}</td>
                            <td>${statusBadge}</td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-2"></i>Total Users: ${filteredUsers.length}
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function changeUserStatus(userId, newStatus) {
            // Prevent admin from blocking themselves
            if (userId === currentUser.userId) {
                alert('❌ You cannot change your own status as an admin!');
                return;
            }
            
            const users = await getAllUsers();
            const user = users.find(u => u.userId === userId);
            if (user) {
                const oldStatus = user.status;
                user.status = newStatus;
                user.updatedAt = new Date().toISOString();
                user.verifiedBy = currentUser.userId;
                
                // Use the new async saveUser function
                await saveUser(user);
                
                // Show success message with appropriate emoji and text
                let statusText = '';
                if (newStatus === 'verified') {
                    statusText = 'Verified ✅';
                } else if (newStatus === 'pending') {
                    statusText = 'Pending/Unverified ⏳';
                } else if (newStatus === 'unverified') {
                    statusText = 'Unverified ⏳';
                } else if (newStatus === 'blocked') {
                    statusText = 'Blocked 🚫';
                } else {
                    statusText = newStatus;
                }
                
                console.log(`🔄 Status changed: ${user.displayName || user.mobileNumber} (${oldStatus} → ${newStatus})`);
                alert(`✅ User status changed to: ${statusText}`);
                
                // Reload with 'all' filter to keep admin visible
                loadUserManagement('all');
            }
        }

        function loadAdminProfile() {
            if (!currentUser) return;
            
            document.getElementById('admin-profile-name').value = currentUser.displayName || '';
            document.getElementById('admin-profile-email').value = currentUser.email || '';
            document.getElementById('admin-profile-photo').value = currentUser.profilePhoto || '';
            document.getElementById('admin-profile-age').value = currentUser.age || '';
            document.getElementById('admin-profile-blood-group').value = currentUser.bloodGroup || '';
            document.getElementById('admin-profile-professional').value = currentUser.professional || '';
            
            loadAdminCastOptions();
            
            const form = document.getElementById('admin-profile-form');
            form.onsubmit = handleAdminProfileUpdate;
        }

        function loadAdminCastOptions() {
            const castSelect = document.getElementById('admin-profile-cast');
            if (!castSelect) return;
            
            const casts = getAllCasts();
            castSelect.innerHTML = '<option value="">Select</option>';
            
            casts.forEach(cast => {
                const option = document.createElement('option');
                option.value = cast.castName;
                option.textContent = cast.castName;
                if (currentUser.cast === cast.castName) option.selected = true;
                castSelect.appendChild(option);
            });
            
            castSelect.addEventListener('change', updateAdminSubCastOptions);
            updateAdminSubCastOptions();
        }

        function updateAdminSubCastOptions() {
            const castSelect = document.getElementById('admin-profile-cast');
            const subCastSelect = document.getElementById('admin-profile-sub-cast');
            
            if (!castSelect || !subCastSelect) return;
            
            const selectedCast = castSelect.value;
            subCastSelect.innerHTML = '<option value="">Select</option>';
            
            if (!selectedCast) return;
            
            const casts = getAllCasts();
            const cast = casts.find(c => c.castName === selectedCast);
            
            if (cast && cast.subCasts) {
                cast.subCasts.forEach(sc => {
                    const option = document.createElement('option');
                    option.value = sc.subCastName;
                    option.textContent = sc.subCastName;
                    if (currentUser.subCast === sc.subCastName) option.selected = true;
                    subCastSelect.appendChild(option);
                });
            }
        }

        function handleAdminProfileUpdate(e) {
            e.preventDefault();
            
            currentUser.displayName = document.getElementById('admin-profile-name').value.trim();
            currentUser.email = document.getElementById('admin-profile-email').value.trim();
            currentUser.profilePhoto = document.getElementById('admin-profile-photo').value.trim() || null;
            currentUser.age = document.getElementById('admin-profile-age').value.trim() ? parseInt(document.getElementById('admin-profile-age').value) : null;
            currentUser.bloodGroup = document.getElementById('admin-profile-blood-group').value || null;
            currentUser.cast = document.getElementById('admin-profile-cast').value || null;
            currentUser.subCast = document.getElementById('admin-profile-sub-cast').value || null;
            currentUser.professional = document.getElementById('admin-profile-professional').value.trim() || null;
            currentUser.updatedAt = new Date().toISOString();

            saveUser(currentUser);
            localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));

            alert('Profile updated!');
            showDashboard();
        }

        // ═══════════════════════════════════════════════════════════════
        // R2 MEDIA UPLOAD FUNCTIONS
        // ═══════════════════════════════════════════════════════════════
        
        /**
         * Upload file to Cloudflare R2 via Worker
         * @param {File} file - File object to upload
         * @returns {Promise<{success: boolean, publicUrl?: string, error?: string}>}
         */
        async function uploadToR2(file) {
            try {
                // Validate file size
                if (file.size > R2_CONFIG.MAX_FILE_SIZE) {
                    return {
                        success: false,
                        error: `File बहुत बड़ी है। Maximum size: ${R2_CONFIG.MAX_FILE_SIZE / (1024 * 1024)}MB`
                    };
                }
                
                // Validate file type
                const fileType = file.type;
                const isImage = R2_CONFIG.ALLOWED_TYPES.image.includes(fileType);
                const isVideo = R2_CONFIG.ALLOWED_TYPES.video.includes(fileType);
                
                if (!isImage && !isVideo) {
                    return {
                        success: false,
                        error: 'Invalid file type। केवल images और videos allowed हैं।'
                    };
                }
                
                console.log(`📤 Uploading to R2: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
                
                // Step 1: Get upload target from Worker
                const uploadTargetResponse = await fetch(`${R2_CONFIG.WORKER_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: file.name,
                        contentType: file.type
                    })
                });
                
                if (!uploadTargetResponse.ok) {
                    throw new Error(`Upload target failed: ${uploadTargetResponse.status}`);
                }
                
                const uploadTarget = await uploadTargetResponse.json();
                
                if (!uploadTarget.success || !uploadTarget.uploadUrl) {
                    throw new Error(uploadTarget.error || 'Failed to get upload URL');
                }
                
                console.log(`✅ Upload target received: ${uploadTarget.objectKey}`);
                
                // Step 2: Upload file to R2 via Worker
                const uploadResponse = await fetch(uploadTarget.uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': file.type
                    },
                    body: file
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`Upload failed: ${uploadResponse.status}`);
                }
                
                const uploadResult = await uploadResponse.json();
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'Upload failed');
                }
                
                console.log(`✅ File uploaded successfully: ${uploadTarget.publicUrl}`);
                
                return {
                    success: true,
                    publicUrl: uploadTarget.publicUrl,
                    objectKey: uploadTarget.objectKey
                };
                
            } catch (error) {
                console.error('❌ R2 Upload Error:', error);
                return {
                    success: false,
                    error: error.message || 'Upload failed'
                };
            }
        }
        
        /**
         * Convert Data URL to Blob for uploading
         */
        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }
        
        // ═══════════════════════════════════════════════════════════════
        // FIRESTORE BACKUP & RESTORE FUNCTIONS
        // ═══════════════════════════════════════════════════════════════
        
        /**
         * Backup all localStorage data to Firestore
         */
        async function backupToFirestore() {
            if (!db) {
                alert('❌ Firestore not initialized। Backup नहीं हो सकता।');
                return { success: false, error: 'Firestore not available' };
            }
            
            try {
                console.log('📦 Starting Firestore backup...');
                
                const backupData = {
                    users: getAllUsers(),
                    messages: JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || '[]'),
                    casts: getAllCasts(),
                    communities: JSON.parse(localStorage.getItem(STORAGE_KEYS.COMMUNITIES) || '[]'),
                    familyMembers: JSON.parse(localStorage.getItem(STORAGE_KEYS.FAMILY_MEMBERS) || '[]'),
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                // Create backup document with timestamp
                const backupId = 'backup_' + Date.now();
                await db.collection('backups').doc(backupId).set(backupData);
                
                // Also update "latest" backup for quick restore
                await db.collection('backups').doc('latest').set(backupData);
                
                console.log('✅ Firestore backup completed:', backupId);
                
                return {
                    success: true,
                    backupId,
                    stats: {
                        users: backupData.users.length,
                        messages: backupData.messages.length,
                        casts: backupData.casts.length
                    }
                };
                
            } catch (error) {
                console.error('❌ Firestore backup error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        /**
         * Restore data from Firestore to localStorage
         */
        async function restoreFromFirestore() {
            if (!db) {
                alert('❌ Firestore not initialized। Restore नहीं हो सकता।');
                return { success: false, error: 'Firestore not available' };
            }
            
            try {
                console.log('📥 Starting Firestore restore...');
                
                // Get latest backup
                const doc = await db.collection('backups').doc('latest').get();
                
                if (!doc.exists) {
                    throw new Error('No backup found in Firestore');
                }
                
                const backupData = doc.data();
                
                // Confirm before overwriting
                const confirm = window.confirm(
                    `⚠️ यह सारा local data replace कर देगा!\n\n` +
                    `Backup Date: ${new Date(backupData.timestamp).toLocaleString()}\n` +
                    `Users: ${backupData.users?.length || 0}\n` +
                    `Messages: ${backupData.messages?.length || 0}\n\n` +
                    `क्या आप restore करना चाहते हैं?`
                );
                
                if (!confirm) {
                    return { success: false, cancelled: true };
                }
                
                // Restore to localStorage
                if (backupData.users) {
                    localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(backupData.users));
                    
                    // Also restore to Firestore
                    console.log('🔄 Restoring users to Firestore...');
                    const batch = db.batch();
                    backupData.users.forEach(user => {
                        const userRef = db.collection('users').doc(user.userId);
                        batch.set(userRef, user);
                    });
                    await batch.commit();
                    console.log('✅ Users restored to Firestore');
                }
                if (backupData.messages) {
                    localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(backupData.messages));
                }
                if (backupData.casts) {
                    localStorage.setItem(STORAGE_KEYS.CASTS, JSON.stringify(backupData.casts));
                }
                if (backupData.communities) {
                    localStorage.setItem(STORAGE_KEYS.COMMUNITIES, JSON.stringify(backupData.communities));
                }
                if (backupData.familyMembers) {
                    localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(backupData.familyMembers));
                }
                
                console.log('✅ Firestore restore completed');
                
                // Reload page to reflect changes
                alert('✅ Data restored successfully! Page को reload किया जा रहा है...');
                window.location.reload();
                
                return {
                    success: true,
                    backupDate: backupData.timestamp,
                    stats: {
                        users: backupData.users?.length || 0,
                        messages: backupData.messages?.length || 0,
                        casts: backupData.casts?.length || 0
                    }
                };
                
            } catch (error) {
                console.error('❌ Firestore restore error:', error);
                alert('❌ Restore failed: ' + error.message);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        /**
         * Auto-backup on critical operations (called internally)
         */
        async function autoBackupFirestore() {
            if (!db) return;
            
            // Silent backup in background
            backupToFirestore()
                .then(result => {
                    if (result.success) {
                        console.log('🔄 Auto-backup completed');
                    }
                })
                .catch(err => {
                    console.warn('⚠️ Auto-backup failed (non-critical):', err.message);
                });
        }
        
        // ═══════════════════════════════════════════════════════════════
        // AVATAR & IMAGE HELPERS
        // ═══════════════════════════════════════════════════════════════
        
        /**
         * Get user initials for avatar
         */
        function getUserInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length === 1) {
                return parts[0].substring(0, 2).toUpperCase();
            }
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        
        /**
         * Get color for avatar based on name
         */
        function getAvatarColor(name) {
            const colors = [
                '#3B82F6', // blue
                '#10B981', // green
                '#F59E0B', // yellow
                '#EF4444', // red
                '#8B5CF6', // purple
                '#EC4899', // pink
                '#06B6D4', // cyan
                '#F97316'  // orange
            ];
            
            if (!name) return colors[0];
            
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }
        
        /**
         * Generate data URL for avatar with initials
         */
        function generateAvatarDataURL(name, size = 48) {
            const initials = getUserInitials(name);
            const color = getAvatarColor(name);
            
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            // Draw circle background
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw initials
            ctx.fillStyle = '#FFFFFF';
            ctx.font = `bold ${size / 2.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initials, size / 2, size / 2);
            
            return canvas.toDataURL();
        }
        
        /**
         * Get user avatar URL (real photo or generated initials)
         */
        function getUserAvatarURL(user, size = 48) {
            // If user has a real photo from R2, use it
            if (user.profilePhoto && !user.profilePhoto.includes('placeholder')) {
                return user.profilePhoto;
            }
            
            // Otherwise generate initials-based avatar
            const name = user.displayName || user.firstName || 'User';
            return generateAvatarDataURL(name, size);
        }
        
        // ═══════════════════════════════════════════════════════════════
        // LocalStorage Operations
        // ═══════════════════════════════════════════════════════════════
        
        async function getAllUsers(localStorageOnly = false) {
            try {
                // If localStorageOnly mode (for registration), skip Firestore and use localStorage immediately
                if (localStorageOnly) {
                    console.log('⚡ Fast mode: Using localStorage only (registration mode)');
                    return JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');
                }
                
                // Try to fetch from Firestore first (real-time data) with timeout
                if (db) {
                    console.log('🔄 Fetching users from Firestore...');
                    
                    // Create a timeout promise (3 seconds for fetching)
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Firestore fetch timeout')), 3000)
                    );
                    
                    try {
                        // Race between Firestore fetch and timeout
                        const snapshot = await Promise.race([
                            db.collection('users').get(),
                            timeoutPromise
                        ]);
                        
                        const firestoreUsers = [];
                        
                        snapshot.forEach(doc => {
                            const userData = doc.data();
                            userData.userId = doc.id; // Ensure userId is set
                            firestoreUsers.push(userData);
                        });
                        
                        console.log('✅ Fetched users from Firestore:', firestoreUsers.length);
                        
                        // Sync Firestore data to localStorage for offline support
                        localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(firestoreUsers));
                        
                        return firestoreUsers;
                    } catch (firestoreError) {
                        console.warn('⚠️ Firestore fetch failed or timed out, using localStorage:', firestoreError.message);
                        return JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');
                    }
                } else {
                    console.log('⚠️ Firestore not available, using localStorage fallback');
                    return JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');
                }
            } catch (error) {
                console.warn('⚠️ Error in getAllUsers, using localStorage:', error.message);
                return JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');
            }
        }

        async function saveUser(user) {
            try {
                // Get current users list from localStorage only (fast mode for saving)
                let users = await getAllUsers(true);
                const index = users.findIndex(u => u.userId === user.userId);
                if (index >= 0) users[index] = user;
                else users.push(user);
                
                // Save to localStorage (immediate local update - PRIMARY)
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
                console.log('✅ Saved to localStorage:', user.displayName || user.firstName);
                
                // Save to Firestore with timeout (real-time sync - OPTIONAL)
                if (db) {
                    try {
                        // Create a timeout promise (5 seconds)
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Firestore timeout')), 5000)
                        );
                        
                        // Race between Firestore save and timeout
                        await Promise.race([
                            db.collection('users').doc(user.userId).set(user),
                            timeoutPromise
                        ]);
                        
                        console.log('✅ Saved to Firestore:', user.displayName || user.firstName);
                    } catch (firestoreError) {
                        console.warn('⚠️ Firestore save failed or timed out (localStorage is primary):', firestoreError.message);
                        // Don't throw error - localStorage is primary, continue anyway
                    }
                }
                
                // Always return success if localStorage worked
                return true;
            } catch (error) {
                console.error('❌ Error saving user:', error);
                throw error;
            }
        }

        function getAllMessages() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || '[]');
        }

        function saveMessage(msg) {
            let messages = getAllMessages();
            messages.push(msg);
            localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messages));
        }

        function getAllCasts() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.CASTS) || '[]');
        }

        function saveCasts(casts) {
            localStorage.setItem(STORAGE_KEYS.CASTS, JSON.stringify(casts));
        }

        function getAllFamilyMembers() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.FAMILY_MEMBERS) || '[]');
        }

        function saveFamilyMember(member) {
            let members = getAllFamilyMembers();
            members.push(member);
            localStorage.setItem(STORAGE_KEYS.FAMILY_MEMBERS, JSON.stringify(members));
        }

        function getAllCommunities() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.COMMUNITIES) || '[]');
        }

        // Avatar Helper Functions
        function getUserInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function getAvatarColor(name) {
            if (!name) return '#6B7280';
            const colors = [
                '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6366F1',
                '#8B5CF6', '#EC4899', '#14B8A6', '#F97316', '#84CC16'
            ];
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function generateAvatarDataURL(name, size = 48) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = getAvatarColor(name);
            ctx.fillRect(0, 0, size, size);
            
            ctx.fillStyle = '#FFFFFF';
            ctx.font = `bold ${size / 2}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(getUserInitials(name), size / 2, size / 2);
            
            return canvas.toDataURL();
        }

        function getUserAvatarURL(user, size = 48) {
            if (user.profilePhoto && !user.profilePhoto.includes('placeholder')) {
                return user.profilePhoto;
            }
            const displayName = user.displayName || user.name || user.fullName || 'User';
            return generateAvatarDataURL(displayName, size);
        }

        function loadCastOptions() {
            const castSelect = document.getElementById('profile-cast');
            if (!castSelect) return;
            const casts = getAllCasts();
            castSelect.innerHTML = '<option value="">Select</option>';
            casts.forEach(cast => {
                const option = document.createElement('option');
                option.value = cast.castName;
                option.textContent = cast.castName;
                castSelect.appendChild(option);
            });
        }

        function updateSubCastOptions() {
            const castSelect = document.getElementById('profile-cast');
            const subCastSelect = document.getElementById('profile-sub-cast');
            if (!castSelect || !subCastSelect) return;
            
            const selectedCast = castSelect.value;
            subCastSelect.innerHTML = '<option value="">Select</option>';
            
            if (!selectedCast) return;
            
            const casts = getAllCasts();
            const cast = casts.find(c => c.castName === selectedCast);
            if (cast && cast.subCasts) {
                cast.subCasts.forEach(sc => {
                    const option = document.createElement('option');
                    option.value = sc.subCastName;
                    option.textContent = sc.subCastName;
                    subCastSelect.appendChild(option);
                });
            }
        }

        // Password Security Functions
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('login-password');
            const toggleIcon = document.getElementById('password-toggle-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleIcon.textContent = '👁️';
            }
        }

        // Firebase Phone Authentication Functions
        function initializeRecaptcha() {
            if (!recaptchaVerifier) {
                try {
                    recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        'size': 'invisible',
                        'callback': (response) => {
                            console.log('✅ reCAPTCHA verified');
                        },
                        'expired-callback': () => {
                            console.warn('⚠️ reCAPTCHA expired');
                            recaptchaVerifier = null;
                        }
                    });
                    console.log('✅ reCAPTCHA initialized');
                } catch (error) {
                    console.error('❌ reCAPTCHA initialization error:', error);
                }
            }
            return recaptchaVerifier;
        }
        
        async function sendFirebaseOTP(mobileNumber) {
            if (OTP_CONFIG.DEMO_MODE) {
                console.log('🔐 DEMO MODE: OTP would be sent to', mobileNumber);
                const demoOTP = generateSecureOTP();
                storeOTPData(mobileNumber, demoOTP);
                return { success: true, message: 'Demo OTP generated', demoOTP: demoOTP };
            }
            
            if (!OTP_CONFIG.USE_FIREBASE_PHONE_AUTH) {
                return { success: false, message: 'Firebase Phone Auth not enabled' };
            }
            
            try {
                // Initialize reCAPTCHA
                const appVerifier = initializeRecaptcha();
                
                if (!appVerifier) {
                    throw new Error('reCAPTCHA initialization failed');
                }
                
                // Format phone number with country code
                const phoneNumber = '+91' + mobileNumber;
                console.log('📱 Sending OTP to:', phoneNumber);
                
                // Send OTP using Firebase
                const confirmResult = await firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier);
                
                // Store confirmation result globally
                confirmationResult = confirmResult;
                
                console.log('✅ Firebase OTP sent successfully to', mobileNumber);
                return { 
                    success: true, 
                    message: 'OTP sent successfully via Firebase',
                    confirmationResult: confirmResult
                };
                
            } catch (error) {
                console.error('❌ Firebase OTP sending error:', error);
                
                // Handle specific errors
                let errorMessage = 'Failed to send OTP';
                if (error.code === 'auth/invalid-phone-number') {
                    errorMessage = 'Invalid phone number format';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many requests. Please try again later.';
                } else if (error.code === 'auth/quota-exceeded') {
                    errorMessage = 'SMS quota exceeded. Please try again tomorrow.';
                }
                
                // Reset reCAPTCHA on error
                recaptchaVerifier = null;
                
                return { success: false, message: errorMessage, error: error };
            }
        }
        
        async function verifyFirebaseOTP(otp) {
            if (OTP_CONFIG.DEMO_MODE) {
                // Demo mode verification
                const mobileNumber = currentRegistrationData.mobileNumber;
                const otpData = getOTPData(mobileNumber);
                
                if (!otpData) {
                    return { success: false, message: 'OTP data not found' };
                }
                
                if (otp === otpData.otp) {
                    markOTPVerified(mobileNumber);
                    return { success: true, message: 'OTP verified (demo mode)' };
                } else {
                    incrementOTPAttempts(mobileNumber);
                    return { success: false, message: 'Invalid OTP' };
                }
            }
            
            if (!confirmationResult) {
                return { success: false, message: 'No confirmation result found. Please resend OTP.' };
            }
            
            try {
                console.log('🔍 Verifying OTP...');
                
                // Verify OTP with Firebase
                const result = await confirmationResult.confirm(otp);
                
                console.log('✅ Firebase OTP verified successfully');
                console.log('User:', result.user);
                
                // Sign out immediately (we just need verification, not authentication)
                await firebase.auth().signOut();
                
                return { 
                    success: true, 
                    message: 'OTP verified successfully',
                    user: result.user
                };
                
            } catch (error) {
                console.error('❌ Firebase OTP verification error:', error);
                
                let errorMessage = 'Invalid OTP';
                if (error.code === 'auth/invalid-verification-code') {
                    errorMessage = 'Invalid OTP. Please try again.';
                } else if (error.code === 'auth/code-expired') {
                    errorMessage = 'OTP expired. Please request a new one.';
                }
                
                return { success: false, message: errorMessage, error: error };
            }
        }
        
        function generateSecureOTP() {
            // Generate cryptographically secure OTP
            const array = new Uint8Array(OTP_CONFIG.OTP_LENGTH);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte % 10).join('');
        }
        
        function storeOTPData(mobileNumber, otp) {
            const otpData = {
                mobileNumber: mobileNumber,
                otp: otp,
                timestamp: Date.now(),
                attempts: 0,
                verified: false
            };
            
            localStorage.setItem('nagori_adda_otp_' + mobileNumber, JSON.stringify(otpData));
            console.log('💾 OTP data stored for', mobileNumber);
        }
        
        function getOTPData(mobileNumber) {
            const data = localStorage.getItem('nagori_adda_otp_' + mobileNumber);
            return data ? JSON.parse(data) : null;
        }
        
        function isOTPExpired(timestamp) {
            const expiryTime = timestamp + (OTP_CONFIG.OTP_EXPIRY_MINUTES * 60 * 1000);
            return Date.now() > expiryTime;
        }
        
        function incrementOTPAttempts(mobileNumber) {
            const otpData = getOTPData(mobileNumber);
            if (otpData) {
                otpData.attempts++;
                localStorage.setItem('nagori_adda_otp_' + mobileNumber, JSON.stringify(otpData));
            }
        }
        
        function markOTPVerified(mobileNumber) {
            const otpData = getOTPData(mobileNumber);
            if (otpData) {
                otpData.verified = true;
                localStorage.setItem('nagori_adda_otp_' + mobileNumber, JSON.stringify(otpData));
            }
        }

        // Registration System Functions
        let currentRegistrationData = {};
        let currentOTP = null;
        let resendTimer = null;

        // Clean duplicate users (keep only admin)
        async function cleanDuplicateUsers() {
            try {
                const users = await getAllUsers();
                console.log('🧹 Cleaning duplicates... Current users:', users.length);
                
                // Keep only admin user (9352525595)
                const cleanUsers = users.filter(u => u.mobileNumber === ADMIN_MOBILE);
                
                console.log('✅ Cleaned users. Keeping:', cleanUsers.length, 'Removed:', users.length - cleanUsers.length);
                
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(cleanUsers));
                
                return cleanUsers.length;
            } catch (error) {
                console.error('Error cleaning duplicates:', error);
                return -1;
            }
        }

        function showRegistrationScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('registration-screen').classList.remove('hidden');
            loadCastsForRegistration();
        }

        function showLoginScreen() {
            document.getElementById('registration-screen').classList.add('hidden');
            document.getElementById('otp-screen').classList.add('hidden');
            document.getElementById('password-creation-screen').classList.add('hidden');
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function loadCastsForRegistration() {
            const castSelect = document.getElementById('reg-cast');
            const casts = getAllCasts(); // ✅ Fixed: Changed from getStoredCasts() to getAllCasts()
            
            castSelect.innerHTML = '<option value="">Select Cast</option>';
            
            if (!casts || casts.length === 0) {
                console.warn('⚠️ No casts found in storage');
                return;
            }
            
            casts.forEach(cast => {
                const option = document.createElement('option');
                option.value = cast.castName;
                option.textContent = cast.castName;
                castSelect.appendChild(option);
            });
            
            console.log(`✅ Loaded ${casts.length} casts for registration`);
        }

        function updateRegSubCastOptions() {
            const castSelect = document.getElementById('reg-cast');
            const subCastSelect = document.getElementById('reg-subcast');
            const selectedCast = castSelect.value;
            
            subCastSelect.innerHTML = '<option value="">Select Sub-cast</option>';
            
            if (!selectedCast) return;
            
            const casts = getAllCasts(); // ✅ Fixed: Changed from getStoredCasts() to getAllCasts()
            const cast = casts.find(c => c.castName === selectedCast);
            
            if (cast && cast.subCasts) {
                cast.subCasts.forEach(sc => {
                    const option = document.createElement('option');
                    option.value = sc.subCastName;
                    option.textContent = sc.subCastName;
                    subCastSelect.appendChild(option);
                });
            }
        }

        async function handleRegistration(e) {
            console.log('📝 Registration form submitted');
            e.preventDefault();
            
            const firstName = document.getElementById('reg-firstname').value.trim();
            const lastName = document.getElementById('reg-lastname').value.trim();
            const cast = document.getElementById('reg-cast').value;
            const subCast = document.getElementById('reg-subcast').value;
            const mobile = document.getElementById('reg-mobile').value.trim();
            
            // Validate
            if (!firstName || !lastName || !cast || !subCast || !mobile) {
                alert('❌ सभी fields भरना जरूरी है');
                return;
            }
            
            if (mobile.length !== 10) {
                alert('❌ 10 अंकों का mobile number चाहिए');
                return;
            }
            
            // Check if mobile already registered
            const users = await getAllUsers();
            if (users.find(u => u.mobileNumber === mobile)) {
                alert('❌ यह mobile number पहले से registered है');
                return;
            }
            
            // Store registration data
            currentRegistrationData = {
                firstName,
                lastName,
                cast,
                subCast,
                mobileNumber: mobile,
                status: 'pending',
                role: 'member',
                registeredAt: Date.now()
            };
            
            // Generate and show OTP
            generateAndShowOTP();
        }

        async function generateAndShowOTP() {
            console.log('🔐 Generating OTP for:', currentRegistrationData.mobileNumber);
            
            // Show OTP screen first
            document.getElementById('registration-screen').classList.add('hidden');
            document.getElementById('otp-screen').classList.remove('hidden');
            
            // Display mobile number
            document.getElementById('otp-mobile-display').textContent = 
                `+91 ${currentRegistrationData.mobileNumber}`;
            
            // Send Firebase OTP
            const sendResult = await sendFirebaseOTP(currentRegistrationData.mobileNumber);
            
            if (!sendResult.success) {
                alert('❌ OTP sending failed: ' + sendResult.message);
                // Go back to registration screen
                document.getElementById('otp-screen').classList.add('hidden');
                document.getElementById('registration-screen').classList.remove('hidden');
                return;
            }
            
            // Show demo OTP (for testing) - only in demo mode
            if (OTP_CONFIG.DEMO_MODE && sendResult.demoOTP) {
                currentOTP = sendResult.demoOTP;
                document.getElementById('demo-otp-value').textContent = sendResult.demoOTP;
                document.getElementById('demo-otp-section').style.display = 'block';
                console.log('🔐 Demo OTP:', sendResult.demoOTP);
            } else {
                document.getElementById('demo-otp-section').style.display = 'none';
                console.log('📱 Real SMS sent via Firebase');
            }
            
            // Clear OTP inputs
            document.querySelectorAll('.otp-input').forEach(input => input.value = '');
            document.querySelectorAll('.otp-input')[0].focus();
            
            // Start resend timer
            startResendTimer();
        }

        function moveToNext(input, index) {
            if (input.value.length === 1 && index < 5) {
                document.querySelectorAll('.otp-input')[index + 1].focus();
            }
        }

        async function verifyOTPSubmit() {
            const otpInputs = document.querySelectorAll('.otp-input');
            const enteredOTP = Array.from(otpInputs).map(input => input.value).join('');
            
            if (enteredOTP.length !== OTP_CONFIG.OTP_LENGTH) {
                alert(`❌ ${OTP_CONFIG.OTP_LENGTH}-digit OTP enter करें`);
                return;
            }
            
            console.log('🔍 Verifying OTP:', enteredOTP);
            
            // Verify using Firebase
            const verifyResult = await verifyFirebaseOTP(enteredOTP);
            
            if (verifyResult.success) {
                console.log('✅ OTP verified successfully');
                showPasswordCreationScreen();
            } else {
                alert(`❌ ${verifyResult.message}`);
                
                // Clear inputs
                otpInputs.forEach(input => input.value = '');
                otpInputs[0].focus();
            }
        }

        function resendOTP() {
            generateAndShowOTP();
            alert('✅ New OTP sent!');
        }

        function startResendTimer() {
            let seconds = 60;
            const resendBtn = document.getElementById('resend-otp-btn');
            const timerSpan = document.getElementById('resend-timer');
            
            resendBtn.disabled = true;
            
            if (resendTimer) clearInterval(resendTimer);
            
            resendTimer = setInterval(() => {
                seconds--;
                timerSpan.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(resendTimer);
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = '🔄 Resend OTP';
                }
            }, 1000);
        }

        function showPasswordCreationScreen() {
            document.getElementById('otp-screen').classList.add('hidden');
            document.getElementById('password-creation-screen').classList.remove('hidden');
            
            // Clear password fields
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('password-strength').innerHTML = '';
            document.getElementById('password-match-msg').innerHTML = '';
        }

        async function handlePasswordCreation(e) {
            console.log('🔐 Password creation form submitted');
            e.preventDefault();
            
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            console.log('📝 Password length:', password.length);
            console.log('📝 Confirm password length:', confirmPassword.length);
            
            if (password !== confirmPassword) {
                alert('❌ Passwords match नहीं हो रहे!');
                return;
            }
            
            if (!validatePasswordStrength(password)) {
                alert('❌ Password सभी requirements पूरी करना चाहिए');
                return;
            }
            
            console.log('✅ Password validation passed, creating account...');
            
            // Disable button to prevent multiple submissions
            const submitBtn = e.target.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '⏳ Saving... Please wait';
                console.log('🔒 Button disabled and text updated');
            }
            
            try {
                // Hash password and create account
                console.log('🔐 Hashing password...');
                const passwordHash = await hashPassword(password);
                console.log('✅ Password hashed successfully');
                
                console.log('👤 Creating user account...');
                await createUserAccount(passwordHash);
                
                console.log('🎉 Account creation process completed!');
                
            } catch (error) {
                console.error('❌ Error in password creation:', error);
                console.error('❌ Error details:', error.message);
                console.error('❌ Error stack:', error.stack);
                
                alert('❌ Error creating account: ' + error.message);
                
                // Re-enable button on error
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '💾 Save Password & Complete Registration';
                    console.log('🔓 Button re-enabled after error');
                }
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('new-password').value;
            const strengthDiv = document.getElementById('password-strength');
            
            const hasLength = password.length >= 8;
            const hasUpper = /[A-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*]/.test(password);
            
            // Update requirement indicators
            updateRequirement('req-length', hasLength);
            updateRequirement('req-upper', hasUpper);
            updateRequirement('req-number', hasNumber);
            updateRequirement('req-special', hasSpecial);
            
            const strength = [hasLength, hasUpper, hasNumber, hasSpecial].filter(Boolean).length;
            
            let strengthText = '';
            let strengthColor = '';
            
            if (strength === 0) {
                strengthText = '';
            } else if (strength <= 2) {
                strengthText = '🔴 Weak';
                strengthColor = 'text-red-600';
            } else if (strength === 3) {
                strengthText = '🟡 Medium';
                strengthColor = 'text-yellow-600';
            } else {
                strengthText = '🟢 Strong';
                strengthColor = 'text-green-600';
            }
            
            strengthDiv.innerHTML = strengthText ? 
                `<span class="text-sm font-semibold ${strengthColor}">${strengthText}</span>` : '';
        }

        function updateRequirement(id, met) {
            const el = document.getElementById(id);
            if (el) {
                const icon = el.querySelector('.req-icon');
                if (met) {
                    icon.textContent = '✅';
                    el.classList.add('text-green-600');
                    el.classList.remove('text-blue-800');
                } else {
                    icon.textContent = '⭕';
                    el.classList.remove('text-green-600');
                    el.classList.add('text-blue-800');
                }
            }
        }

        function checkPasswordMatch() {
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const matchMsg = document.getElementById('password-match-msg');
            
            if (confirmPassword === '') {
                matchMsg.innerHTML = '';
                return;
            }
            
            if (password === confirmPassword) {
                matchMsg.innerHTML = '<span class="text-green-600">✅ Passwords match</span>';
            } else {
                matchMsg.innerHTML = '<span class="text-red-600">❌ Passwords do not match</span>';
            }
        }

        function validatePasswordStrength(password) {
            return password.length >= 8 &&
                   /[A-Z]/.test(password) &&
                   /[0-9]/.test(password) &&
                   /[!@#$%^&*]/.test(password);
        }

        function togglePasswordField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field.type === 'password') {
                field.type = 'text';
            } else {
                field.type = 'password';
            }
        }

        async function createUserAccount(passwordHash) {
            console.log('📥 Creating user account...');
            console.log('📋 Current registration data:', currentRegistrationData);
            
            let registrationSuccessful = false;
            
            try {
                // Check for duplicates FIRST using localStorage only (FAST MODE for registration)
                console.log('🔍 Checking for duplicate users (fast mode)...');
                const users = await getAllUsers(true); // Pass true for localStorage-only mode
                console.log('📊 Total existing users:', users.length);
                
                const existingUser = users.find(u => u.mobileNumber === currentRegistrationData.mobileNumber);
                
                if (existingUser) {
                    console.warn('⚠️ User already exists!', existingUser);
                    alert('❌ यह mobile number पहले से registered है!\nPlease login instead.');
                    showLoginScreen();
                    return; // Early return, don't show waiting screen
                }
                
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                console.log('🆔 Generated userId:', userId);
                
                const userData = {
                    ...currentRegistrationData,
                    userId,
                    passwordHash,
                    displayName: `${currentRegistrationData.firstName} ${currentRegistrationData.lastName}`.trim(),
                    status: 'pending',
                    role: 'member',
                    verifiedAt: null,
                    verifiedBy: null,
                    createdAt: new Date().toISOString()
                };
                
                console.log('💾 Saving user...', {
                    name: userData.displayName,
                    mobile: userData.mobileNumber,
                    userId: userData.userId
                });
                
                // Use the new async saveUser function (saves to both localStorage and Firestore)
                const saveResult = await saveUser(userData);
                
                console.log('✅ User saved successfully:', {
                    name: userData.displayName,
                    mobile: userData.mobileNumber,
                    status: userData.status,
                    userId: userData.userId,
                    saveResult: saveResult
                });
                
                // Mark as successful
                registrationSuccessful = true;
                
                console.log('✅ Registration process completed!');
                
            } catch (error) {
                console.error('❌ Error creating user:', error);
                console.error('Error stack:', error.stack);
                alert('❌ Registration error: ' + error.message);
                throw error; // Re-throw to trigger button re-enable
            } finally {
                // ALWAYS show waiting screen if registration was successful
                if (registrationSuccessful) {
                    console.log('⏳ Showing waiting screen...');
                    showWaitingScreen();
                } else {
                    console.warn('⚠️ Registration not successful, not showing waiting screen');
                }
            }
        }

        function showWaitingScreen() {
            document.getElementById('password-creation-screen').classList.add('hidden');
            document.getElementById('waiting-screen').classList.remove('hidden');
        }

        // Debug utility function
        async function debugUsers() {
            console.log('🔍 DEBUG: Checking all users in localStorage...');
            const users = await getAllUsers();
            console.log('📊 Total users:', users.length);
            users.forEach((user, index) => {
                console.log(`👤 User ${index + 1}:`, {
                    name: user.displayName || `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'No Name',
                    mobile: user.mobileNumber,
                    status: user.status,
                    userId: user.userId,
                    hasDisplayName: !!user.displayName,
                    hasFirstName: !!user.firstName,
                    hasLastName: !!user.lastName
                });
            });
            
            // Check for Mohammed Muzammil specifically
            const mohammed = users.find(u => 
                u.mobileNumber === '8094005595' || 
                (u.firstName && u.firstName.toLowerCase().includes('mohammed')) ||
                (u.displayName && u.displayName.toLowerCase().includes('mohammed'))
            );
            
            if (mohammed) {
                console.log('✅ Found Mohammed Muzammil:', mohammed);
            } else {
                console.log('❌ Mohammed Muzammil not found in users list');
            }
            
            return users;
        }
        
        // Make debug function available globally for testing
        window.debugUsers = debugUsers;

        // Utility Functions
        function getStatusText(status) {
            const map = {
                'unverified': '⏳ Unverified',
                'verified': '✅ Verified',
                'active': '✔️ Active',
                'blocked': '🚫 Blocked'
            };
            return map[status] || status;
        }

        function getStatusColor(status) {
            const map = {
                'unverified': 'bg-yellow-200 text-yellow-800',
                'verified': 'bg-green-200 text-green-800',
                'active': 'bg-blue-200 text-blue-800',
                'blocked': 'bg-red-200 text-red-800'
            };
            return map[status] || 'bg-gray-200 text-gray-800';
        }

        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'अभी';
            if (minutes < 60) return `${minutes} min ago`;
            const hours = Math.floor(diff / 3600000);
            if (hours < 24) return `${hours}h ago`;
            return date.toLocaleDateString('hi-IN');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        // Global exports
        window.exitAdminMode = exitAdminMode;
        window.showAdminTab = showAdminTab;
        window.loadUserManagement = loadUserManagement;
        window.changeUserStatus = changeUserStatus;
        window.addCast = addCast;
        window.addSubCast = addSubCast;
        window.deleteCast = deleteCast;
        window.deleteSubCast = deleteSubCast;
        window.showMemberOptions = showMemberOptions;
        window.closeMemberOptions = closeMemberOptions;
        window.showAddRelativeModal = showAddRelativeModal;
        window.closeSelectRelation = closeSelectRelation;
        window.selectRelation = selectRelation;
        window.proceedWithRelation = proceedWithRelation;
        window.closeAddMemberForm = closeAddMemberForm;
        window.deleteMemberFromTree = deleteMemberFromTree;
        window.searchFamilyMembers = searchFamilyMembers;
        window.printFamilyTree = printFamilyTree;
        window.updateTreeSubCastFilter = updateTreeSubCastFilter;
        window.loadTreeCastFilters = loadTreeCastFilters;
        
        // WhatsApp Chat Integration
        // Global Variables for WhatsApp Chat
        let currentChatIdWA = null;
        let currentTabWA = 'chats';
        let replyingToMessageWA = null;
        let mediaRecorderWA = null;
        let audioChunksWA = [];
        let isRecordingWA = false;
        let recordingTimerWA = null;
        let recordingDurationWA = 0;
        
        function loadWhatsAppChat() {
            const container = document.getElementById('whatsapp-chat-container');
            
            // Create complete WhatsApp chat HTML structure with all features
            container.innerHTML = `
                <div id="app-container-wa" class="h-screen flex flex-col">
                    <!-- Header -->
                    <div class="whatsapp-green p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <button onclick="closeWhatsAppChat()" class="hover:bg-green-700 p-2 rounded-full">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h1 class="text-xl font-bold">💬 Nagori Adda Chat</h1>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openSearchWA()" class="hover:bg-green-700 p-2 rounded-full">
                                <i class="fas fa-search"></i>
                            </button>
                            <button onclick="openMenuWA()" class="hover:bg-green-700 p-2 rounded-full">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="whatsapp-dark flex">
                        <button id="chats-tab-wa" onclick="showTabWA('chats')" class="flex-1 py-4 text-center tab-active">
                            <i class="fas fa-comments mr-2"></i>CHATS
                        </button>
                        <button id="updates-tab-wa" onclick="showTabWA('updates')" class="flex-1 py-4 text-center">
                            <i class="fas fa-circle mr-2"></i>UPDATES
                        </button>
                        <button id="communities-tab-wa" onclick="showTabWA('communities')" class="flex-1 py-4 text-center">
                            <i class="fas fa-users mr-2"></i>COMMUNITIES
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="flex-1 overflow-hidden">
                        <!-- CHATS Tab -->
                        <div id="chats-content-wa" class="h-full flex flex-col">
                            <div id="chat-list-wa" class="flex-1 overflow-y-auto">
                                <div id="all-chats-wa">
                                    <!-- Chat items will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- UPDATES Tab -->
                        <div id="updates-content-wa" class="h-full flex-col hidden">
                            <div id="status-list-wa" class="flex-1 overflow-y-auto p-4">
                                <!-- My Status -->
                                <div onclick="openAddStatusModalWA()" class="flex items-center gap-4 mb-6 cursor-pointer hover:bg-whatsapp-light p-3 rounded-lg">
                                    <div class="status-ring">
                                        <img id="my-status-photo-wa" src="" alt="My Status" class="w-12 h-12 rounded-full">
                                    </div>
                                    <div>
                                        <h3 class="font-semibold">My Status</h3>
                                        <p class="text-sm text-gray-400">Tap to add status update</p>
                                    </div>
                                </div>
                                
                                <!-- Recent Updates -->
                                <div class="mb-4">
                                    <h4 class="text-sm text-gray-400 mb-3">Recent updates</h4>
                                    <div id="recent-statuses-wa">
                                        <!-- Status items will be added here -->
                                    </div>
                                </div>
                                
                                <!-- Viewed Updates -->
                                <div>
                                    <h4 class="text-sm text-gray-400 mb-3">Viewed updates</h4>
                                    <div id="viewed-statuses-wa">
                                        <!-- Status items will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- COMMUNITIES Tab -->
                        <div id="communities-content-wa" class="h-full flex-col hidden">
                            <div id="communities-list-wa" class="flex-1 overflow-y-auto p-4">
                                <button onclick="createCommunityWA()" class="w-full bg-whatsapp-light hover:bg-whatsapp-dark p-4 rounded-lg mb-4 flex items-center gap-3">
                                    <div class="w-12 h-12 bg-whatsapp-green rounded-full flex items-center justify-center">
                                        <i class="fas fa-plus text-white"></i>
                                    </div>
                                    <div class="text-left">
                                        <h3 class="font-semibold">New Community</h3>
                                        <p class="text-sm text-gray-400">Create a community</p>
                                    </div>
                                </button>
                                <div id="my-communities-wa">
                                    <!-- Community items will be added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Individual Chat Screen -->
                        <div id="chat-screen-wa" class="h-full flex-col hidden">
                            <!-- Chat Header -->
                            <div class="whatsapp-dark p-4 flex items-center gap-3">
                                <button onclick="showChatListWA()" class="hover:bg-whatsapp-light p-2 rounded-full">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <img id="chat-user-photo-wa" src="" alt="User" class="w-10 h-10 rounded-full">
                                <div class="flex-1">
                                    <h3 id="chat-user-name-wa" class="font-semibold">User Name</h3>
                                    <p id="chat-user-status-wa" class="text-sm text-gray-400">Online</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="openChatInfoWA()" class="hover:bg-whatsapp-light p-2 rounded-full">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Messages Container -->
                            <div id="messages-container-wa" class="flex-1 overflow-y-auto p-4 space-y-2">
                                <!-- Messages will be dynamically added here -->
                            </div>
                            
                            <!-- Message Input -->
                            <div class="whatsapp-dark p-4">
                                <div class="flex items-center gap-2">
                                    <button onclick="attachMediaWA()" class="hover:bg-whatsapp-light p-2 rounded-full">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <div class="flex-1 relative">
                                        <input type="text" id="message-input-wa" placeholder="Type a message" 
                                               class="w-full bg-whatsapp-light text-black px-4 py-3 rounded-full outline-none"
                                               onkeypress="handleKeyPressWA(event)">
                                        <button onclick="recordVoiceWA()" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                            <i class="fas fa-microphone text-gray-400"></i>
                                        </button>
                                    </div>
                                    <button onclick="sendMessageWA()" class="whatsapp-green hover:bg-green-600 p-3 rounded-full">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Floating Action Button -->
                    <button id="fab-wa" onclick="fabActionWA()" class="floating-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- Hidden file input for media upload -->
                <input type="file" id="media-input-wa" accept="image/*,video/*" style="display: none;" onchange="handleMediaSelectWA(event)">
            `;
            
            // Initialize WhatsApp Chat
            initializeAppWA();
            console.log('✅ WhatsApp Chat loaded successfully');
        }
        
        function initializeAppWA() {
            console.log('🚀 Initializing WhatsApp-style chat app...');
            
            // Use existing currentUser from main app
            if (!currentUser) {
                // Fallback to demo user
                currentUser = {
                    userId: 'demo_user_123',
                    name: 'Demo User',
                    phoneNumber: '9352525595',
                    profilePhoto: generateAvatarDataURL('Demo User', 60),
                    isAdmin: true
                };
                console.log('⚠️ Using demo user');
            }
            
            // Show initial tab
            showTabWA('chats');
            
            // Load demo data
            loadDemoDataWA();
            
            // Load status updates
            loadStatusUpdatesWA();
            
            // Load communities
            loadCommunitiesWA();
            
            console.log('✅ App initialized successfully');
        }
        
        function loadDemoDataWA() {
            console.log('📱 Loading demo data...');
            
            // Demo chats
            const demoChats = [
                {
                    chatId: 'demo_chat_1',
                    type: 'individual',
                    participants: [currentUser.userId, 'user_2'],
                    lastMessage: {
                        text: 'Aapka family tree update ho gaya hai',
                        timestamp: new Date(),
                        senderId: 'user_2'
                    },
                    createdAt: new Date(),
                    createdBy: currentUser.userId
                },
                {
                    chatId: 'demo_chat_2',
                    type: 'group',
                    groupName: 'Nagori Family Group',
                    participants: [currentUser.userId, 'user_2', 'user_3'],
                    lastMessage: {
                        text: 'Meeting ka time fix kar lete hain',
                        timestamp: new Date(Date.now() - 3600000),
                        senderId: 'user_3'
                    },
                    createdAt: new Date(),
                    createdBy: currentUser.userId
                }
            ];
            
            updateChatListWA(demoChats);
            
            // Demo statuses - CRITICAL FIX
            const existingStatuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
            if (existingStatuses.length === 0) {
                console.log('📊 Loading demo statuses...');
                const now = Date.now();
                
                const demoStatuses = [
                    // Own text status
                    {
                        statusId: 'status_demo_own_1',
                        userId: currentUser.userId,
                        userName: currentUser.name,
                        userPhoto: currentUser.profilePhoto || generateAvatarDataURL(currentUser.name || 'User', 60),
                        type: 'text',
                        content: 'Welcome to Nagori Adda! 🎉',
                        timestamp: now - (2 * 60 * 60 * 1000), // 2 hours ago
                        views: [],
                        expiresAt: now + (22 * 60 * 60 * 1000) // 22 hours remaining
                    },
                    // Own image status
                    {
                        statusId: 'status_demo_own_2',
                        userId: currentUser.userId,
                        userName: currentUser.name,
                        userPhoto: currentUser.profilePhoto || generateAvatarDataURL(currentUser.name || 'User', 60),
                        type: 'image',
                        content: 'Beautiful day! ☀️',
                        mediaUrl: 'https://via.placeholder.com/600x800/4CAF50/FFFFFF?text=My+Photo+Status',
                        timestamp: now - (1 * 60 * 60 * 1000), // 1 hour ago
                        views: [],
                        expiresAt: now + (23 * 60 * 60 * 1000)
                    },
                    // Other user text status
                    {
                        statusId: 'status_demo_other_1',
                        userId: 'user_demo_2',
                        userName: 'राज नागौरी',
                        userPhoto: generateAvatarDataURL('Ramesh Nagori', 60),
                        type: 'text',
                        content: 'Jai Nagori! परिवार की शुभकामनाएं 🙏',
                        timestamp: now - (3 * 60 * 60 * 1000), // 3 hours ago
                        views: [],
                        expiresAt: now + (21 * 60 * 60 * 1000)
                    },
                    // Other user image status
                    {
                        statusId: 'status_demo_other_2',
                        userId: 'user_demo_3',
                        userName: 'प्रिया शर्मा',
                        userPhoto: generateAvatarDataURL('Priya Sharma', 60),
                        type: 'image',
                        content: 'Family gathering! 👨‍👩‍👧‍👦',
                        mediaUrl: 'https://via.placeholder.com/600x800/FF9800/FFFFFF?text=Family+Photo',
                        timestamp: now - (5 * 60 * 60 * 1000), // 5 hours ago
                        views: [],
                        expiresAt: now + (19 * 60 * 60 * 1000)
                    },
                    // Other user video status
                    {
                        statusId: 'status_demo_other_3',
                        userId: 'user_demo_4',
                        userName: 'विकास नागौरी',
                        userPhoto: generateAvatarDataURL('Vikram Nagori', 60),
                        type: 'video',
                        content: 'Check out this amazing view! 🏞️',
                        mediaUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                        timestamp: now - (4 * 60 * 60 * 1000), // 4 hours ago
                        views: [],
                        expiresAt: now + (20 * 60 * 60 * 1000)
                    }
                ];
                
                localStorage.setItem('nagori_adda_statuses', JSON.stringify(demoStatuses));
                console.log('✅ Demo statuses loaded:', demoStatuses.length);
            }
        }
        
        function updateChatListWA(chats) {
            console.log('📋 Updating chat list with', chats.length, 'chats');
            
            const chatList = document.getElementById('all-chats-wa');
            if (!chatList) return;
            
            chatList.innerHTML = '';
            
            if (chats.length === 0) {
                chatList.innerHTML = '<p class="text-gray-400 text-center p-4">No chats yet. Start a conversation!</p>';
                return;
            }
            
            chats.forEach(chat => {
                const chatItem = createChatItemWA(chat);
                chatList.appendChild(chatItem);
            });
        }
        
        function createChatItemWA(chat) {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item flex items-center gap-3 p-4 cursor-pointer';
            chatItem.onclick = () => openChatWA(chat);
            
            const isGroup = chat.type === 'group';
            const chatName = isGroup ? chat.groupName : 'Contact Name';
            const lastMessage = chat.lastMessage?.text || 'No messages yet';
            const timestamp = formatTimeWA(chat.lastMessage?.timestamp || chat.createdAt);
            const unreadCount = Math.floor(Math.random() * 5); // Demo unread count
            
            chatItem.innerHTML = `
                <img src="${generateAvatarDataURL(chatName, 50)}" alt="${chatName}" class="w-12 h-12 rounded-full">
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-semibold truncate">${chatName}</h3>
                        <span class="message-time">${timestamp}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-gray-400 truncate">${lastMessage}</p>
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                    </div>
                </div>
            `;
            
            return chatItem;
        }
        
        function closeWhatsAppChat() {
            const whatsappContainer = document.getElementById('whatsapp-chat-container');
            whatsappContainer.classList.add('hidden');
            whatsappContainer.classList.remove('flex');
            
            // Show dashboard
            const dashboard = document.getElementById('dashboard-screen');
            if (dashboard) dashboard.classList.remove('hidden');
        }
        
        function showTabWA(tabName) {
            console.log('📱 Switching to tab:', tabName);
            
            // Update tab buttons
            document.querySelectorAll('[id$="-tab-wa"]').forEach(tab => {
                tab.classList.remove('tab-active');
            });
            document.getElementById(tabName + '-tab-wa').classList.add('tab-active');
            
            // Update content
            document.querySelectorAll('[id$="-content-wa"]').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('flex');
            });
            const content = document.getElementById(tabName + '-content-wa');
            content.classList.remove('hidden');
            content.classList.add('flex');
            
            // Update FAB icon
            const fab = document.getElementById('fab-wa');
            if (fab) {
                switch(tabName) {
                    case 'chats':
                        fab.innerHTML = '<i class="fas fa-plus"></i>';
                        break;
                    case 'updates':
                        fab.innerHTML = '<i class="fas fa-camera"></i>';
                        break;
                    case 'communities':
                        fab.innerHTML = '<i class="fas fa-plus"></i>';
                        break;
                }
            }
            
            currentTabWA = tabName;
        }
        
        function openSearchWA() {
            console.log('🔍 Opening search...');
            showSearchModalWA();
        }
        
        function showSearchModalWA() {
            const modal = document.createElement('div');
            modal.id = 'search-modal-wa';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
            modal.innerHTML = `
                <div class="flex items-start justify-center h-full p-4 pt-20">
                    <div class="bg-whatsapp-dark rounded-lg w-full max-w-md">
                        <div class="p-4 border-b border-gray-600 flex items-center gap-3">
                            <button onclick="closeSearchModalWA()" class="hover:bg-gray-700 p-1 rounded">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <input type="text" id="search-input-wa" placeholder="Search chats, contacts, or messages..." 
                                   class="flex-1 bg-whatsapp-light text-white px-4 py-2 rounded-lg outline-none"
                                   oninput="performSearchWA(this.value)">
                        </div>
                        <div class="p-4">
                            <div id="search-results-wa" class="space-y-2">
                                <p class="text-gray-400 text-center">Start typing to search...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('search-input-wa').focus();
        }
        
        function closeSearchModalWA() {
            const modal = document.getElementById('search-modal-wa');
            if (modal) {
                modal.remove();
            }
        }
        
        function performSearchWA(query) {
            const resultsContainer = document.getElementById('search-results-wa');
            if (!query.trim()) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center">Start typing to search...</p>';
                return;
            }
            
            console.log('🔍 Searching for:', query);
            
            // Search in localStorage
            const chats = getStoredChatsWA();
            const matchingChats = chats.filter(chat => 
                chat.groupName?.toLowerCase().includes(query.toLowerCase()) ||
                chat.lastMessage?.text?.toLowerCase().includes(query.toLowerCase())
            );
            
            let resultsHTML = '';
            
            if (matchingChats.length > 0) {
                resultsHTML += '<div class="mb-4"><h4 class="text-sm text-gray-400 mb-2">Chats</h4>';
                matchingChats.forEach(chat => {
                    resultsHTML += `
                        <div class="flex items-center gap-3 p-2 hover:bg-whatsapp-light rounded cursor-pointer" onclick="openChatFromSearchWA('${chat.chatId}')">
                            <img src="${generateAvatarDataURL(chat.chatName || 'Chat', 40)}" alt="Chat" class="w-10 h-10 rounded-full">
                            <div class="flex-1">
                                <h5 class="font-semibold">${chat.groupName || 'Contact'}</h5>
                                <p class="text-sm text-gray-400">${chat.lastMessage?.text || 'No messages'}</p>
                            </div>
                        </div>
                    `;
                });
                resultsHTML += '</div>';
            }
            
            if (resultsHTML === '') {
                resultsHTML = '<p class="text-gray-400 text-center">No results found</p>';
            }
            
            resultsContainer.innerHTML = resultsHTML;
        }
        
        function openChatFromSearchWA(chatId) {
            closeSearchModalWA();
            const chat = getStoredChatsWA().find(c => c.chatId === chatId);
            if (chat) {
                openChatWA(chat);
            }
        }
        
        function openMenuWA() {
            console.log('📋 Opening menu...');
            alert('Menu options - Settings, Starred messages, etc.');
        }
        
        function fabActionWA() {
            switch(currentTabWA) {
                case 'chats':
                    showNewChatOptionsWA();
                    break;
                case 'updates':
                    openAddStatusModalWA();
                    break;
                case 'communities':
                    createCommunityWA();
                    break;
            }
        }
        
        function showNewChatOptionsWA() {
            const modal = document.createElement('div');
            modal.id = 'new-chat-options-modal-wa';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
            modal.innerHTML = `
                <div class="flex items-center justify-center h-full p-4">
                    <div class="bg-whatsapp-dark rounded-lg w-full max-w-sm">
                        <div class="p-4 border-b border-gray-600">
                            <h3 class="text-lg font-semibold">New Chat</h3>
                        </div>
                        <div class="p-4 space-y-3">
                            <button onclick="openNewChatModalWA(); closeNewChatOptionsModalWA();" class="w-full bg-whatsapp-light hover:bg-whatsapp-dark p-4 rounded-lg flex items-center gap-3">
                                <div class="w-12 h-12 bg-whatsapp-green rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div class="text-left">
                                    <h4 class="font-semibold">New Chat</h4>
                                    <p class="text-sm text-gray-400">Start a conversation</p>
                                </div>
                            </button>
                            <button onclick="openNewGroupModalWA(); closeNewChatOptionsModalWA();" class="w-full bg-whatsapp-light hover:bg-whatsapp-dark p-4 rounded-lg flex items-center gap-3">
                                <div class="w-12 h-12 bg-whatsapp-green rounded-full flex items-center justify-center">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                                <div class="text-left">
                                    <h4 class="font-semibold">New Group</h4>
                                    <p class="text-sm text-gray-400">Create a group chat</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeNewChatOptionsModalWA() {
            const modal = document.getElementById('new-chat-options-modal-wa');
            if (modal) {
                modal.remove();
            }
        }
        
        function openNewChatModalWA() {
            alert('New Chat feature - Select contact to start conversation');
        }
        
        function openNewGroupModalWA() {
            alert('New Group feature - Select participants to create group');
        }
        
        function createCommunityWA() {
            const communityName = prompt('Enter community name:');
            if (!communityName) return;
            
            const communityDescription = prompt('Enter community description (optional):');
            
            const communityId = 'community_' + Date.now();
            
            const newCommunity = {
                communityId: communityId,
                name: communityName,
                description: communityDescription || '',
                createdBy: currentUser.userId,
                createdAt: new Date(),
                members: [currentUser.userId],
                groups: [],
                announcements: []
            };
            
            // Store community
            storeCommunityWA(newCommunity);
            
            // Refresh communities list
            loadCommunitiesWA();
            
            alert('✅ Community created: ' + communityName);
            console.log('✅ Community created:', communityName);
        }
        
        function storeCommunityWA(community) {
            const communities = getStoredCommunitiesWA();
            communities.push(community);
            localStorage.setItem('nagori_adda_communities', JSON.stringify(communities));
        }
        
        function getStoredCommunitiesWA() {
            return JSON.parse(localStorage.getItem('nagori_adda_communities') || '[]');
        }
        
        function loadCommunitiesWA() {
            const communities = getStoredCommunitiesWA();
            const container = document.getElementById('my-communities-wa');
            if (!container) return;
            
            let communitiesHTML = '';
            communities.forEach(community => {
                communitiesHTML += `
                    <div class="flex items-center gap-3 p-3 hover:bg-whatsapp-light rounded-lg cursor-pointer" onclick="openCommunityWA('${community.communityId}')">
                        <div class="w-12 h-12 bg-whatsapp-green rounded-full flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold">${community.name}</h4>
                            <p class="text-sm text-gray-400">${community.members.length} members • ${community.groups.length} groups</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                `;
            });
            
            container.innerHTML = communitiesHTML || '<p class="text-gray-400 text-center">No communities yet</p>';
        }
        
        function openCommunityWA(communityId) {
            const community = getStoredCommunitiesWA().find(c => c.communityId === communityId);
            if (!community) return;
            
            alert('Community: ' + community.name + '\nMembers: ' + community.members.length + '\nGroups: ' + community.groups.length);
        }
        
        function getStoredChatsWA() {
            return JSON.parse(localStorage.getItem('nagori_adda_chats') || '[]');
        }
        
        function formatTimeWA(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // Less than 1 minute
                return 'Just now';
            } else if (diff < 3600000) { // Less than 1 hour
                return Math.floor(diff / 60000) + 'm';
            } else if (diff < 86400000) { // Less than 1 day
                return Math.floor(diff / 3600000) + 'h';
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // Core Chat Functions
        function openChatWA(chat) {
            console.log('💬 Opening chat:', chat.chatId);
            
            currentChatIdWA = chat.chatId;
            
            // Hide chat list, show chat screen
            document.getElementById('chats-content-wa').classList.add('hidden');
            document.getElementById('chats-content-wa').classList.remove('flex');
            document.getElementById('chat-screen-wa').classList.remove('hidden');
            document.getElementById('chat-screen-wa').classList.add('flex');
            
            // Update chat header
            const isGroup = chat.type === 'group';
            document.getElementById('chat-user-name-wa').textContent = isGroup ? chat.groupName : 'Contact Name';
            document.getElementById('chat-user-status-wa').textContent = isGroup ? `${chat.participants.length} participants` : 'Online';
            
            // Load messages
            loadMessagesWA(chat.chatId);
        }
        
        function showChatListWA() {
            document.getElementById('chat-screen-wa').classList.add('hidden');
            document.getElementById('chat-screen-wa').classList.remove('flex');
            document.getElementById('chats-content-wa').classList.remove('hidden');
            document.getElementById('chats-content-wa').classList.add('flex');
            currentChatIdWA = null;
        }
        
        function loadMessagesWA(chatId) {
            console.log('📨 Loading messages for chat:', chatId);
            
            const messagesContainer = document.getElementById('messages-container-wa');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '';
            
            // Demo messages
            const demoMessages = [
                {
                    messageId: 'msg_1',
                    senderId: 'user_2',
                    senderName: 'Contact Name',
                    text: 'Namaste! Kaise hain aap?',
                    timestamp: new Date(Date.now() - 7200000),
                    status: 'read'
                },
                {
                    messageId: 'msg_2',
                    senderId: currentUser.userId,
                    senderName: currentUser.name,
                    text: 'Main theek hun, aap kaise hain?',
                    timestamp: new Date(Date.now() - 7000000),
                    status: 'read'
                },
                {
                    messageId: 'msg_3',
                    senderId: 'user_2',
                    senderName: 'Contact Name',
                    text: 'Family tree mein aapka naam add kar diya hai',
                    timestamp: new Date(Date.now() - 6800000),
                    status: 'read'
                }
            ];
            
            demoMessages.forEach(message => {
                addMessageToUIWA(message);
            });
            scrollToBottomWA();
        }
        
        function addMessageToUIWA(message) {
            const messagesContainer = document.getElementById('messages-container-wa');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            
            const isOwnMessage = message.senderId === currentUser.userId;
            const messageClass = isOwnMessage ? 'chat-bubble-sent' : 'chat-bubble-received';
            const alignment = isOwnMessage ? 'justify-end' : 'justify-start';
            
            messageDiv.className = `flex ${alignment} mb-2`;
            messageDiv.setAttribute('data-message-id', message.messageId);
            
            // Check if message is starred
            const starredMessages = JSON.parse(localStorage.getItem('nagori_adda_starred_messages') || '[]');
            const isStarred = starredMessages.includes(message.messageId);
            
            // Reply preview if this is a reply
            let replyPreview = '';
            if (message.replyTo) {
                const allMessages = JSON.parse(localStorage.getItem('nagori_adda_messages') || '[]');
                const originalMessage = allMessages.find(m => m.messageId === message.replyTo);
                if (originalMessage) {
                    replyPreview = `
                        <div class="reply-preview mb-2 p-2 border-l-4 border-whatsapp-green bg-black bg-opacity-20 rounded">
                            <div class="text-xs text-whatsapp-green font-semibold">${originalMessage.senderName}</div>
                            <div class="text-xs opacity-70">${originalMessage.text || 'Media message'}</div>
                        </div>
                    `;
                }
            }
            
            // Media content
            let mediaContent = '';
            if (message.mediaUrl) {
                if (message.mediaType === 'image') {
                    mediaContent = `<img src="${message.mediaUrl}" class="media-preview mt-2 rounded-lg cursor-pointer max-w-full" alt="Media">`;
                } else if (message.mediaType === 'video') {
                    mediaContent = `
                        <video src="${message.mediaUrl}" class="media-preview mt-2 rounded-lg cursor-pointer max-w-full" controls>
                            Your browser does not support the video tag.
                        </video>
                    `;
                }
            }
            
            // Voice message content
            if (message.messageType === 'voice' && message.audioUrl) {
                const duration = message.audioDuration || 0;
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                mediaContent = `
                    <div class="voice-message mt-2 flex items-center gap-3 p-3 bg-black bg-opacity-20 rounded-lg">
                        <button onclick="playVoiceMessageWA('${message.messageId}')" class="voice-play-btn w-8 h-8 bg-whatsapp-green rounded-full flex items-center justify-center hover:bg-green-600">
                            <i class="fas fa-play text-white text-sm"></i>
                        </button>
                        <div class="flex-1">
                            <div class="voice-waveform bg-gray-600 h-2 rounded-full relative">
                                <div class="voice-progress bg-whatsapp-green h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">${durationText}</div>
                        </div>
                        <audio id="audio-wa-${message.messageId}" src="${message.audioUrl}" preload="metadata"></audio>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble relative max-w-xs lg:max-w-md px-4 py-2 ${messageClass}">
                    ${replyPreview}
                    ${message.text ? `<div class="message-text">${message.text}</div>` : ''}
                    ${mediaContent}
                    <div class="message-time text-xs mt-1 opacity-70">
                        ${formatTimeWA(message.timestamp)}
                        ${isOwnMessage ? getStatusIconWA(message.status) : ''}
                        ${isStarred ? '<i class="fas fa-star text-yellow-400 ml-1"></i>' : ''}
                    </div>
                    <div class="message-actions">
                        <button onclick="replyToMessageWA('${message.messageId}')" class="hover:bg-gray-600 p-1 rounded" title="Reply">
                            <i class="fas fa-reply text-xs"></i>
                        </button>
                        <button onclick="forwardMessageWA('${message.messageId}')" class="hover:bg-gray-600 p-1 rounded" title="Forward">
                            <i class="fas fa-share text-xs"></i>
                        </button>
                        <button onclick="starMessageWA('${message.messageId}')" class="hover:bg-gray-600 p-1 rounded" title="Star">
                            <i class="fas fa-star text-xs ${isStarred ? 'text-yellow-400' : ''}"></i>
                        </button>
                        <button onclick="deleteMessageWA('${message.messageId}')" class="hover:bg-gray-600 p-1 rounded" title="Delete">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }
        
        function getStatusIconWA(status) {
            switch(status) {
                case 'sent':
                    return '<i class="fas fa-check text-gray-400"></i>';
                case 'delivered':
                    return '<i class="fas fa-check-double text-gray-400"></i>';
                case 'read':
                    return '<i class="fas fa-check-double text-blue-400"></i>';
                default:
                    return '';
            }
        }
        
        function scrollToBottomWA() {
            const container = document.getElementById('messages-container-wa');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function handleKeyPressWA(event) {
            if (event.key === 'Enter') {
                sendMessageWA();
            }
        }
        
        function sendMessageWA() {
            const messageInput = document.getElementById('message-input-wa');
            if (!messageInput) return;
            
            const text = messageInput.value.trim();
            
            if (!text || !currentChatIdWA) return;
            
            const message = {
                messageId: 'msg_' + Date.now(),
                chatId: currentChatIdWA,
                senderId: currentUser.userId,
                senderName: currentUser.name,
                text: text,
                timestamp: new Date(),
                status: 'sent'
            };
            
            // Add reply reference if replying
            if (replyingToMessageWA) {
                message.replyTo = replyingToMessageWA.messageId;
            }
            
            // Store message in localStorage
            storeMessageWA(message);
            
            // Add to UI
            addMessageToUIWA(message);
            
            // Clear input
            messageInput.value = '';
            
            // Clear reply preview
            cancelReplyWA();
            
            // Scroll to bottom
            scrollToBottomWA();
            
            console.log('📱 Message sent (demo mode)');
        }
        
        function storeMessageWA(message) {
            const messages = JSON.parse(localStorage.getItem('nagori_adda_messages') || '[]');
            messages.push(message);
            localStorage.setItem('nagori_adda_messages', JSON.stringify(messages));
        }
        
        function openChatInfoWA() {
            console.log('ℹ️ Opening chat info...');
            if (!currentChatIdWA) return;
            
            const chat = getStoredChatsWA().find(c => c.chatId === currentChatIdWA);
            if (!chat) return;
            
            alert('Chat Info:\n' + (chat.groupName || 'Contact') + '\nParticipants: ' + chat.participants.length);
        }
        
        function attachMediaWA() {
            document.getElementById('media-input-wa').click();
        }
        
        function handleMediaSelectWA(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('📎 Media selected:', file.name, file.type);
            
            // Create media message
            const mediaMessage = {
                messageId: 'msg_' + Date.now(),
                chatId: currentChatIdWA,
                senderId: currentUser.userId,
                senderName: currentUser.name,
                text: '[Media: ' + file.name + ']',
                mediaUrl: URL.createObjectURL(file),
                mediaType: file.type.startsWith('image/') ? 'image' : 'video',
                timestamp: new Date(),
                status: 'sent'
            };
            
            // Store message
            storeMessageWA(mediaMessage);
            
            // Add to UI
            addMessageToUIWA(mediaMessage);
            
            // Clear file input
            event.target.value = '';
            
            // Scroll to bottom
            scrollToBottomWA();
            
            console.log('✅ Media sent successfully');
        }
        
        function recordVoiceWA() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Voice recording not supported in your browser');
                return;
            }
            
            if (isRecordingWA) {
                stopRecordingWA();
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorderWA = new MediaRecorder(stream);
                    audioChunksWA = [];
                    
                    mediaRecorderWA.ondataavailable = (event) => {
                        audioChunksWA.push(event.data);
                    };
                    
                    mediaRecorderWA.onstop = () => {
                        const audioBlob = new Blob(audioChunksWA, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        // Send voice message
                        const message = {
                            messageId: 'msg_' + Date.now(),
                            chatId: currentChatIdWA,
                            senderId: currentUser.userId,
                            senderName: currentUser.name,
                            messageType: 'voice',
                            audioUrl: audioUrl,
                            audioDuration: recordingDurationWA,
                            timestamp: new Date(),
                            status: 'sent'
                        };
                        
                        storeMessageWA(message);
                        addMessageToUIWA(message);
                        scrollToBottomWA();
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        
                        console.log('✅ Voice message sent');
                    };
                    
                    mediaRecorderWA.start();
                    isRecordingWA = true;
                    recordingDurationWA = 0;
                    
                    // Start timer
                    recordingTimerWA = setInterval(() => {
                        recordingDurationWA++;
                        console.log('🎤 Recording:', recordingDurationWA + 's');
                        
                        // Auto-stop after 60 seconds
                        if (recordingDurationWA >= 60) {
                            stopRecordingWA();
                        }
                    }, 1000);
                    
                    alert('🎤 Recording started... Click again to stop');
                })
                .catch(error => {
                    console.error('❌ Error accessing microphone:', error);
                    alert('Could not access microphone. Please check permissions.');
                });
        }
        
        function stopRecordingWA() {
            if (mediaRecorderWA && isRecordingWA) {
                mediaRecorderWA.stop();
                isRecordingWA = false;
                clearInterval(recordingTimerWA);
            }
        }
        
        function playVoiceMessageWA(messageId) {
            const audio = document.getElementById('audio-wa-' + messageId);
            if (!audio) return;
            
            const playButton = audio.previousElementSibling.previousElementSibling;
            const playIcon = playButton.querySelector('i');
            
            if (audio.paused) {
                audio.play();
                playIcon.classList.remove('fa-play');
                playIcon.classList.add('fa-pause');
                
                audio.onended = () => {
                    playIcon.classList.remove('fa-pause');
                    playIcon.classList.add('fa-play');
                };
            } else {
                audio.pause();
                playIcon.classList.remove('fa-pause');
                playIcon.classList.add('fa-play');
            }
        }
        
        // Message Action Functions
        function replyToMessageWA(messageId) {
            console.log('↩️ Replying to message:', messageId);
            
            // Find the message
            const allMessages = JSON.parse(localStorage.getItem('nagori_adda_messages') || '[]');
            const message = allMessages.find(m => m.messageId === messageId);
            
            if (!message) return;
            
            replyingToMessageWA = {
                messageId: messageId,
                text: message.text || 'Media message',
                senderName: message.senderName
            };
            
            // Show reply preview
            showReplyPreviewWA();
            
            // Focus on message input
            document.getElementById('message-input-wa').focus();
        }
        
        function showReplyPreviewWA() {
            if (!replyingToMessageWA) return;
            
            const inputContainer = document.querySelector('#individual-chat-wa .p-4');
            if (!inputContainer) return;
            
            let replyPreviewDiv = document.getElementById('reply-preview-wa');
            if (!replyPreviewDiv) {
                replyPreviewDiv = document.createElement('div');
                replyPreviewDiv.id = 'reply-preview-wa';
                inputContainer.insertBefore(replyPreviewDiv, inputContainer.firstChild);
            }
            
            replyPreviewDiv.className = 'bg-whatsapp-light p-3 rounded-lg mb-2 flex justify-between items-center';
            replyPreviewDiv.innerHTML = `
                <div class="flex-1">
                    <div class="text-xs text-whatsapp-green font-semibold">Replying to ${replyingToMessageWA.senderName}</div>
                    <div class="text-sm opacity-70">${replyingToMessageWA.text}</div>
                </div>
                <button onclick="cancelReplyWA()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }
        
        function cancelReplyWA() {
            replyingToMessageWA = null;
            const replyPreviewDiv = document.getElementById('reply-preview-wa');
            if (replyPreviewDiv) {
                replyPreviewDiv.remove();
            }
        }
        
        function forwardMessageWA(messageId) {
            console.log('↗️ Forwarding message:', messageId);
            showForwardModalWA(messageId);
        }
        
        function showForwardModalWA(messageId) {
            const modal = document.createElement('div');
            modal.id = 'forward-modal-wa';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
            modal.innerHTML = `
                <div class="flex items-center justify-center h-full p-4">
                    <div class="bg-whatsapp-dark rounded-lg w-full max-w-md">
                        <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Forward Message</h3>
                            <button onclick="closeForwardModalWA()" class="hover:bg-gray-700 p-1 rounded">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-4">
                            <div class="mb-4">
                                <h4 class="text-sm text-gray-400 mb-2">Select contacts or groups</h4>
                                <div id="forward-contacts-wa" class="space-y-2 max-h-96 overflow-y-auto">
                                    <!-- Contacts will be listed here -->
                                </div>
                            </div>
                            <button onclick="sendForwardedMessageWA('${messageId}')" class="w-full whatsapp-green hover:bg-green-600 py-3 rounded-lg font-semibold">
                                <i class="fas fa-share mr-2"></i>Forward
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load chats for forwarding
            loadForwardContactsWA();
        }
        
        function loadForwardContactsWA() {
            const container = document.getElementById('forward-contacts-wa');
            if (!container) return;
            
            const chats = getStoredChatsWA();
            let html = '';
            
            chats.forEach(chat => {
                const chatName = chat.groupName || 'Contact';
                html += `
                    <div class="flex items-center gap-3 p-3 hover:bg-whatsapp-light rounded-lg cursor-pointer">
                        <input type="checkbox" id="forward-chat-${chat.chatId}" class="w-4 h-4">
                        <label for="forward-chat-${chat.chatId}" class="flex-1 cursor-pointer">
                            <div class="font-semibold">${chatName}</div>
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-gray-400 text-center">No chats available</p>';
        }
        
        function sendForwardedMessageWA(messageId) {
            // Get selected chats
            const selectedChats = [];
            document.querySelectorAll('#forward-contacts-wa input[type="checkbox"]:checked').forEach(checkbox => {
                const chatId = checkbox.id.replace('forward-chat-', '');
                selectedChats.push(chatId);
            });
            
            if (selectedChats.length === 0) {
                alert('Please select at least one chat');
                return;
            }
            
            // Get original message
            const allMessages = JSON.parse(localStorage.getItem('nagori_adda_messages') || '[]');
            const originalMessage = allMessages.find(m => m.messageId === messageId);
            
            if (!originalMessage) return;
            
            // Forward to selected chats
            selectedChats.forEach(chatId => {
                const forwardedMessage = {
                    ...originalMessage,
                    messageId: 'msg_' + Date.now() + '_' + Math.random(),
                    chatId: chatId,
                    timestamp: new Date(),
                    senderId: currentUser.userId,
                    senderName: currentUser.name
                };
                
                storeMessageWA(forwardedMessage);
            });
            
            closeForwardModalWA();
            alert(`✅ Message forwarded to ${selectedChats.length} chat(s)`);
        }
        
        function closeForwardModalWA() {
            const modal = document.getElementById('forward-modal-wa');
            if (modal) {
                modal.remove();
            }
        }
        
        function starMessageWA(messageId) {
            console.log('⭐ Starring message:', messageId);
            
            // Get starred messages
            const starredMessages = JSON.parse(localStorage.getItem('nagori_adda_starred_messages') || '[]');
            const isCurrentlyStarred = starredMessages.includes(messageId);
            
            if (isCurrentlyStarred) {
                // Unstar
                const index = starredMessages.indexOf(messageId);
                starredMessages.splice(index, 1);
                console.log('⭐ Message unstarred');
            } else {
                // Star
                starredMessages.push(messageId);
                console.log('⭐ Message starred');
            }
            
            // Save to localStorage
            localStorage.setItem('nagori_adda_starred_messages', JSON.stringify(starredMessages));
            
            // Reload messages to show updated star status
            if (currentChatIdWA) {
                loadMessagesWA(currentChatIdWA);
            }
        }
        
        function deleteMessageWA(messageId) {
            console.log('🗑️ Deleting message:', messageId);
            
            if (confirm('Are you sure you want to delete this message?')) {
                // Remove from UI
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
                
                // Remove from storage
                const messages = JSON.parse(localStorage.getItem('nagori_adda_messages') || '[]');
                const filteredMessages = messages.filter(m => m.messageId !== messageId);
                localStorage.setItem('nagori_adda_messages', JSON.stringify(filteredMessages));
                
                // Remove from starred if it was starred
                const starredMessages = JSON.parse(localStorage.getItem('nagori_adda_starred_messages') || '[]');
                const filteredStarred = starredMessages.filter(id => id !== messageId);
                localStorage.setItem('nagori_adda_starred_messages', JSON.stringify(filteredStarred));
                
                console.log('✅ Message deleted');
            }
        }
        
        // Status Updates Functions
        function loadStatusUpdatesWA() {
            try {
                const statuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
                const recentContainer = document.getElementById('recent-statuses-wa');
                const viewedContainer = document.getElementById('viewed-statuses-wa');
                
                if (!recentContainer || !viewedContainer) {
                    console.warn('⚠️ Status containers not found');
                    return;
                }
                
                // Filter expired statuses (older than 24 hours)
                const now = Date.now();
                const validStatuses = statuses.filter(status => {
                    if (!status || !status.timestamp) return false;
                    const statusTime = typeof status.timestamp === 'number' ? status.timestamp : new Date(status.timestamp).getTime();
                    const diffHours = (now - statusTime) / (1000 * 60 * 60);
                    return diffHours <= 24;
                });
                
                // Separate own and others' statuses
                const ownStatuses = validStatuses.filter(status => status.userId === currentUser.userId);
                const othersStatuses = validStatuses.filter(status => status.userId !== currentUser.userId);
                
                // Further separate by viewed status for others
                const recentOthers = othersStatuses.filter(status => {
                    const views = status.views || [];
                    return !views.includes(currentUser.userId);
                });
                
                const viewedOthers = othersStatuses.filter(status => {
                    const views = status.views || [];
                    return views.includes(currentUser.userId);
                });
                
                // Render own status (My Status section)
                let myStatusHTML = '';
                if (ownStatuses.length > 0) {
                    const latestOwnStatus = ownStatuses[ownStatuses.length - 1];
                    myStatusHTML = `
                        <div class="mb-4">
                            <h3 class="text-sm text-gray-400 px-4 mb-2">My Status</h3>
                            ${createStatusItemWA(latestOwnStatus, true)}
                        </div>
                    `;
                }
                
                // Render recent statuses (unviewed)
                let recentHTML = '';
                if (recentOthers.length > 0) {
                    recentHTML = '<h3 class="text-sm text-gray-400 px-4 mb-2 mt-4">Recent updates</h3>';
                    recentOthers.forEach(status => {
                        recentHTML += createStatusItemWA(status, false);
                    });
                }
                
                recentContainer.innerHTML = myStatusHTML + recentHTML || '<p class="text-gray-400 text-center p-4">No recent updates</p>';
                
                // Render viewed statuses
                let viewedHTML = '';
                if (viewedOthers.length > 0) {
                    viewedHTML = '<h3 class="text-sm text-gray-400 px-4 mb-2">Viewed updates</h3>';
                    viewedOthers.forEach(status => {
                        viewedHTML += createStatusItemWA(status, false);
                    });
                }
                viewedContainer.innerHTML = viewedHTML || '<p class="text-gray-400 text-center p-4">No viewed updates</p>';
                
                console.log('✅ Status updates loaded:', {
                    own: ownStatuses.length,
                    recent: recentOthers.length,
                    viewed: viewedOthers.length
                });
                
            } catch (error) {
                console.error('❌ Error loading status updates:', error);
            }
        }
        
        function createStatusItemWA(status, isOwnStatus = false) {
            try {
                if (!status) return '';
                
                const timeAgo = formatTimeWA(status.timestamp);
                const views = status.views || [];
                const hasBeenViewed = views.includes(currentUser.userId);
                
                // Ring color logic:
                // - Green ring for unviewed statuses
                // - Gray ring for viewed statuses
                // - Green ring for own statuses
                const ringClass = (isOwnStatus || !hasBeenViewed) ? 'status-ring' : 'status-ring-gray';
                
                const userName = status.userName || 'Unknown';
                const userPhoto = status.userPhoto || generateAvatarDataURL(userName, 60);
                
                return `
                    <div class="flex items-center gap-4 p-3 hover:bg-whatsapp-light rounded-lg cursor-pointer" onclick="viewStatusWA('${status.statusId}')">
                        <div class="${ringClass}">
                            <img src="${userPhoto}" alt="${userName}" class="w-12 h-12 rounded-full">
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold">${userName}</h4>
                            <p class="text-sm text-gray-400">${timeAgo}</p>
                        </div>
                        ${isOwnStatus ? `<div class="text-xs text-gray-400">${views.length} views</div>` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('❌ Error creating status item:', error);
                return '';
            }
        }
        
        function viewStatusWA(statusId) {
            try {
                if (!statusId) {
                    console.error('❌ No status ID provided');
                    return;
                }
                
                const statuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
                const status = statuses.find(s => s.statusId === statusId);
                
                if (!status) {
                    console.error('❌ Status not found:', statusId);
                    alert('Status not found or expired');
                    return;
                }
                
                // Initialize views array if missing
                if (!status.views) {
                    status.views = [];
                }
                
                // Mark as viewed if not own status
                if (status.userId !== currentUser.userId && !status.views.includes(currentUser.userId)) {
                    status.views.push(currentUser.userId);
                    updateStatusInStorageWA(status);
                    // Refresh status list to update ring colors
                    loadStatusUpdatesWA();
                }
                
                // Show status viewer
                showStatusViewerWA(status);
                
                console.log('✅ Viewing status:', statusId, 'Views:', status.views.length);
                
            } catch (error) {
                console.error('❌ Error viewing status:', error);
                alert('Error viewing status: ' + error.message);
            }
        }
        
        function showStatusViewerWA(status) {
            try {
                if (!status) {
                    console.error('❌ No status provided to viewer');
                    return;
                }
                
                const viewer = document.getElementById('status-viewer-wa');
                if (!viewer) {
                    console.error('❌ Status viewer element not found');
                    return;
                }
                
                viewer.classList.remove('hidden');
                
                // Update viewer content with null checks
                const userPhoto = status.userPhoto || generateAvatarDataURL(status.userName || 'User', 60);
                const userName = status.userName || 'Unknown User';
                const views = status.views || [];
                
                document.getElementById('status-user-photo-wa-viewer').src = userPhoto;
                document.getElementById('status-user-name-wa-viewer').textContent = userName;
                document.getElementById('status-time-wa-viewer').textContent = formatTimeWA(status.timestamp);
                document.getElementById('status-views-wa').textContent = views.length;
                
                const contentDiv = document.getElementById('status-content-wa-viewer');
                const actionsDiv = document.getElementById('status-actions-wa');
                
                if (!contentDiv || !actionsDiv) {
                    console.error('❌ Status viewer content elements not found');
                    return;
                }
                
                // Render content based on type
                const statusContent = status.content || '';
                
                if (status.type === 'text') {
                    contentDiv.innerHTML = `
                        <div class="p-8 max-w-2xl mx-auto">
                            <div class="text-4xl font-bold mb-6 leading-relaxed text-white">${statusContent}</div>
                        </div>
                    `;
                    
                    // Auto-close text status after 5 seconds
                    setTimeout(() => {
                        closeStatusViewerWA();
                    }, 5000);
                    
                } else if (status.type === 'image') {
                    const mediaUrl = status.mediaUrl || '';
                    contentDiv.innerHTML = `
                        <div class="relative w-full h-full flex items-center justify-center">
                            <img src="${mediaUrl}" class="max-w-full max-h-full object-contain" alt="Status" onerror="this.src='https://via.placeholder.com/600x800/1F2C34/FFFFFF?text=Image+Not+Available'">
                            ${statusContent ? `
                                <div class="absolute bottom-8 left-0 right-0 text-center px-4">
                                    <div class="bg-black bg-opacity-70 inline-block px-6 py-3 rounded-full max-w-2xl">
                                        <p class="text-white text-lg">${statusContent}</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                } else if (status.type === 'video') {
                    const mediaUrl = status.mediaUrl || '';
                    contentDiv.innerHTML = `
                        <div class="relative w-full h-full flex items-center justify-center">
                            <video src="${mediaUrl}" class="max-w-full max-h-full object-contain" controls autoplay>
                                Your browser does not support the video tag.
                            </video>
                            ${statusContent ? `
                                <div class="absolute bottom-20 left-0 right-0 text-center px-4">
                                    <div class="bg-black bg-opacity-70 inline-block px-6 py-3 rounded-full max-w-2xl">
                                        <p class="text-white text-lg">${statusContent}</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Render action buttons
                const isOwnStatus = status.userId === currentUser.userId;
                actionsDiv.innerHTML = '';
                
                if (isOwnStatus) {
                    actionsDiv.innerHTML = `
                        <button onclick="showStatusViewsWA('${status.statusId}')" class="hover:bg-gray-800 p-2 rounded text-white" title="View list">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="forwardStatusWA('${status.statusId}')" class="hover:bg-gray-800 p-2 rounded text-white" title="Forward">
                            <i class="fas fa-share"></i>
                        </button>
                        <button onclick="deleteStatusWA('${status.statusId}')" class="hover:bg-gray-800 p-2 rounded text-red-400" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                } else {
                    actionsDiv.innerHTML = `
                        <button onclick="replyToStatusWA('${status.statusId}')" class="flex items-center gap-2 hover:bg-gray-800 px-3 py-2 rounded text-white">
                            <i class="fas fa-reply"></i>
                            <span>Reply</span>
                        </button>
                        <button onclick="forwardStatusWA('${status.statusId}')" class="hover:bg-gray-800 p-2 rounded text-white" title="Forward">
                            <i class="fas fa-share"></i>
                        </button>
                    `;
                }
                
                // Start progress bar animation
                startStatusProgressWA();
                
                console.log('✅ Status viewer displayed successfully');
                
            } catch (error) {
                console.error('❌ Error showing status viewer:', error);
                alert('Error displaying status: ' + error.message);
            }
        }
        
        function startStatusProgressWA() {
            const progressBar = document.getElementById('status-progress-bar-wa');
            if (!progressBar) return;
            
            progressBar.style.width = '0%';
            progressBar.style.transition = 'none';
            
            setTimeout(() => {
                progressBar.style.transition = 'width 5s linear';
                progressBar.style.width = '100%';
            }, 50);
        }
        
        function closeStatusViewerWA() {
            const viewer = document.getElementById('status-viewer-wa');
            if (viewer) {
                viewer.classList.add('hidden');
                
                // Reset progress bar
                const progressBar = document.getElementById('status-progress-bar-wa');
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.style.transition = 'none';
                }
            }
        }
        
        function updateStatusInStorageWA(status) {
            const statuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
            const index = statuses.findIndex(s => s.statusId === status.statusId);
            if (index !== -1) {
                statuses[index] = status;
                localStorage.setItem('nagori_adda_statuses', JSON.stringify(statuses));
            }
        }
        
        function showStatusViewsWA(statusId) {
            const statuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
            const status = statuses.find(s => s.statusId === statusId);
            if (!status) return;
            
            const viewCount = status.views.length;
            if (viewCount === 0) {
                alert('No views yet');
            } else {
                alert(`${viewCount} view(s)\n\nView tracking is active!`);
            }
        }
        
        function forwardStatusWA(statusId) {
            const statuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
            const status = statuses.find(s => s.statusId === statusId);
            if (!status) return;
            
            const statusType = status.type === 'text' ? 'text' : status.type === 'image' ? 'image' : 'video';
            alert(`Forward ${statusType} status feature\n\nThis would open a contact picker to forward the status.`);
        }
        
        function deleteStatusWA(statusId) {
            if (confirm('Are you sure you want to delete this status?')) {
                const statuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
                const filteredStatuses = statuses.filter(s => s.statusId !== statusId);
                localStorage.setItem('nagori_adda_statuses', JSON.stringify(filteredStatuses));
                
                closeStatusViewerWA();
                loadStatusUpdatesWA();
                
                alert('✅ Status deleted successfully!');
            }
        }
        
        function replyToStatusWA(statusId) {
            const reply = prompt('Reply to status:');
            if (reply) {
                alert('✅ Reply sent: ' + reply);
                closeStatusViewerWA();
            }
        }
        
        function openAddStatusModalWA() {
            const modal = document.createElement('div');
            modal.id = 'add-status-modal-wa';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
            modal.innerHTML = `
                <div class="flex items-center justify-center h-full p-4">
                    <div class="bg-whatsapp-dark rounded-lg w-full max-w-md">
                        <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Add Status</h3>
                            <button onclick="closeAddStatusModalWA()" class="hover:bg-gray-700 p-1 rounded">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-4">
                            <div class="mb-4">
                                <button onclick="addTextStatusWA(); closeAddStatusModalWA();" class="w-full bg-whatsapp-light hover:bg-whatsapp-dark p-4 rounded-lg mb-2 flex items-center gap-3">
                                    <i class="fas fa-font text-xl"></i>
                                    <span>Text Status</span>
                                </button>
                                <button onclick="addImageStatusWA(); closeAddStatusModalWA();" class="w-full bg-whatsapp-light hover:bg-whatsapp-dark p-4 rounded-lg mb-2 flex items-center gap-3">
                                    <i class="fas fa-image text-xl"></i>
                                    <span>Photo Status</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeAddStatusModalWA() {
            const modal = document.getElementById('add-status-modal-wa');
            if (modal) {
                modal.remove();
            }
        }
        
        function addTextStatusWA() {
            try {
                const statusText = prompt('Enter your status text:');
                if (!statusText || statusText.trim() === '') {
                    console.log('⚠️ Status creation cancelled');
                    return;
                }
                
                const now = Date.now();
                const status = {
                    statusId: 'status_' + now,
                    userId: currentUser.userId,
                    userName: currentUser.name,
                    userPhoto: currentUser.profilePhoto || generateAvatarDataURL(currentUser.name || 'User', 60),
                    type: 'text',
                    content: statusText.trim(),
                    timestamp: now,
                    views: [],
                    expiresAt: now + (24 * 60 * 60 * 1000) // 24 hours
                };
                
                // Store status
                const statuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
                statuses.push(status);
                localStorage.setItem('nagori_adda_statuses', JSON.stringify(statuses));
                
                // Refresh status list
                loadStatusUpdatesWA();
                
                console.log('✅ Text status created:', status.statusId);
                alert('✅ Status published successfully!');
                
            } catch (error) {
                console.error('❌ Error creating text status:', error);
                alert('Error creating status: ' + error.message);
            }
        }
        
        function addImageStatusWA() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    showMediaStatusModalWA(file);
                }
            };
            input.click();
        }
        
        function showMediaStatusModalWA(file) {
            const modal = document.createElement('div');
            modal.id = 'media-status-modal-wa';
            modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50';
            
            const isVideo = file.type.startsWith('video/');
            const mediaUrl = URL.createObjectURL(file);
            
            modal.innerHTML = `
                <div class="h-full flex flex-col">
                    <!-- Header -->
                    <div class="p-4 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-white">Add Status</h3>
                        <button onclick="closeMediaStatusModalWA()" class="hover:bg-gray-800 p-2 rounded-full text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Media Preview -->
                    <div class="flex-1 flex items-center justify-center p-4">
                        ${isVideo ? 
                            `<video id="status-media-preview-wa" src="${mediaUrl}" class="max-w-full max-h-full object-contain rounded-lg" controls autoplay loop></video>` :
                            `<img id="status-media-preview-wa" src="${mediaUrl}" class="max-w-full max-h-full object-contain rounded-lg" alt="Status Preview">`
                        }
                    </div>
                    
                    <!-- Caption Input -->
                    <div class="p-4 bg-whatsapp-dark">
                        <textarea id="status-caption-wa" placeholder="Add a caption (optional)..." 
                                  class="w-full bg-whatsapp-light text-white px-4 py-3 rounded-lg h-20 resize-none outline-none mb-3"
                                  maxlength="200"></textarea>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">
                                <span id="caption-counter-wa">0</span>/200 characters
                            </span>
                            <button onclick="publishMediaStatusWA('${mediaUrl}', '${isVideo ? 'video' : 'image'}')" 
                                    class="whatsapp-green hover:bg-green-600 px-6 py-2 rounded-lg font-semibold">
                                <i class="fas fa-paper-plane mr-2"></i>Publish
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Character counter
            const textarea = document.getElementById('status-caption-wa');
            const counter = document.getElementById('caption-counter-wa');
            textarea.addEventListener('input', () => {
                counter.textContent = textarea.value.length;
            });
            
            // Focus on textarea
            textarea.focus();
        }
        
        function closeMediaStatusModalWA() {
            const modal = document.getElementById('media-status-modal-wa');
            if (modal) {
                modal.remove();
            }
        }
        
        function publishMediaStatusWA(mediaUrl, mediaType) {
            try {
                if (!mediaUrl || !mediaType) {
                    console.error('❌ Missing media URL or type');
                    return;
                }
                
                const captionInput = document.getElementById('status-caption-wa');
                const caption = captionInput ? captionInput.value.trim() : '';
                
                const now = Date.now();
                const status = {
                    statusId: 'status_' + now,
                    userId: currentUser.userId,
                    userName: currentUser.name,
                    userPhoto: currentUser.profilePhoto || generateAvatarDataURL(currentUser.name || 'User', 60),
                    type: mediaType,
                    content: caption,
                    mediaUrl: mediaUrl,
                    timestamp: now,
                    views: [],
                    expiresAt: now + (24 * 60 * 60 * 1000) // 24 hours
                };
                
                // Store status
                const statuses = JSON.parse(localStorage.getItem('nagori_adda_statuses') || '[]');
                statuses.push(status);
                localStorage.setItem('nagori_adda_statuses', JSON.stringify(statuses));
                
                // Close modal
                closeMediaStatusModalWA();
                
                // Refresh status list
                loadStatusUpdatesWA();
                
                console.log('✅ Media status created:', status.statusId, 'Type:', mediaType);
                alert('✅ ' + (mediaType === 'video' ? 'Video' : 'Image') + ' status published successfully!');
                
            } catch (error) {
                console.error('❌ Error publishing media status:', error);
                alert('Error publishing status: ' + error.message);
            }
        }
        
        window.loadWhatsAppChat = loadWhatsAppChat;
        window.closeWhatsAppChat = closeWhatsAppChat;
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-600 mb-2">🏛️ Nagori Adda</h1>
                <p class="text-gray-600">Community Management</p>
                <p class="text-sm text-gray-500 mt-2">Admin Login</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Mobile Number</label>
                    <div class="flex">
                        <span class="px-3 py-3 border border-r-0 bg-gray-50 rounded-l-lg text-gray-600">+91</span>
                        <input type="tel" id="login-mobile" required maxlength="10" placeholder="Enter mobile number"
                               class="flex-1 px-4 py-3 border-2 rounded-r-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-lg">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="login-password" required placeholder="Enter admin password"
                               class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none pr-12 text-lg">
                        <button type="button" onclick="togglePasswordVisibility()" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-2xl text-gray-500 hover:text-gray-700">
                            <span id="password-toggle-icon">👁️</span>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold text-lg transition-all">
                    🔐 Secure Login
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600 text-sm mb-2">Don't have an account?</p>
                <button onclick="showRegistrationScreen()" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">
                    📝 Register Now
                </button>
            </div>
        </div>
    </div>

    <!-- Registration Screen -->
    <div id="registration-screen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-blue-600 mb-2">📝 New Registration</h1>
                <p class="text-gray-600">Join Nagori Adda Community</p>
            </div>
            
            <form id="registration-form" onsubmit="handleRegistration(event); return false;" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">First Name *</label>
                    <input type="text" id="reg-firstname" required placeholder="Enter first name"
                           class="w-full px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Last Name *</label>
                    <input type="text" id="reg-lastname" required placeholder="Enter last name"
                           class="w-full px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Cast *</label>
                    <select id="reg-cast" required onchange="updateRegSubCastOptions()"
                            class="w-full px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">Select Cast</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Sub-cast *</label>
                    <select id="reg-subcast" required
                            class="w-full px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">Select Sub-cast</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Mobile Number *</label>
                    <div class="flex">
                        <span class="px-3 py-2 border-2 border-r-0 bg-gray-50 rounded-l-lg text-gray-600">+91</span>
                        <input type="tel" id="reg-mobile" required maxlength="10" placeholder="Enter 10-digit mobile"
                               class="flex-1 px-4 py-2 border-2 rounded-r-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">OTP will be sent to this number</p>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold transition-all">
                    📤 Submit Registration
                </button>
            </form>
            
            <div class="mt-4 text-center">
                <button onclick="showLoginScreen()" class="text-blue-600 hover:text-blue-700 text-sm">
                    ← Back to Login
                </button>
            </div>
        </div>
    </div>

    <!-- OTP Verification Screen -->
    <div id="otp-screen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-blue-600 mb-2">📱 Verify Mobile</h1>
                <p class="text-gray-600">Enter OTP sent to</p>
                <p id="otp-mobile-display" class="text-lg font-semibold text-gray-800 mt-1"></p>
            </div>
            
            <div class="mb-6">
                <div class="flex justify-center gap-2 mb-4">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl font-bold border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="moveToNext(this, 0)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl font-bold border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="moveToNext(this, 1)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl font-bold border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="moveToNext(this, 2)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl font-bold border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="moveToNext(this, 3)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl font-bold border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="moveToNext(this, 4)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl font-bold border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="moveToNext(this, 5)">
                </div>
                
                <div id="demo-otp-section" class="text-center text-sm bg-yellow-50 border border-yellow-200 rounded p-2 mb-4">
                    <span class="font-semibold">Demo OTP:</span> <span id="demo-otp-value" class="font-mono text-lg"></span>
                    <p class="text-xs text-gray-600 mt-1">This is shown only in demo mode</p>
                </div>
            </div>
            
            <button onclick="verifyOTPSubmit()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold mb-3">
                ✅ Verify OTP
            </button>
            
            <button onclick="resendOTP()" id="resend-otp-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 text-sm" disabled>
                🔄 Resend OTP (<span id="resend-timer">60</span>s)
            </button>
            
            <!-- reCAPTCHA Container for Firebase Phone Auth -->
            <div id="recaptcha-container"></div>
        </div>
    </div>

    <!-- Password Creation Screen -->
    <div id="password-creation-screen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-blue-600 mb-2">🔐 Create Password</h1>
                <p class="text-gray-600">Secure your account</p>
            </div>
            
            <form id="password-creation-form" onsubmit="handlePasswordCreation(event); return false;" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">New Password *</label>
                    <div class="relative">
                        <input type="password" id="new-password" required placeholder="Enter password"
                               oninput="checkPasswordStrength()"
                               class="w-full px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none pr-10">
                        <button type="button" onclick="togglePasswordField('new-password')" 
                                class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500">
                            👁️
                        </button>
                    </div>
                    <div id="password-strength" class="mt-2"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Confirm Password *</label>
                    <div class="relative">
                        <input type="password" id="confirm-password" required placeholder="Re-enter password"
                               oninput="checkPasswordMatch()"
                               class="w-full px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none pr-10">
                        <button type="button" onclick="togglePasswordField('confirm-password')" 
                                class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500">
                            👁️
                        </button>
                    </div>
                    <p id="password-match-msg" class="text-sm mt-1"></p>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                    <p class="text-sm font-medium text-blue-900 mb-2">Password must have:</p>
                    <ul class="text-xs text-blue-800 space-y-1">
                        <li id="req-length" class="flex items-center gap-2">
                            <span class="req-icon">⭕</span> At least 8 characters
                        </li>
                        <li id="req-upper" class="flex items-center gap-2">
                            <span class="req-icon">⭕</span> 1 uppercase letter (A-Z)
                        </li>
                        <li id="req-number" class="flex items-center gap-2">
                            <span class="req-icon">⭕</span> 1 number (0-9)
                        </li>
                        <li id="req-special" class="flex items-center gap-2">
                            <span class="req-icon">⭕</span> 1 special character (!@#$%^&*)
                        </li>
                    </ul>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                    💾 Save Password & Complete Registration
                </button>
            </form>
        </div>
    </div>

    <!-- Waiting for Verification Screen -->
    <div id="waiting-screen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md text-center">
            <div class="mb-6">
                <div class="inline-block p-4 bg-yellow-100 rounded-full mb-4">
                    <svg class="w-16 h-16 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">⏳ Pending Verification</h1>
                <p class="text-gray-600 mb-4">Your registration is under review</p>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-900">
                    Thank you for registering with Nagori Adda! Your account is pending admin approval. 
                    You'll be notified once your account is verified.
                </p>
            </div>
            
            <button onclick="showLoginScreen()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                🔙 Back to Login
            </button>
        </div>
    </div>

    <!-- Profile Screen -->
    <div id="profile-screen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-center">Complete Profile</h2>
            
            <form id="profile-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Name *</label>
                    <input type="text" id="profile-name" required class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Email *</label>
                    <input type="email" id="profile-email" required class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Gender *</label>
                    <select id="profile-gender" required class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Photo URL</label>
                    <input type="url" id="profile-photo" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Age</label>
                        <input type="number" id="profile-age" min="1" max="120" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Blood Group</label>
                        <select id="profile-blood-group" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Select</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Cast</label>
                    <select id="profile-cast" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">Select</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Sub-cast</label>
                    <select id="profile-sub-cast" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">First select cast</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Profession</label>
                    <input type="text" id="profile-professional" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">
                    Save Profile
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboard-screen" class="min-h-screen p-4 hidden">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold">🏛️ Nagori Adda</h1>
                        <p id="dashboard-user-name" class="text-gray-600">User</p>
                        <p id="dashboard-user-email" class="text-sm text-gray-500">email</p>
                        <span id="dashboard-status-badge" class="inline-block mt-2"></span>
                    </div>
                    <button id="logout-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
            
            <div class="grid md:grid-cols-3 gap-6">
                <button id="dashboard-chat-btn" class="bg-blue-600 text-white p-8 rounded-lg shadow-lg hover:bg-blue-700 transform hover:scale-105 transition">
                    <i class="fas fa-comments text-5xl mb-4"></i>
                    <h2 class="text-2xl font-bold">Chat</h2>
                    <p class="mt-2">Messages</p>
                </button>
                
                <button id="dashboard-familytree-btn" class="bg-green-600 text-white p-8 rounded-lg shadow-lg hover:bg-green-700 transform hover:scale-105 transition">
                    <i class="fas fa-sitemap text-5xl mb-4"></i>
                    <h2 class="text-2xl font-bold">Family Tree</h2>
                    <p class="mt-2">Genealogy</p>
                </button>
                
                <button id="admin-mode-btn" class="bg-purple-600 text-white p-8 rounded-lg shadow-lg hover:bg-purple-700 transform hover:scale-105 transition hidden">
                    <i class="fas fa-user-shield text-5xl mb-4"></i>
                    <h2 class="text-2xl font-bold">Admin Mode</h2>
                    <p class="mt-2">Management</p>
                </button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Style Chat Screen -->
    <div id="whatsapp-chat-container" class="h-screen flex-col hidden whatsapp-bg text-white fixed inset-0 z-50">
        <!-- WhatsApp Chat content will be loaded here -->
    </div>

    <!-- Family Tree Screen -->
    <div id="familytree-screen" class="min-h-screen hidden">
        <div class="bg-green-600 text-white p-4 sticky top-0 z-50 shadow-md no-print">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-4">
                        <button onclick="showDashboard()" class="hover:bg-green-700 px-3 py-2 rounded">
                            <i class="fas fa-arrow-left mr-2"></i>Back
                        </button>
                        <div>
                            <h1 class="text-xl font-bold">🏛️ Nagori Society</h1>
                            <div class="text-sm flex items-center gap-2">
                                <span>Total Members:</span>
                                <span id="member-counter" class="font-mono text-lg font-bold bg-white text-green-600 px-3 py-1 rounded">0000000</span>
                            </div>
                        </div>
                    </div>
                    <input type="text" id="family-search" placeholder="Search members..." 
                           onkeyup="searchFamilyMembers()"
                           class="px-4 py-2 rounded-full text-gray-800 w-64 outline-none">
                </div>
                
                <div class="flex gap-4 items-center">
                    <div class="flex items-center gap-2">
                        <label class="text-sm">Cast:</label>
                        <select id="tree-cast-filter" onchange="updateTreeSubCastFilter()" class="px-3 py-1 rounded text-gray-800 text-sm">
                            <option value="">Select Cast</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm">Sub-cast:</label>
                        <select id="tree-subcast-filter" onchange="renderFamilyTree()" class="px-3 py-1 rounded text-gray-800 text-sm">
                            <option value="">Select Sub-cast</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Marriage Navigation Breadcrumb -->
        <div id="marriage-navigation" class="hidden mx-4 mt-4">
            <div class="breadcrumb">
                <button onclick="goBackToOriginalFamily()">
                    <i class="fas fa-arrow-left mr-2"></i><span id="back-text">Back to Original Family</span>
                </button>
                <span class="current-view" id="current-view-text">
                    Viewing Current Family
                </span>
            </div>
        </div>
        
        <div id="familytree-container" class="p-4" style="position: relative;">
            <svg id="tree-lines-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;">
            </svg>
            <div id="tree-content" style="position: relative; z-index: 1;"></div>
        </div>
        
        <!-- Floating Toolbar -->
        <div class="tree-toolbar no-print">
            <div class="toolbar-btn" onclick="printFamilyTree()" title="Print Tree">
                <i class="fas fa-print"></i>
            </div>
            <div class="toolbar-btn" onclick="renderFamilyTree()" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </div>
            <div class="toolbar-btn" onclick="showAddRelativeModal()" title="Add Member">
                <i class="fas fa-plus"></i>
            </div>
        </div>
    </div>

    <!-- Admin Panel Screen -->
    <div id="admin-screen" class="min-h-screen p-4 hidden">
        <div class="max-w-6xl mx-auto">
            <div class="bg-purple-600 text-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">👨‍💼 Admin Panel</h1>
                    <button onclick="exitAdminMode()" class="bg-white text-purple-600 px-4 py-2 rounded-md hover:bg-gray-100">
                        <i class="fas fa-arrow-left mr-2"></i>Exit Admin Mode
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2 mb-6 flex-wrap">
                <button onclick="showAdminTab('casts')" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">
                    🏛️ Cast Management
                </button>
                <button onclick="showAdminTab('users')" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">
                    👥 User Management
                </button>
                <button onclick="showAdminTab('profile')" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">
                    👤 Admin Profile
                </button>
                <button onclick="showAdminTab('backup')" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">
                    💾 Backup & Restore
                </button>
            </div>
            
            <div id="admin-tab-casts" class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Cast/Sub-Cast Management</h2>
                <div id="casts-list"></div>
            </div>
            
            <div id="admin-tab-users" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <h2 class="text-xl font-bold mb-4">User Management</h2>
                <div id="users-list"></div>
            </div>
            
            <div id="admin-tab-profile" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <h2 class="text-xl font-bold mb-4">Admin Profile</h2>
                <form id="admin-profile-form" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Name *</label>
                            <input type="text" id="admin-profile-name" required class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email *</label>
                            <input type="email" id="admin-profile-email" required class="w-full px-3 py-2 border rounded-md">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Photo URL</label>
                        <input type="url" id="admin-profile-photo" class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Age</label>
                            <input type="number" id="admin-profile-age" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Blood Group</label>
                            <select id="admin-profile-blood-group" class="w-full px-3 py-2 border rounded-md">
                                <option value="">Select</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cast</label>
                        <select id="admin-profile-cast" class="w-full px-3 py-2 border rounded-md">
                            <option value="">Select</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Sub-cast</label>
                        <select id="admin-profile-sub-cast" class="w-full px-3 py-2 border rounded-md">
                            <option value="">Select</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Profession</label>
                        <input type="text" id="admin-profile-professional" class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700">
                        <i class="fas fa-save mr-2"></i>Update Profile
                    </button>
                </form>
            </div>
            
            <div id="admin-tab-backup" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <h2 class="text-xl font-bold mb-4">💾 Data Backup & Restore</h2>
                
                <div class="space-y-6">
                    <!-- Firestore Backup Section -->
                    <div class="border border-gray-300 rounded-lg p-6 bg-gradient-to-br from-blue-50 to-purple-50">
                        <div class="flex items-center gap-3 mb-4">
                            <i class="fas fa-cloud-upload-alt text-3xl text-blue-600"></i>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Firestore Cloud Backup</h3>
                                <p class="text-sm text-gray-600">सारा text data (users, messages, casts) Firebase में backup करें</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="handleBackupClick()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Backup to Firestore</span>
                            </button>
                            
                            <button onclick="handleRestoreClick()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-cloud-download-alt"></i>
                                <span>Restore from Firestore</span>
                            </button>
                        </div>
                        
                        <div id="backup-status" class="mt-4 text-sm text-gray-600 hidden"></div>
                    </div>
                    
                    <!-- R2 Media Storage Info -->
                    <div class="border border-gray-300 rounded-lg p-6 bg-gradient-to-br from-purple-50 to-pink-50">
                        <div class="flex items-center gap-3 mb-4">
                            <i class="fas fa-photo-video text-3xl text-purple-600"></i>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Cloudflare R2 Media Storage</h3>
                                <p class="text-sm text-gray-600">Profile photos और message attachments automatically R2 में save होते हैं</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Worker URL:</span>
                                <span class="font-mono text-xs text-blue-600">r2-presig.theskynetcafe.workers.dev</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span class="text-green-600 font-semibold">✅ Active</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Max File Size:</span>
                                <span class="font-semibold">10 MB</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info Box -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-info-circle text-yellow-600 mt-1"></i>
                            <div class="text-sm text-gray-700">
                                <p class="font-semibold mb-1">ℹ️ Backup Strategy:</p>
                                <ul class="list-disc ml-4 space-y-1">
                                    <li><strong>Text Data:</strong> Firestore में backup होता है (users, messages, casts)</li>
                                    <li><strong>Media Files:</strong> Cloudflare R2 में store होते हैं (photos, videos)</li>
                                    <li><strong>Restore:</strong> Firestore से text data restore करने पर page reload होगा</li>
                                    <li><strong>Safe:</strong> Backup करने से existing data replace नहीं होगा</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Options Modal -->
    <div id="member-options-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeMemberOptions()">
        <div class="modal-content p-6">
            <div class="text-center">
                <div class="member-avatar mx-auto mb-4" style="width: 100px; height: 100px;">
                    <img id="member-options-photo" src="" alt="" class="hidden">
                    <div id="member-options-initials" class="flex items-center justify-center h-full text-4xl font-bold text-white bg-gradient-to-br from-blue-400 to-purple-500 rounded-full"></div>
                </div>
                <h3 id="member-options-name" class="text-xl font-bold mb-4">Member Name</h3>
                
                <div class="space-y-3">
                    <button id="edit-member-btn" onclick="editMember()" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <i class="fas fa-edit"></i>
                        <span>Edit</span>
                    </button>
                    
                    <button onclick="showAddRelativeModal()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                        <i class="fas fa-user-plus"></i>
                        <span>Add Relative</span>
                    </button>
                    
                    <button id="delete-member-btn" onclick="deleteMemberFromTree()" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 flex items-center justify-center gap-2 hidden">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </button>
                </div>
                
                <button onclick="closeMemberOptions()" class="mt-4 text-gray-600 hover:text-gray-800">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Select Relation Modal -->
    <div id="select-relation-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeSelectRelation()">
        <div class="modal-content">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">Select Relation</h2>
                <button onclick="closeSelectRelation()" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="relation-grid">
                <div class="relation-card" onclick="selectRelation('father')">
                    <div class="relation-icon male">
                        <i class="fas fa-male text-blue-600"></i>
                    </div>
                    <span class="font-semibold">Father</span>
                </div>
                
                <div class="relation-card" onclick="selectRelation('mother')">
                    <div class="relation-icon female">
                        <i class="fas fa-female text-pink-600"></i>
                    </div>
                    <span class="font-semibold">Mother</span>
                </div>
                
                <div class="relation-card" onclick="selectRelation('husband')">
                    <div class="relation-icon male">
                        <i class="fas fa-user-tie text-blue-600"></i>
                    </div>
                    <span class="font-semibold">Husband</span>
                </div>
                
                <div class="relation-card" onclick="selectRelation('wife')">
                    <div class="relation-icon female">
                        <i class="fas fa-female text-pink-600"></i>
                    </div>
                    <span class="font-semibold">Wife</span>
                </div>
                
                <div class="relation-card" onclick="selectRelation('brother')">
                    <div class="relation-icon male">
                        <i class="fas fa-male text-blue-600"></i>
                    </div>
                    <span class="font-semibold">Brother</span>
                </div>
                
                <div class="relation-card" onclick="selectRelation('sister')">
                    <div class="relation-icon female">
                        <i class="fas fa-female text-pink-600"></i>
                    </div>
                    <span class="font-semibold">Sister</span>
                </div>
                
                <div class="relation-card" onclick="selectRelation('son')">
                    <div class="relation-icon male">
                        <i class="fas fa-child text-blue-600"></i>
                    </div>
                    <span class="font-semibold">Son</span>
                </div>
                
                <div class="relation-card" onclick="selectRelation('daughter')">
                    <div class="relation-icon female">
                        <i class="fas fa-child text-pink-600"></i>
                    </div>
                    <span class="font-semibold">Daughter</span>
                </div>
            </div>
            
            <div class="p-6 border-t flex justify-end gap-4">
                <button onclick="closeSelectRelation()" class="px-6 py-2 border rounded-md hover:bg-gray-100">
                    Cancel
                </button>
                <button onclick="proceedWithRelation()" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Add Member Form Modal -->
    <div id="add-member-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeAddMemberForm()">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Add Family Member</h2>
                <button onclick="closeAddMemberForm()" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="add-member-form" onsubmit="handleAddMemberSubmit(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">First Name *</label>
                        <input type="text" id="new-member-firstname" required class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Last Name *</label>
                        <input type="text" id="new-member-lastname" required class="w-full px-3 py-2 border rounded-md">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Nick Name</label>
                    <input type="text" id="new-member-nickname" class="w-full px-3 py-2 border rounded-md">
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="display-nickname" class="mr-2">
                    <label for="display-nickname" class="text-sm text-gray-700">Display Nick Name on Tree instead of Full Name</label>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Birth Year</label>
                    <input type="number" id="new-member-year" min="1900" max="2025" class="w-full px-3 py-2 border rounded-md">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Status *</label>
                    <select id="new-member-status" required class="w-full px-3 py-2 border rounded-md">
                        <option value="living">Living</option>
                        <option value="deceased">Deceased</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Date (Month/Year)</label>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="new-member-month" class="w-full px-3 py-2 border rounded-md">
                            <option value="">Month</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <input type="number" id="new-member-date-year" placeholder="Year" min="1900" max="2025" class="w-full px-3 py-2 border rounded-md">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Photo URL</label>
                    <input type="url" id="new-member-photo" class="w-full px-3 py-2 border rounded-md">
                </div>
                
                <!-- Marriage Information Section (Simplified with Code) -->
                <div class="border-t pt-4 mt-4">
                    <h3 class="text-lg font-semibold mb-3">💍 Marriage Information</h3>
                    
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="is-married-checkbox" onchange="toggleMarriageFields()" class="mr-2">
                        <label for="is-married-checkbox" class="text-sm font-medium">This person is married</label>
                    </div>
                    
                    <div id="marriage-fields" class="hidden space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Spouse Link Code *</label>
                            <input type="text" 
                                   id="spouse-link-code" 
                                   placeholder="Enter spouse code (e.g., AMH-1234567)"
                                   class="w-full px-3 py-2 border rounded-md uppercase"
                                   maxlength="11">
                            <small class="text-gray-500">Paste your spouse's member code here</small>
                        </div>
                        
                        <button type="button" onclick="verifySpouseCode()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Verify Code
                        </button>
                        
                        <div id="spouse-preview" class="hidden p-3 bg-green-50 border border-green-200 rounded-md">
                            <div class="text-green-800">
                                ✅ Spouse Found: <strong id="spouse-name"></strong>
                                <br>Cast: <span id="spouse-cast-info"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeAddMemberForm()" class="flex-1 px-4 py-2 border rounded-md hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Add Member
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="edit-member-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeEditMemberModal()">
        <div class="modal-content max-w-2xl p-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-xl font-bold">Edit Member</h2>
                <button onclick="closeEditMemberModal()" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="edit-member-form" onsubmit="handleEditMemberSubmit(event)" class="space-y-4">
                <input type="hidden" id="edit-member-id">
                
                <!-- Member Code Display (Read-only) -->
                <div class="bg-blue-50 p-3 rounded-md">
                    <label class="block text-sm font-medium mb-1">Member Code</label>
                    <div class="flex items-center gap-2">
                        <span id="edit-member-code" class="font-mono text-lg font-bold text-blue-700"></span>
                        <button type="button" onclick="copyEditMemberCode()" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <!-- Name Fields -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">First Name *</label>
                        <input type="text" id="edit-firstname" required class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Last Name *</label>
                        <input type="text" id="edit-lastname" required class="w-full px-3 py-2 border rounded-md">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Nick Name</label>
                    <input type="text" id="edit-nickname" class="w-full px-3 py-2 border rounded-md">
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="edit-display-nickname" class="mr-2">
                    <label for="edit-display-nickname" class="text-sm text-gray-700">Display Nick Name on Tree</label>
                </div>
                
                <!-- Birth Year -->
                <div>
                    <label class="block text-sm font-medium mb-1">Birth Year</label>
                    <input type="number" id="edit-birth-year" min="1900" max="2025" class="w-full px-3 py-2 border rounded-md">
                </div>
                
                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium mb-1">Status *</label>
                    <select id="edit-status" required class="w-full px-3 py-2 border rounded-md">
                        <option value="living">Living</option>
                        <option value="deceased">Deceased</option>
                    </select>
                </div>
                
                <!-- Date (Month/Year) -->
                <div>
                    <label class="block text-sm font-medium mb-1">Date (Month/Year)</label>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="edit-month" class="w-full px-3 py-2 border rounded-md">
                            <option value="">Month</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <input type="number" id="edit-date-year" placeholder="Year" min="1900" max="2025" class="w-full px-3 py-2 border rounded-md">
                    </div>
                </div>
                
                <!-- Photo URL -->
                <div>
                    <label class="block text-sm font-medium mb-1">Photo URL</label>
                    <input type="url" id="edit-photo" class="w-full px-3 py-2 border rounded-md">
                </div>
                
                <!-- Cast/Sub-cast (Admin Only) -->
                <div id="edit-cast-section" class="border-t pt-4">
                    <h3 class="font-semibold mb-3">Cast Information (Admin Only)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Cast</label>
                            <select id="edit-cast" class="w-full px-3 py-2 border rounded-md" onchange="updateEditSubCastOptions()">
                                <option value="">Select Cast</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Sub-cast</label>
                            <select id="edit-subcast" class="w-full px-3 py-2 border rounded-md">
                                <option value="">Select Sub-cast</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Marriage Info (Read-only display) -->
                <div id="edit-marriage-info" class="hidden border-t pt-4">
                    <h3 class="font-semibold mb-2">💍 Marriage Information</h3>
                    <div class="bg-pink-50 p-3 rounded-md">
                        <p class="text-sm"><strong>Married to:</strong> <span id="edit-spouse-name"></span></p>
                        <p class="text-sm"><strong>Spouse Cast:</strong> <span id="edit-spouse-cast"></span></p>
                        <p class="text-sm"><strong>Spouse Code:</strong> <span id="edit-spouse-code" class="font-mono"></span></p>
                    </div>
                </div>
                
                <!-- Spouse Link Code (For Female Members Only) -->
                <div id="edit-spouse-link-section" class="hidden border-t pt-4">
                    <h3 class="font-semibold mb-3">💑 Link Spouse (Female Members)</h3>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium mb-1">Spouse Link Code *</label>
                        <input type="text" id="edit-spouse-link-code" 
                               placeholder="ABC-1234567" 
                               maxlength="11"
                               class="w-full px-3 py-2 border rounded-md uppercase font-mono">
                        <button type="button" onclick="verifyEditSpouseCode()" 
                                class="text-sm text-blue-600 hover:underline">
                            <i class="fas fa-check-circle"></i> Verify Code
                        </button>
                        <div id="edit-spouse-preview" class="hidden mt-2 p-3 bg-green-50 border border-green-200 rounded-md">
                            <p class="text-sm text-green-800">
                                <i class="fas fa-check-circle"></i> <strong>Spouse Found:</strong> 
                                <span id="edit-spouse-name-preview" class="font-semibold"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Buttons -->
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeEditMemberModal()" class="flex-1 px-4 py-2 border rounded-md hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- WhatsApp Status Viewer (Permanent DOM Element) -->
    <div id="status-viewer-wa" class="status-viewer hidden">
        <div class="h-full flex flex-col">
            <!-- Status Progress Bar -->
            <div class="p-2">
                <div class="status-progress">
                    <div id="status-progress-bar-wa" class="status-progress-bar"></div>
                </div>
            </div>
            
            <!-- Status Header -->
            <div class="flex items-center justify-between p-4">
                <div class="flex items-center gap-3">
                    <img id="status-user-photo-wa-viewer" src="" alt="User" class="w-10 h-10 rounded-full">
                    <div>
                        <h3 id="status-user-name-wa-viewer" class="font-semibold text-white">User Name</h3>
                        <p id="status-time-wa-viewer" class="text-sm text-gray-400">2 minutes ago</p>
                    </div>
                </div>
                <button onclick="closeStatusViewerWA()" class="hover:bg-gray-800 p-2 rounded-full text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Status Content -->
            <div class="flex-1 flex items-center justify-center">
                <div id="status-content-wa-viewer" class="text-center w-full">
                    <!-- Status content will be displayed here -->
                </div>
            </div>
            
            <!-- Status Actions -->
            <div class="p-4">
                <div class="flex items-center justify-between">
                    <div class="text-gray-400 text-sm">
                        <i class="fas fa-eye mr-2"></i><span id="status-views-wa">0</span> views
                    </div>
                    <div class="flex items-center gap-4" id="status-actions-wa">
                        <!-- Actions will be dynamically added -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
